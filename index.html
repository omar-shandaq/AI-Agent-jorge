<!DOCTYPE html>
<!-- saved from url=(0038)https://riolite55.github.io/index.html -->
<html lang="en" style="--vh: 9.32px;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Executive Office</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Include Chart.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--For the voice agent-->
    <script src="voiceManager.js"></script>
    <style>
        /* HRSD Font Faces */
        @font-face {
            font-family: 'HRSD';
            src: local('HRSD-Regular');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'HRSD';
            src: local('HRSD-Light');
            font-weight: 300;
            font-style: normal;
        }

        @font-face {
            font-family: 'HRSD';
            src: local('HRSD-Medium');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'HRSD';
            src: local('HRSD-Bold');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'HRSD';
            src: local('HRSD-Thin');
            font-weight: 100;
            font-style: normal;
        }

        @font-face {
            font-family: 'HRSD-Title';
            src: local('HRSD-Title');
            font-weight: 700;
            font-style: normal;
        }

        h1,
        h2,
        h3,
        .topic-title,
        .tool-title,
        .modal-content h2,
        .single-agent-name,
        .agenda-header h2 {
            font-family: 'HRSD-Title', 'HRSD', sans-serif;
            font-weight: 700;
        }

        body,
        p,
        .content,
        .topic-description,
        .tool-description {
            font-family: 'HRSD', sans-serif;
            font-weight: 400;
        }

        .day-name,
        .event-time,
        .kpi-label,
        .agent-select-title,
        .single-agent-description {
            font-family: 'HRSD', sans-serif;
            font-weight: 300;
        }

        .nav-tabs button,
        .event-title,
        .agent-select-name,
        .meeting-title,
        button,
        .quick-action-btn {
            font-family: 'HRSD', sans-serif;
            font-weight: 500;
        }

        strong,
        .kpi-value,
        .day-number,
        .month-day-number {
            font-family: 'HRSD', sans-serif;
            font-weight: 700;
        }

        :root {
            --primary-orange: #F59620;
            --secondary-orange: #FAB414;
            --primary-green: #2DB473;
            --primary-teal: #148287;
            --primary-navy: #14415A;

            --primary-color: var(--primary-blue);
            --secondary-color: var(--primary-green);
            --accent-color: var(--primary-teal);
            --dark-bg: var(--primary-navy);

            --primary-blue: #00A99D;
            --dark-teal: #004F58;
            --text-light: #e0e0e0;
            --text-dark: #ffffff;
            --border-color: rgba(255, 255, 255, 0.2);
            --container-bg: rgba(20, 65, 90, 0.5);
            --container-bg-light: rgba(255, 255, 255, 0.08);

            --shadow-sm: 0 2px 8px rgba(243, 199, 144 0.1);
            --shadow-md: 0 4px 16px rgba(243, 199, 144, 0.2);
            --shadow-lg: 0 8px 32px rgba(243, 199, 144, 0.3);

            --vh: 1vh;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'HRSD', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-navy);
            color: var(--text-light);
            background-image: url('https://images.unsplash.com/photo-1550745165-9bc0b252726a?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%,
                    rgba(20, 65, 90, 0.1) 0%,
                    rgba(20, 65, 90, 0.8) 70%,
                    #14415A 100%);
            z-index: -1;
            pointer-events: none;
        }

        .header, .nav-tabs-container {
            background-color: transparent;
            backdrop-filter: blur(15px);
            position: sticky;
            z-index: 900;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            border-bottom: 1px solid var(--border-color);
            top: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            width: 55px;
            height: 45px;
            overflow: hidden;
        }

        .logo-container img {
            width: 200px;
        }

        .header-left span {
            font-weight: 500;
            font-size: 1.2rem;
        }

        .header-right .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-right .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-blue);
        }

        .header-right .user-profile span { font-weight: 500; }
        .header-right button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .header-right button:hover {
            color: var(--primary-blue);
        }

        .mobile-menu-btn { 
            display: none;
            color: var(--primary-blue);
        }
        .mobile-menu-btn i {
            color: var(--primary-blue);
        }

        .nav-tabs-container {
            display: flex;
            justify-content: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            top: 83px; /* Adjusted based on typical header height */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 25px;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .nav-tabs button i {
            color: var(--primary-blue);
        }

        .nav-tabs button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(243, 199, 144 0.2), transparent);
            transition: left 0.5s;
        }

        .nav-tabs button:hover::before {
            left: 100%;
        }

        #meetings-modal-title {
            color: var(--primary-blue);
            text-shadow: 0 2px 10px rgba(243, 199, 144 0.3);
        }

        .nav-tabs button.active {
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(243, 199, 144 0.4);
            border-color: rgba(0, 169, 157, 0.3);
        }
        .nav-tabs button.active i {
            color: var(--text-dark);
        }

        .nav-tabs button:hover:not(.active) {
            background-color: var(--container-bg-light);
            border-color: var(--border-color);
            transform: translateY(-2px);
        }
        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .page-content {
            display: none;
            flex-grow: 1;
            padding: 20px 40px;
            gap: 20px;
            min-height: 0;
            overflow: hidden;
        }
        .page-content.active {
            display: flex;
        }

        .chat-section-container {
            flex: 2;
            display: flex;
            /*gap: 20px;*/
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
			padding: 28px 0px 24px 20px; /* move content slightly up from bottom, closer to top */
			min-width: 0;
            min-height: 0;
            max-height: calc(100vh - 220px);
            box-shadow: var(--shadow-lg);
            overflow: visible; /* Allow dropdowns to overflow */
        }

        .persona-display {
            flex: 0 0 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            /*background: var(--container-bg);
            border: 1px solid var(--border-color);*/
            border-radius: 20px 0px 0px 20px;
            padding: 20px;
            /*box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);*/
            min-height: 0;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-gutter: stable;
            margin: 5px;
        }

        /* Removed old single persona image styles - now using multi-agent selection */
        
        .multi-agent-header {
            text-align: left;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Multi-Agent Selection Styles */
        .multi-agent-header {
            text-align: left;
        }
        
        .multi-agent-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mode-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 14px;
            margin: 0px 0 24px; /* lift status pill a bit higher, add breathing room above cards */
        }
        
        #modeStatusLabel {
            display: inline-block;
            padding: 8px 18px;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        .mode-status-single {
            background: rgba(0, 169, 157, 0.12);
            border: 2px solid var(--primary-blue);
            color: var(--primary-blue);
            box-shadow: 0 0 5px rgba(0, 169, 157, 0.25), 0 2px 8px rgba(0, 169, 157, 0.15);
        }
        .mode-status-multi {
            background: linear-gradient(135deg, rgba(245, 150, 32, 0.3) 0%, rgba(245, 150, 32, 0.15) 100%);
            border: 2px solid var(--primary-blue);
            color: var(--text-dark);
            box-shadow: 0 0 5px rgba(245, 150, 32, 0.2), 0 2px 8px rgba(245, 150, 32, 0.1);
        }
        
        /* Single Agent Mode Styles */
        .single-agent-display {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .single-agent-display.active {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .single-agent-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto;
            border: 4px solid var(--primary-blue);
            box-shadow: 0 8px 30px rgba(0, 169, 157, 0.4);
            object-fit: cover;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .single-agent-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(0, 169, 157, 0.6);
        }
        
        .single-agent-info {
            padding: 10px;
        }
        
        .single-agent-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        
        .single-agent-title {
            font-size: 0.9rem;
            color: var(--primary-blue);
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .single-agent-description {
            font-size: 0.85rem;
            line-height: 1.6;
            opacity: 0.9;
            padding: 0 10px;
        }
        
        /* Agent Selector Button in Chat */
        #agentSelectorBtn {
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.15), rgba(0, 169, 157, 0.25));
            border: 2px solid var(--primary-blue);
            color: var(--text-light);
            padding: 6px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 169, 157, 0.3);
            position: relative;
            width: 70px !important;
            min-width: 70px;
            flex-shrink: 0;
        }
        
        #agentSelectorBtn.active {
            display: flex;
        }
        
        #agentSelectorBtn:hover {
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.25), rgba(0, 169, 157, 0.35));
            border-color: #00bfae;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 169, 157, 0.4);
        }
        
        #agentSelectorBtn:active {
            transform: translateY(0);
        }
        
        #agentSelectorBtn img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--primary-blue);
            box-shadow: 0 2px 6px rgba(0, 169, 157, 0.3);
        }
        
        #agentSelectorBtn span {
            display: none; /* Hide name, only show avatar */
        }
        
        #agentSelectorBtn i {
            color: var(--primary-blue);
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        /* Agent Selection List - hide in single mode */
        .multi-agent-content {
            display: block;
        }
        
        .multi-agent-content.hidden {
            display: none;
        }
        
        .agent-selection-list {
            display: flex !important;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-height: 0;
            padding: 5px 0;
            width: calc(100% - 6px);
            
        }
        
        .agent-selection-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .agent-selection-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .agent-selection-list::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
        }
        
        .persona-display::-webkit-scrollbar {
            width: 6px;
        }

        .persona-display::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .persona-display::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
        }
        
        .agent-select-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--container-bg-light);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-sizing: border-box;
            max-width: calc(100% - 8px);
            width: 100%;
        }
        
        .agent-select-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.1), rgba(0, 169, 157, 0.2));
            border-radius: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .agent-select-item:hover::before {
            opacity: 1;
        }
        
        .agent-select-item:hover {
            border-color: rgba(0, 169, 157, 0.3);
            transform: translateX(2px);
            max-width: calc(100% - 3px);
        }
        
        .agent-select-item.selected {
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.2), rgba(0, 169, 157, 0.3));
            border-color: var(--primary-blue);
            box-shadow: 0 0 20px rgba(0, 169, 157, 0.4), inset 0 0 20px rgba(0, 169, 157, 0.1);
            animation: agentSelected 0.4s ease;
        }
        
        .agent-select-item.selected .agent-mini-avatar {
            border-color: var(--primary-blue);
            box-shadow: 0 0 15px rgba(0, 169, 157, 0.5);
        }
        
        .agent-select-item.selected .agent-select-name {
            color: var(--primary-blue);
        }
        
        .agent-info-btn {
            position: flex;
            top: 10px;
            right: 10px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid var(--primary-blue);
            background: rgba(0, 169, 157, 0.08);
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 2;
        }
        .agent-info-btn i {
            pointer-events: none;
            color: var(--primary-blue);
        }
        .agent-info-btn:hover {
            background: var(--primary-blue);
            color: var(--text-dark);
            border-color: var(--primary-blue);
            transform: scale(1.1);
        }
        .agent-info-btn:hover i {
            color: var(--text-dark);
        }
        
        .agent-info-modal-body {
            text-align: center;
            padding: 10px 0 0;
        }
        .agent-info-modal-body img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-blue);
            box-shadow: 0 6px 20px rgba(0, 169, 157, 0.4);
            margin-bottom: 15px;
        }
        .agent-info-modal-body h3 {
            margin: 0 0 8px 0;
            color: var(--primary-blue);
        }
        .agent-info-modal-body p {
            margin: 4px 0;
        }
        
        @keyframes agentSelected {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        
        .agent-checkbox {
            display: none; /* Hide the actual checkbox */
        }
        
        /* Toggle Switch */
        .agent-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            margin-right: 12px;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .agent-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 34px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .agent-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .agent-checkbox:checked + .agent-toggle .agent-toggle-slider {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            border-color: var(--primary-blue);
            box-shadow: 0 0 10px rgba(0, 169, 157, 0.5), inset 0 1px 3px rgba(255, 255, 255, 0.3);
        }
        
        .agent-checkbox:checked + .agent-toggle .agent-toggle-slider:before {
            transform: translateX(24px);
            box-shadow: 0 2px 8px rgba(0, 169, 157, 0.4);
        }
        
        .agent-toggle-slider:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .agent-checkbox:checked + .agent-toggle .agent-toggle-slider:hover {
            background: linear-gradient(135deg, #00bfae, #00a99d);
            box-shadow: 0 0 15px rgba(0, 169, 157, 0.7), inset 0 1px 3px rgba(255, 255, 255, 0.3);
        }
        
        /* Active state when clicking */
        .agent-toggle:active .agent-toggle-slider:before {
            width: 22px;
        }
        
        .agent-mini-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid var(--border-color);
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .agent-select-info {
            flex: 1;
            text-align: left;
            min-width: 0;
        }
        
        .agent-select-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .agent-select-title {
            font-size: 0.72rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .multi-agent-badge {
            display: inline-block;
            background: var(--primary-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .agent-name-tag {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-blue);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .copy-message-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0.5;
            transition: all 0.2s;
        }
        
        .copy-message-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary-blue);
        }
        
        .copy-message-btn.copied {
            color: #10b981;
            opacity: 1;
            margin-bottom: 5px;
            display: block;
        }
        
        .agent-discussion-indicator {
            background: linear-gradient(90deg, rgba(0, 169, 157, 0.2), rgba(0, 169, 157, 0.05));
            border-left: 3px solid var(--primary-blue);
            padding: 10px 15px;
            margin: 12px 0;
            border-radius: 8px;
            font-style: italic;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .quick-actions h4 {
            margin: 0 0 8px 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            opacity: 0.7;
            font-weight: 600;
            text-align: center;
            color: var(--text-light);
        }

        .quick-action-btn {
            background: var(--container-bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-align: left;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .quick-action-btn:hover {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4);
            border-color: transparent;
        }

        .quick-action-btn i {
            font-size: 1rem;
            width: 18px;
            text-align: center;
            flex-shrink: 0;
            opacity: 0.9;
        }

        .quick-action-btn:hover i {
            opacity: 1;
        }

        .quick-action-btn span {
            flex: 1;
        }

        .chat-interaction-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-width: 0; 
            min-height: 0;
            overflow: hidden;
        }

        .chat-interaction-area .section-control-btn {
            position: absolute !important;
            top: 20px !important;
            right: 40px !important;
            z-index: 200 !important;
        }

        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding-right: 10px; 
            min-height: 0;
        }
        
        /* Custom scrollbar styling for chat messages */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #008a7e;
        }

        .message-bubble {
            display: flex;
            /*gap: 15px;*/
            margin-bottom: 20px;
            align-items: flex-start;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble.user { 
            justify-content: flex-end;
        }
        .message-bubble .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
			padding: 15px;

        }
        .message-bubble .content {
            padding: 14px 20px;
            border-radius: 18px;
            max-width: 80%;
            font-size: 0.95rem;
            line-height: 1.7;
            border: 1px solid transparent;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }
        .message-bubble.user .content {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: #fff;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.agent .content {
            background-color: rgba(0, 0, 0, 0.25);
            border-color: var(--border-color);
            color: var(--text-light);
            border-bottom-left-radius: 5px;
            backdrop-filter: blur(10px);
        }
        /* Style for canvas container */
        .message-bubble.agent .content .chart-container {
             width: 100%;
             max-width: 450px; /* Adjust max width as needed */
             margin-top: 15px;
             background-color: rgba(255, 255, 255, 0.05); /* Slightly lighter background */
             padding: 15px;
             border-radius: 8px;
             border: 1px solid var(--border-color);
        }
         .message-bubble.agent .content canvas {
             max-width: 100%;
             height: auto;
         }

        /* Styles for rendered Markdown in agent bubbles */
        .message-bubble.agent .content h1,
        .message-bubble.agent .content h2,
        .message-bubble.agent .content h3 {
            color: var(--primary-blue);
            margin-top: 1em;
            margin-bottom: 0.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }
        .message-bubble.agent .content h4 { color: var(--text-dark); margin-top: 1em; margin-bottom: 0.5em; }
        .message-bubble.agent .content p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .message-bubble.agent .content ul, .message-bubble.agent .content ol { padding-left: 20px; margin: 0.5em 0; }
        .message-bubble.agent .content li { margin-bottom: 0.5em; }
        .message-bubble.agent .content hr { border: none; border-top: 1px solid var(--border-color); margin: 1em 0; }
        .message-bubble.agent .content strong { color: var(--text-dark); }
        .message-bubble.agent .content code {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }
        .message-bubble.agent .content pre {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
        }
        .message-bubble.agent .content pre code {
            background-color: transparent;
            padding: 0;
        }
        .message-bubble.agent .content a {
            color: var(--primary-teal);
            text-decoration: none;
            font-weight: 500;
        }
        .message-bubble.agent .content a:hover {
            text-decoration: underline;
        }
        .message-bubble.agent .content blockquote {
            border-left: 4px solid var(--primary-blue);
            padding-left: 15px;
            margin-left: 0;
            font-style: italic;
            color: var(--text-light);
            opacity: 0.9;
        }
         /* Markdown table styling */
        .message-bubble.agent .content table {
            width: auto; /* Allow table to fit content */
            max-width: 100%; /* Prevent overflow */
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.9em;
            background-color: rgba(0,0,0,0.1);
        }
        .message-bubble.agent .content th,
        .message-bubble.agent .content td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }
        .message-bubble.agent .content th {
            background-color: rgba(45, 180, 115, 0.2);
            color: var(--text-dark);
            font-weight: 600;
        }
        .message-bubble.agent .content tr:nth-child(even) {
            background-color: rgba(255,255,255,0.05);
        }

        .chat-input-area {
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.1);
            /*margin: 0 -20px -20px -20px;*/
            padding: 15px 20px;
            border-radius: 32px; /* Curve both left and right edges */
            flex-shrink: 0;
            overflow: hidden; /* Allow dropdowns to overflow */
            position: relative; /* For absolute positioned children */
            height: auto !important;
            max-height: 160px !important;
        }
        .chat-input-controls { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        #chatInput {
            flex: 1;
            min-width: 0;
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-dark);
            font-size: 1rem;
            padding: 12px 0;
            font-family: 'Poppins', sans-serif;
			resize: none;
			overflow: hidden !important;
        }
        #chatInput::placeholder { color: var(--text-light); opacity: 0.6; }
        .chat-input-controls button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-input-controls button i {
            color: var(--primary-blue);
        }
        .chat-input-controls button:hover {
            color: var(--text-dark);
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            transform: scale(1.1);
        }
        .chat-input-controls button:hover i {
            color: var(--text-dark);
        }
        /* Voice Chat Button - Matches other buttons */
        #mic-btn {
            position: relative;
        }

        #mic-btn i {
            color: var(--primary-blue);
        }

        #mic-btn:hover i {
            color: var(--text-dark);
        }

        /* Connecting State - Pulsing */
        #mic-btn.mic-connecting {
            background: rgba(107, 114, 128, 0.3) !important;
            border-color: #6b7280 !important;
            animation: pulse-connecting 1s infinite;
        }

        #mic-btn.mic-connecting i {
            color: #6b7280 !important;
        }

        @keyframes pulse-connecting {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Listening State - Green with ripples */
        #mic-btn.mic-listening {
            background: rgba(16, 185, 129, 0.2) !important;
            border-color: #10b981 !important;
            animation: pulse-listening 2s infinite;
        }

        #mic-btn.mic-listening i {
            color: #10b981 !important;
        }

        #mic-btn.mic-listening::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #10b981;
            animation: ripple 1.5s infinite;
            pointer-events: none;
        }

        #mic-btn.mic-listening::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #10b981;
            animation: ripple 1.5s infinite 0.5s;
            pointer-events: none;
        }

        @keyframes pulse-listening {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 15px 3px rgba(16, 185, 129, 0.3); }
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        /* Speaking State - Purple animated */
        #mic-btn.mic-speaking {
            background: rgba(139, 92, 246, 0.2) !important;
            border-color: #8b5cf6 !important;
            animation: pulse-speaking 0.8s infinite;
        }

        #mic-btn.mic-speaking i {
            color: #8b5cf6 !important;
            animation: icon-pulse 0.8s infinite;
        }

        #mic-btn.mic-speaking::before,
        #mic-btn.mic-speaking::after {
            display: none;
        }

        @keyframes pulse-speaking {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 15px 3px rgba(139, 92, 246, 0.3);
                transform: scale(1.05);
            }
        }

        @keyframes icon-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Voice Chat Bubbles */
        .chat-bubble.audio-listening {
            font-style: italic;
            color: #666;
            border-color: #ddd;
            background: #f9f9f9;
        }

        .chat-bubble.audio-playing {
            border-left: 4px solid #0d6efd; /* Blue accent for AI voice */
        }
        /* donemic part */

        /* Upload Button Styles */
        #upload-btn {
            position: relative;
        }

        #upload-btn i {
            color: var(--primary-blue);
        }

        #upload-btn:hover i {
            color: var(--text-dark);
        }

        /* Processing State - Blue spinning */
        #upload-btn.upload-processing {
            background: rgba(59, 130, 246, 0.2) !important;
            border-color: #3b82f6 !important;
            animation: pulse-upload 1s infinite;
            pointer-events: none;
        }

        #upload-btn.upload-processing i {
            color: #3b82f6 !important;
            animation: spin-upload 1s linear infinite;
        }

        @keyframes pulse-upload {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @keyframes spin-upload {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Success State - Green flash */
        #upload-btn.upload-success {
            background: rgba(16, 185, 129, 0.2) !important;
            border-color: #10b981 !important;
        }

        #upload-btn.upload-success i {
            color: #10b981 !important;
        }

        /* Message without avatar (for tool outputs) */
        .message-bubble.no-avatar .content {
            margin-left: 0;
        }

        /* Toggle between mic and send button based on input */
        .chat-input-controls #mic-btn {
            display: flex;
        }
        .chat-input-controls #send-btn {
            display: none;
        }
        .chat-input-controls.has-text #mic-btn {
            display: none;
        }
        .chat-input-controls.has-text #send-btn {
            display: flex;
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e) !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 4px 15px rgba(243, 199, 144 0.4);
        }
        .send-btn i {
            color: white !important;
        }
        .send-btn:hover {
            box-shadow: 0 6px 20px rgba(243, 199, 144 0.6) !important;
            transform: scale(1.1) !important;
        }

        .summary-section {
            flex: 0 0 160px;
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 160px;
            min-height: 0;
            max-height: calc(100vh - 220px);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .placeholder-page, .agenda-container {
            flex: 1;
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
            min-height: 0;
            max-height: calc(100vh - 220px);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .summary-header { display: flex; justify-content: space-between; align-items: center; }
        .summary-header h3 { margin: 0; font-size: 1rem; color: var(--text-dark); font-weight: 600; }
        .summary-header button {
            background: var(--container-bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 8px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .summary-header button i {
            color: var(--primary-blue);
        }
        .summary-header button:hover {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: #fff;
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 150, 32, 0.4);
        }
        .summary-header button:hover i {
            color: #fff;
        }
        .summary-content { font-size: 0.95rem; line-height: 1.7; color: var(--text-light); overflow-y: auto; flex: 1; min-height: 0; }
        .summary-content h4 {
            color: var(--primary-blue);
            margin-top: 20px;
            margin-bottom: 12px;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 0.9rem;
            text-shadow: 0 2px 10px rgba(0, 169, 157, 0.2);
        }
        .summary-content h4:first-child { margin-top: 0; }
        .summary-content ul { list-style-type: none; padding-left: 15px; margin-top: 10px; }
        .summary-content ul li { position: relative; padding-left: 20px; margin-bottom: 8px; }
        .summary-content ul li::before { content: 'â–¶'; position: absolute; left: 0; top: 0; color: var(--primary-blue); font-size: 0.8em; }
        .summary-content ul li strong { color: var(--text-dark); }
        .agenda-summary-item { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; border-radius: 12px; }
        .agenda-summary-item:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25); }
        .agenda-summary-item.past-event { opacity: 0.6; }
        .key-topics-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .key-topic-pill { background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .key-topic-pill:hover { background: var(--primary-blue); color: var(--text-dark); border-color: var(--primary-blue); }
        .urgent-meeting-highlight { background: linear-gradient(135deg, rgba(245, 150, 32, 0.3) 0%, rgba(245, 150, 32, 0.15) 100%); border: 3px solid var(--primary-blue); border-radius: 12px; padding: 18px; margin: 15px 0; box-shadow: 0 0 5px rgba(245, 150, 32, 0.2), 0 2px 8px rgba(245, 150, 32, 0.1); position: relative; overflow: hidden; }
        @keyframes pulseUrgent { 0%, 100% { box-shadow: 0 0 5px rgba(245, 150, 32, 0.2), 0 2px 8px rgba(245, 150, 32, 0.1); } 50% { box-shadow: 0 0 8px rgba(245, 150, 32, 0.3), 0 2px 10px rgba(245, 150, 32, 0.15); } }
        .urgent-meeting-highlight h4 { color: var(--primary-blue) !important; border-bottom: 2px solid var(--primary-blue) !important; margin-top: 0 !important; font-size: 0.9rem !important; text-shadow: none; }
        .urgent-meeting-highlight p { color: var(--text-light); font-size: 0.75rem; line-height: 1.6; }

        .typing-indicator { display: flex; align-items: center; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: var(--primary-blue); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .placeholder-page h2 { color: var(--primary-blue); text-align: center; }
        .placeholder-page p { text-align: center; font-size: 1.1rem; }
        /* Style for AI Tools Cards */
        #tools-page { flex-direction: column; } /* Ensure tools page stacks vertically */
        .tools-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
            gap: 20px;
            width: 100%;
            padding: 20px 0; /* Add padding around the grid */
        }
        .tool-card {
            background: var(--container-bg);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center icon and text */
            text-align: center; /* Center text */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(15px);
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, var(--container-bg), rgba(0, 169, 157, 0.1));
        }
        .tool-icon {
            font-size: 2.2rem;
            color: var(--primary-blue);
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .tool-card:hover .tool-icon {
            transform: scale(1.1);
            text-shadow: 0 2px 15px #008a7e;
        }
        .tool-title {
            color: var(--text-dark);
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .tool-description {
            font-size: 0.85rem;
            line-height: 1.6;
            opacity: 0.85;
            flex-grow: 1; /* Allow description to take space */
            margin-bottom: 15px; /* Space before button */
        }
        .tool-action-btn {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            display: inline-flex; /* Make it inline */
            align-items: center;
            gap: 6px;
            margin-top: auto; /* Push button to bottom */
        }
        .tool-action-btn:hover {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 169, 157, 0.3);
            border-color: transparent;
        }


        .agenda-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .calendar-nav-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1 1 auto;
            min-width: 150px;
            justify-content: space-between;
        }
        
        .nav-buttons-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .calendar-nav-btn {
            background: var(--container-bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .calendar-nav-btn i {
            color: var(--primary-blue);
        }
        .calendar-nav-btn:hover {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            box-shadow: 0 2px 10px #008a7e;
            transform: scale(1.1);
        }
        .calendar-nav-btn:hover i {
            color: var(--text-dark);
        }
        
        .calendar-nav-btn:active {
            transform: scale(0.95);
        }
        
        .agenda-header h2 {
            margin: 0;
            font-weight: 600;
            font-size: 1.5rem;
            color: var(--text-dark);
            text-shadow: 0 2px 10px rgba(0, 169, 157, 0.2);
            flex: 1;
            text-align: center;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            background: var(--container-bg-light);
            padding: 4px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
        }

        .view-toggle button,
        .mobile-view-btn {
            background: transparent;
            border: none;
            color: var(--text-light);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 500;
        }
        .view-toggle button i,
        .mobile-view-btn i {
            color: var(--primary-blue);
        }

        .view-toggle button.active,
        .mobile-view-btn.active {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            box-shadow: 0 2px 10px rgba(243, 199, 144 0.4);
        }
        .view-toggle button.active i,
        .mobile-view-btn.active i {
            color: var(--text-dark);
        }

        .view-toggle button:hover:not(.active),
        .mobile-view-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .agenda-view {
            display: none;
            flex-grow: 1;
            min-height: 0;
            overflow-y: auto;
        }

        .agenda-view.active {
            display: block;
        }

        #today-view.active,
        #week-view.active {
            display: flex !important; /* Use flex for week view grid */
            flex-direction: column;
            gap: 15px;
        }

        #month-view.active {
            display: flex !important; /* Use flex for month view grid */
            flex-direction: column;
        }

        .month-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 15px;
            flex-grow: 1;
            min-height: 0;
            grid-auto-rows: minmax(45px, auto);
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            padding-bottom: 60px;
        }

        .month-calendar-grid::-webkit-scrollbar {
            width: 8px;
        }

        .month-calendar-grid::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 4px;
        }

        .month-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
            opacity: 0.7;
            padding: 10px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .month-day-header.weekend {
            background-color: rgba(0, 0, 0, 0.15);
            border-radius: 5px 5px 0 0;
        }

        .month-day-cell {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 1px 2px;
            background: var(--container-bg-light);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 45px;
            height: auto;
        }

        .month-day-cell:hover {
            background: rgba(0, 169, 157, 0.2);
            transform: scale(1.02);
            border-color: var(--primary-blue);
        }

        .month-day-cell.weekend {
            background-color: rgba(0, 0, 0, 0.15);
        }

        .month-day-cell.today {
            border: 2px solid var(--primary-blue);
            background: rgba(0, 169, 157, 0.15);
            box-shadow: 0 0 15px rgba(0, 169, 157, 0.3);
        }

        .month-day-cell.other-month {
            opacity: 0.3;
            pointer-events: none;
            background: transparent;
        }

        .month-day-cell.disabled-day {
            opacity: 0.4;
            background: rgba(0, 0, 0, 0.2);
        }

        .month-day-cell.disabled-day .month-day-number {
            opacity: 0.5;
        }

        .month-day-cell.disabled-day .month-event-dot {
            cursor: pointer;
        }

        .month-day-number {
            font-weight: 600;
            font-size: 0.7rem;
            margin-bottom: 1px;
            flex-shrink: 0;
            line-height: 1;
        }

        .month-day-events {
            display: flex;
            flex-direction: column;
            gap: 1px;
            flex-grow: 1;
            overflow: hidden;
            min-height: 0;
        }

        .month-day-events::-webkit-scrollbar {
            width: 3px;
        }

        .month-day-events::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 2px;
        }

        .month-event-dot {
            width: 100%;
            min-height: 10px;
            max-height: 12px;
            background: var(--primary-blue);
            border-radius: 2px;
            font-size: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            display: flex;
            align-items: center;
            padding: 1px 3px;
            cursor: pointer;
            color: var(--text-dark);
            font-weight: 500;
            gap: 3px;
            flex-shrink: 0;
            line-height: 1.1;
        }

        .month-event-dot.milestone {
            background: #ffc107;
            color: #000;
        }

        .month-event-dot.past-event {
            opacity: 0.4;
            background: rgba(128, 128, 128, 0.5);
        }

        .month-event-dot.past-event.milestone {
            background: rgba(255, 193, 7, 0.3);
        }

        .month-event-dot .event-time {
            font-weight: 600;
            flex-shrink: 0;
            font-size: 0.5rem;
            opacity: 0.9;
            line-height: 1;
        }

        .month-event-dot .event-title-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.5rem;
            line-height: 1.1;
        }

        .today-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .today-date {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .today-events-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .desktop-calendar { display: block; }
        .mobile-calendar { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex: 1; overflow-y: auto; max-height: calc(100vh - 250px); padding-bottom: 80px; }
        
        .calendar-grid::-webkit-scrollbar {
            width: 8px;
        }

        .calendar-grid::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 4px;
        }
        .day-column { border-right: 1px solid var(--border-color); padding: 5px; padding-bottom: 100px; }
        .day-column:last-child { border-right: none; }
        .day-column.weekend { background-color: rgba(0, 0, 0, 0.2); border-radius: 5px; }
        .day-column.past-day { opacity: 0.4; }
        .day-column.past-day .day-header { opacity: 0.6; }
        .event.past-event { opacity: 0.5; background: rgba(128, 128, 128, 0.3) !important; }
        .event.past-event .event-time, .event.past-event .event-title { opacity: 0.7; }
        #day-meetings-list { max-height: calc(80vh - 150px); overflow-y: auto; margin-top: 20px; padding-right: 10px; }
        #day-meetings-list::-webkit-scrollbar { width: 8px; }
        #day-meetings-list::-webkit-scrollbar-thumb { background: var(--primary-blue); border-radius: 4px; }
        #day-meetings-list .event { transition: all 0.2s; }
        #day-meetings-list .event:hover { transform: translateX(5px); }
        .day-header {
            text-align: center;
            font-weight: 600;
            padding-bottom: 8px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        .day-header .day-name {
            font-size: 0.75em;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .day-header .day-number {
            font-size: 1.4em;
            margin-top: 5px;
            color: var(--text-dark);
            font-weight: 700;
        }
        .event {
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.15), rgba(0, 169, 157, 0.25));
            border-left: 4px solid var(--primary-blue);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .event:hover {
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.3), rgba(0, 169, 157, 0.4));
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 169, 157, 0.3);
        }
        .event-time { font-size: 0.8em; opacity: 0.9; margin-bottom: 5px; font-weight: 500; }
        .event-title { font-weight: 600; color: var(--text-dark); font-size: 0.95rem; }
        .event-milestone {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.25));
            border-left-color: #008a7e;
        }
        .event-milestone:hover {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3), rgba(255, 193, 7, 0.4));
        }

        .topics-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; width: 100%; }
        .topic-card {
            background: var(--container-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(20px);
        }
        .topic-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 169, 157, 0.3);
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, var(--container-bg), rgba(0, 169, 157, 0.1));
        }
        .topic-icon {
            font-size: 2.5rem;
            color: var(--primary-blue);
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .topic-card:hover .topic-icon {
            transform: scale(1.1) rotate(5deg);
            text-shadow: 0 4px 20px #008a7e;
        }
        .topic-title {
            color: var(--text-dark);
            margin: 0 0 10px 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        .topic-description {
            font-size: 0.9rem;
            line-height: 1.7;
            margin-bottom: 20px;
            flex-grow: 1;
            opacity: 0.9;
        }
        .topic-kpis {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .kpi-item {
            text-align: center;
            flex: 1;
        }
        .kpi-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-blue);
            text-shadow: 0 2px 10px rgba(0, 169, 157, 0.3);
        }
        .kpi-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .topic-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            flex-wrap: wrap; /* Allow wrapping if needed */
        }
        .topic-actions button {
            flex: 1 1 auto;
            min-width: 0; /* Allow shrinking below content size */
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 10px 8px; /* Reduced horizontal padding */
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: normal; /* Allow text wrapping */
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
            line-height: 1.3;
        }
        .topic-actions button:hover {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4);
            border-color: transparent;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(30px);
            padding: 35px;
            border-radius: 20px;
            width: 650px;
            max-width: 90%;
            text-align: left;
            position: relative;
            animation: slideInModal 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Renamed animation */
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        #focus-modal-content {
            width: 950px;
            max-width: 95%;
        }
        @keyframes slideInModal { /* Renamed animation */
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .close-button {
            color: var(--primary-blue);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-button:hover {
            color: #fff;
            background: var(--primary-blue);
            transform: rotate(90deg);
        }
        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-blue);
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.5rem;
            text-shadow: 0 2px 10px rgba(0, 169, 157, 0.3);
        }
        #event-modal-title { font-size: 1.5rem; color: var(--text-dark); margin: 0 0 5px 0; text-align: left; }
        #event-modal-time { color: var(--primary-blue); font-weight: 500; margin-bottom: 15px; text-align: left; }
        #event-modal-details { margin-bottom: 20px; line-height: 1.6; text-align: left;}
        .event-actions, .day-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            margin-top: 10px;
        }
        .event-actions button, .day-actions button {
            flex: 1;
            background: var(--container-bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
        }
        .event-actions button i, .day-actions button i {
            color: var(--primary-blue);
        }
        .event-actions button:hover, .day-actions button:hover {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px #008a7e;
        }
        .event-actions button:hover i, .day-actions button:hover i {
            color: var(--text-dark);
        }

        .persona-options { display: flex; flex-direction: column; gap: 15px; }
        .persona-option {
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 18px;
            background: var(--container-bg-light);
            transition: all 0.3s ease-in-out;
        }
        .persona-option:hover {
            background-color: rgba(0, 169, 157, 0.2);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 169, 157, 0.2);
        }
        .persona-option.selected {
            border-color: var(--primary-blue);
            box-shadow: 0 0 20px rgba(0, 169, 157, 0.4);
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.15), rgba(0, 169, 157, 0.25));
        }
        .persona-option img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .persona-option.selected img {
            border-color: var(--primary-blue);
        }
        .persona-details h4 {
            margin: 0 0 8px 0;
            color: var(--text-dark);
            font-size: 1.1rem;
        }
        .persona-details p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-light);
            opacity: 0.85;
            line-height: 1.5;
        }

        .key-topic-pill, .modal-topic-pill {
            background: var(--container-bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .key-topic-pill:hover, .modal-topic-pill:hover, .modal-topic-pill.active {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4);
        }

        .modal-pills-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px 0;
        }

        .meeting-columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .meeting-column {
            background: var(--container-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 18px;
            display: flex;
            flex-direction: column;
            min-height: 360px;
        }
        .meeting-column-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .meeting-column-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 6px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 55vh;
        }
        .meeting-column-empty {
            text-align: center;
            opacity: 0.6;
            font-size: 0.9rem;
            padding: 25px 0;
        }

        #meetings-modal-list .meeting-item {
            cursor: pointer;
            transition: all 0.3s;
            background: var(--container-bg-light);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        #meetings-modal-list .meeting-item:hover {
            background: linear-gradient(135deg, rgba(0, 169, 157, 0.15), rgba(0, 169, 157, 0.25));
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 169, 157, 0.3);
        }
        #meetings-modal-list .meeting-title {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1.05rem;
            margin-bottom: 5px;
        }
        #meetings-modal-list .meeting-time {
            font-size: 0.9em;
            opacity: 0.8;
            color: var(--primary-blue);
        }
        #meetings-modal-list .meeting-date {
            font-size: 0.85em;
            opacity: 0.7;
            color: var(--text-light);
            margin-top: 3px;
        }
        #meetings-modal-list .meeting-item.past-meeting {
            opacity: 0.5;
            background: rgba(128, 128, 128, 0.2) !important;
        }
        #meetings-modal-list .meeting-item.past-meeting .meeting-title,
        #meetings-modal-list .meeting-item.past-meeting .meeting-time,
        #meetings-modal-list .meeting-item.past-meeting .meeting-date {
            opacity: 0.7;
        }
        #meetings-modal-list .dropdown-header, #dayActionModal .dropdown-header {
            font-size: 0.85rem;
            text-transform: uppercase;
            opacity: 0.7;
            padding: 20px 0 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            font-weight: 600;
            letter-spacing: 1px;
        }



        #ask-agent-btn {
            position: absolute;
            display: none;
            background: var(--container-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--primary-blue);
            color: var(--text-light);
            padding: 10px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 1001;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 169, 157, 0.4);
            font-weight: 500;
        }
        #ask-agent-btn:hover {
            background: linear-gradient(135deg, var(--primary-blue), #008a7e);
            color: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 169, 157, 0.6);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-blue);
            border-radius: 10px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #008a7e;
        }

        @media (max-width: 1200px) {
            .page-content { flex-direction: column; }
            .persona-display { 
                flex: 0 0 auto;
                width: 100%;
                max-width: 700px;
                margin: 0 auto 20px;
                padding: 20px;
            }
            .multi-agent-header h3 {
                font-size: 1.1rem;
            }
            .agent-selection-list {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px;
            }
            .agent-select-item {
                flex: 1;
                min-width: 200px;
            }
            .chat-section-container { 
                flex-direction: column; 
                max-height: 60vh; 
            }
            .summary-section, .agenda-container { max-height: 60vh; }
            .tools-container { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        }

        /* Fix for 768px-1200px range: Ensure chat-interaction-area doesn't get compressed */
        /* Place persona-display at bottom of chat-section-container */
        @media (min-width: 769px) and (max-width: 1200px) {
            .chat-section-container {
                flex-direction: column !important;
                max-height: none !important;
                height: 100% !important;
            }
            
            /* Reorder: chat-interaction-area first (top), persona-display second (bottom) */
            .chat-interaction-area {
                flex: 1 !important;
                min-width: 0 !important;
                width: 100% !important;
                order: 1 !important;
                min-height: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: visible !important;
                height: auto !important;
            }
            
            /* Ensure chat-messages is visible and scrollable */
            .chat-interaction-area .chat-messages {
                flex: 1 !important;
                min-height: 200px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
            
            /* Ensure chat-input-area is visible */
            .chat-interaction-area .chat-input-area {
                display: flex !important;
                flex-shrink: 0 !important;
            }
            
            .persona-display {
                flex: 0 0 auto !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 20px auto 0 auto !important;
                padding: 2px !important;
                order: 2 !important;
                border-radius: 20px 20px 20px 20px !important;
            }
        }

        @media (max-width: 768px) {
            body {
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                display: flex;
                flex-direction: column;
            }
            .header { padding: 15px 20px; }
            .header-left span, .header-right .welcome-text { display: none; }
            .mobile-menu-btn { display: block; }

            .nav-tabs-container {
                display: none; /* Hidden by default */
                position: fixed;
                top: 73px; /* Height of header */
                left: 0;
                right: 0;
                height: auto;
                background: var(--dark-teal); /* Solid background for mobile menu */
            }
            .nav-tabs-container.active {
                display: flex;
            }
            .nav-tabs {
                flex-direction: column;
                width: 100%;
                padding: 10px;
                gap: 0;
            }
            .nav-tabs button {
                justify-content: flex-start;
                border-radius: 8px;
            }

            .main-container {
                flex-grow: 1;
                display: flex;
                overflow: hidden; /* Prevent body scrolling */
            }

            .page-content {
                padding: 0;
                gap: 0;
                flex-grow: 1;
                height: 100%; /* Take full height of main-container */
                overflow: hidden; /* Page content itself handles scrolling */
            }

            .chat-section-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
                padding: 1rem;
                max-height: none;
                box-sizing: border-box; /* Ensure padding is included in height */
            }

            .persona-display {
                display: block;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--container-bg);
                backdrop-filter: blur(30px);
                border-radius: 20px 20px 0 0;
                border: 1px solid var(--border-color);
                border-bottom: none;
                padding: 12px 15px 15px;
                max-height: 50vh;
                overflow-y: auto;
                z-index: 900;
                transform: translateY(calc(100% - 55px));
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5);
            }
            
            .persona-display.expanded {
                transform: translateY(0);
            }
            
            /* Mode Toggle on Mobile */
            .mode-toggle-container {
                padding: 6px 8px;
                margin-bottom: 8px;
                gap: 6px;
            }
            
            .mode-toggle-label {
                font-size: 0.7rem;
                font-weight: 600;
            }
            
            .mode-toggle-switch {
                width: 46px;
                height: 24px;
            }
            
            .mode-toggle-slider {
                border-width: 2px;
            }
            
            .mode-toggle-slider:before {
                height: 16px;
                width: 16px;
                font-size: 0.6rem;
                left: 2px;
                bottom: 2px;
            }
            
            .mode-toggle-switch input:checked + .mode-toggle-slider:before {
                transform: translateX(22px);
                font-size: 0.7rem;
            }
            
            /* Single Agent Display on Mobile */
            .single-agent-avatar {
                width: 100px;
                height: 100px;
                border-width: 3px;
            }
            
            .single-agent-name {
                font-size: 1.1rem;
            }
            
            .single-agent-title {
                font-size: 0.8rem;
            }
            
            .single-agent-description {
                font-size: 0.75rem;
                padding: 0;
            }
            
            /* Multi-Agent Header */
            .multi-agent-header {
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding: 8px;
                border-radius: 10px;
                background: rgba(0, 169, 157, 0.1);
                transition: background 0.3s;
            }
            
            .multi-agent-header:active {
                background: rgba(0, 169, 157, 0.2);
            }
            
            .multi-agent-header h3 {
                margin: 0 !important;
                font-size: 1rem !important;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .multi-agent-header p {
                display: none !important; /* Hide subtitle on mobile */
            }
            
            .multi-agent-header::after {
                content: 'â–¼';
                font-size: 1.3rem;
                color: var(--primary-blue);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                flex-shrink: 0;
            }
            
            .persona-display.expanded .multi-agent-header::after {
                transform: rotate(180deg);
            }
            
            .persona-display:not(.expanded) .agent-selection-list,
            .persona-display:not(.expanded) .quick-actions {
                display: none;
            }

            /* Meeting Columns - Mobile Responsive */
            .meeting-columns-grid {
                grid-template-columns: 1fr; /* Stack columns on mobile */
                gap: 15px;
            }
            .meeting-column {
                min-height: auto; /* Remove fixed height on mobile */
                padding: 15px;
            }
            .meeting-column-list {
                max-height: 40vh; /* Reduce max height on mobile */
            }
            .meeting-column-title {
                font-size: 0.95rem;
            }
            .modal-content {
                padding: 20px;
                max-height: 85vh;
            }
            #meetings-modal-list {
                margin-top: 15px;
            }
            
            /* Agent Selector Button on Mobile */
            #agentSelectorBtn {
                padding: 5px;
                width: 60px !important;
                min-width: 60px;
                gap: 3px;
            }
            
            #agentSelectorBtn img {
                width: 28px;
                height: 28px;
                border-width: 1.5px;
            }
            
            #agentSelectorBtn i {
                font-size: 0.65rem;
            }
            
            .agent-selection-list {
                gap: 10px;
                max-height: calc(50vh - 120px);
                overflow-y: auto;
            }
            
            .agent-select-item {
                padding: 10px 12px;
                border-radius: 14px;
                min-height: 60px;
            }
            
            .agent-toggle {
                width: 48px;
                height: 28px;
                margin-right: 12px;
            }
            
            .agent-toggle-slider {
                border-width: 2px;
            }
            
            .agent-toggle-slider:before {
                height: 20px;
                width: 20px;
                left: 2px;
                bottom: 2px;
            }
            
            .agent-checkbox:checked + .agent-toggle .agent-toggle-slider:before {
                transform: translateX(20px);
            }
            
            .agent-mini-avatar {
                width: 38px;
                height: 38px;
                margin-right: 10px;
            }
            
            .agent-select-name {
                font-size: 0.9rem;
                font-weight: 600;
            }
            
            .agent-select-title {
                font-size: 0.72rem;
                margin-top: 2px;
            }
            
            .multi-agent-badge {
                font-size: 0.75rem;
                padding: 3px 9px;
            }
            
            .quick-actions {
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid var(--border-color);
            }
            
            .quick-actions h4 {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            .quick-action-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            
            .summary-section {
                display: none;
            }

            .chat-interaction-area {
                height: 100%;
                padding-bottom: 65px; /* Space for the collapsed agent selector */
                display: flex;
                flex-direction: column;
            }
            
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding-bottom: 10px;
            }

            .chat-input-area {
                padding-bottom: env(safe-area-inset-bottom);
                padding: 20px 15px;
                margin: 0 -1rem -1rem -1rem;
            }
            
            #chatInput {
                padding-top: 15px;
                padding-bottom: 15px;
                font-size: 0.95rem;
            }
            
            .chat-input-controls {
                flex-wrap: wrap;
                gap: 6px;
            }

            .chat-input-controls button {
                width: 40px;
                height: 40px;
                font-size: 0.85rem;
            }
            
            .chat-input-controls button:not(#agentSelectorBtn):not(.send-btn) {
                flex-shrink: 0;
            }

            .send-btn {
                width: 48px !important;
                height: 48px !important;
            }

            #topics-page, #agenda-page, .placeholder-page, #tools-page {
                padding: 0;
                width: 100%;
                box-sizing: border-box;
                overflow-y: auto;
                overflow-x: hidden;
                height: 100%;
            }

            .topics-container, .tools-container {
                padding: 15px;
                grid-template-columns: 1fr;
                height: auto;
                width: 100%;
                box-sizing: border-box;
            }
            .tool-card { padding: 20px; }
            .tool-icon { font-size: 2rem; }
            .tool-title { font-size: 1rem; }
            .tool-description { font-size: 0.8rem; }


            .topic-card {
                margin-bottom: 15px;
                width: 100%;
                box-sizing: border-box;
                padding: 15px;
            }

            .topic-icon {
                font-size: 1.8rem;
                margin-bottom: 10px;
            }

            .topic-title {
                font-size: 1.1rem;
            }

            .topic-description {
                font-size: 0.85rem;
                margin-bottom: 15px;
                line-height: 1.5;
            }

            .topic-kpis {
                gap: 15px;
                margin-bottom: 15px;
                padding: 15px 0;
            }

            .kpi-value {
                font-size: 1.5rem;
            }

            .kpi-label {
                font-size: 0.7rem;
            }

            .topic-actions {
                flex-direction: column;
                gap: 8px;
            }

            .topic-actions button {
                width: 100%;
                box-sizing: border-box;
            }

            .agenda-container {
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
                max-height: none;
                border-radius: 0;
                overflow: hidden;
                height: 100%; /* Full page height */
                display: flex; /* Allow mobile calendar to grow */
                flex-direction: column;
            }

            .modal-content {
                padding: 25px 20px;
                max-height: 80vh;
            }

            .modal-content h2 {
                font-size: 1.3rem;
            }

            #event-modal-title {
                font-size: 1.2rem;
            }

            .modal-topic-pill {
                font-size: 0.85rem;
                padding: 7px 13px;
            }
            .placeholder-page {
                padding: 30px 20px;
            }

            .placeholder-page h2 {
                font-size: 1.5rem;
            }

            .placeholder-page p {
                font-size: 1rem;
            }

            #meetings-modal-list .meeting-title {
                font-size: 0.95rem;
            }

            #meetings-modal-list .meeting-time {
                font-size: 0.85rem;
            }

            #mobile-agenda-events .event {
                margin-bottom: 12px;
            }

            .desktop-calendar { display: none; }

            .mobile-calendar {
                display: flex;
                flex-direction: column;
                flex-grow: 1;
                width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
                height: 100%; /* Take remaining height */
                min-height: 0; /* Allow flex shrinking */
            }

            .agenda-header {
                padding-bottom: 15px;
                margin-bottom: 15px;
                flex-shrink: 0; /* Prevent header from shrinking */
            }

            .agenda-header h2 {
                font-size: 1.3rem;
            }

            .view-toggle {
                width: 100%;
                justify-content: center;
            }

            .view-toggle button,
            .mobile-view-btn {
                font-size: 0.85rem;
                padding: 8px 14px;
            }

            #mobile-month-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 3px;
                width: 100%;
                box-sizing: border-box;
                flex-shrink: 0; /* Prevent grid from shrinking */
            }

            #mobile-month-grid .day-name {
                text-align: center;
                font-size: 0.7em;
                opacity: 0.7;
                padding-bottom: 3px;
            }

            #mobile-month-grid .day-cell {
                position: relative;
                text-align: center;
                cursor: pointer;
                border-radius: 50%;
                font-size: 0.9rem;
                box-sizing: border-box;
                aspect-ratio: 1 / 1;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 2px auto;
                width: 40px;
                height: 40px;
                transition: all 0.3s;
                font-weight: 500;
            }

            #mobile-month-grid .day-cell:hover {
                background-color: rgba(0, 169, 157, 0.2);
                transform: scale(1.1);
            }

            #mobile-month-grid .day-cell.selected {
                background: linear-gradient(135deg, var(--primary-blue), #008a7e);
                color: var(--text-dark);
                box-shadow: 0 4px 15px rgba(0, 169, 157, 0.5);
                font-weight: 700;
            }

            #mobile-month-grid .day-cell.today {
                font-weight: bold;
                border: 2px solid var(--primary-blue);
                box-shadow: 0 0 15px rgba(0, 169, 157, 0.3);
                background: rgba(0, 169, 157, 0.15);
            }

            #mobile-month-grid .day-cell.has-event::after {
                content: '';
                position: absolute;
                bottom: 2px;
                left: 50%;
                transform: translateX(-50%);
                width: 5px;
                height: 5px;
                background-color: var(--primary-blue);
                border-radius: 50%;
                box-shadow: 0 0 8px rgba(0, 169, 157, 0.8);
            }

            #mobile-month-grid .day-cell.selected.has-event::after {
                background-color: white;
            }

            #mobile-month-grid .day-cell.today.has-event::after {
                background-color: var(--primary-blue);
            }

            .month-calendar-grid {
                gap: 5px;
            }

            .month-day-cell {
                min-height: 60px;
                font-size: 0.85rem;
                padding: 5px;
            }

            .month-day-number {
                font-size: 0.85rem;
            }

            .month-event-dot {
                height: 3px;
            }

            #mobile-agenda-events {
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid var(--border-color);
                flex-grow: 1;
                overflow-y: auto;
                min-height: 0; /* Allow this to shrink and grow */
            }
        }

        /* ============================================
           COMPREHENSIVE RESPONSIVE FIXES
           ============================================ */

        /* ===== 1. HEADER & NAVIGATION FIXES ===== */
        @media (max-width: 768px) {
            /* Header spacing */
            .header {
                padding: 12px 15px;
                gap: 10px;
            }
            
            .header-left,
            .header-right {
                gap: 10px;
            }
            
            /* User profile image */
            .header-right .user-profile img {
                width: 35px;
                height: 35px;
            }
            
            /* Mobile menu button */
            .mobile-menu-btn {
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2rem;
            }
            
            /* Navigation tabs - ensure they don't overflow */
            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .nav-tabs button {
                padding: 10px 15px;
                font-size: 0.85rem;
                white-space: nowrap;
                flex: 1 1 auto;
                min-width: 0;
            }
            
            /* Nav tabs container positioning */
            .nav-tabs-container {
                top: 69px; /* Adjust based on header height */
                max-height: calc(100vh - 69px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ===== 2. TOPIC CARDS - COMPLETE FIX ===== */
        /* Desktop - ensure buttons don't overflow */
        .topic-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            flex-wrap: wrap; /* Allow wrapping if needed */
        }

        .topic-actions button {
            flex: 1 1 auto;
            min-width: 0; /* Allow shrinking below content size */
            white-space: normal; /* Allow text wrapping */
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
            padding: 10px 8px; /* Reduced horizontal padding */
            font-size: 0.85rem;
            line-height: 1.3;
        }

        /* Topic card overflow fix */
        .topic-card {
            overflow: visible; /* Change from hidden to visible */
            min-height: auto;
        }

        @media (max-width: 768px) {
            .topic-card {
                margin-bottom: 15px;
                width: 100%;
                box-sizing: border-box;
                padding: 15px;
                overflow: visible; /* Ensure content isn't clipped */
            }
            
            .topic-actions {
                flex-direction: column;
                gap: 8px;
                flex-wrap: nowrap; /* Single column, no wrap */
            }
            
            .topic-actions button {
                width: 100%;
                box-sizing: border-box;
                white-space: normal;
                word-wrap: break-word;
                overflow-wrap: break-word;
                text-align: center;
                min-height: 44px; /* Touch-friendly */
                padding: 10px 8px;
                font-size: 0.8rem;
                line-height: 1.3;
            }
            
            /* Ensure topic content doesn't overflow */
            .topic-content {
                width: 100%;
                box-sizing: border-box;
            }
            
            .topic-description {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
        }

        /* ===== 3. CHAT SECTION - COMPLETE FIX ===== */
        @media (max-width: 768px) {
            .chat-section-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
                padding: 1rem;
                max-height: none;
                box-sizing: border-box;
                overflow: visible; /* Ensure content isn't clipped */
                position: relative;
                display: flex;
                flex-direction: column;
            }
            
            .chat-interaction-area {
                height: 100%;
                padding-bottom: 65px;
                display: flex;
                flex-direction: column;
                overflow: visible; /* Change from hidden */
                min-height: 0;
                flex: 1;
            }
            
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                padding-bottom: 10px;
                min-height: 0;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                box-sizing: border-box;
            }
            
            .chat-input-area {
                padding-bottom: env(safe-area-inset-bottom);
                padding: 15px;
                margin: 0; /* Remove negative margins */
                position: relative;
                z-index: 10;
                background: rgba(0, 0, 0, 0.1);
                flex-shrink: 0;
                width: 100%;
                box-sizing: border-box;
                border-top: 1px solid var(--border-color);
            }
            
            #chatInput {
                padding: 12px 15px;
                font-size: 0.95rem;
                width: 100%;
                box-sizing: border-box;
                min-width: 0;
            }
            
            .chat-input-controls {
                flex-wrap: wrap;
                gap: 8px;
                flex-shrink: 0;
            }
            
            .chat-input-controls button {
                width: 40px;
                height: 40px;
                font-size: 0.85rem;
                flex-shrink: 0;
                min-width: 40px;
            }
            
            .send-btn {
                width: 48px !important;
                height: 48px !important;
                min-width: 48px;
            }
            
            /* Message bubbles responsive */
            .message-bubble .content {
                max-width: 85%; /* Slightly more on mobile */
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            /* Section control button */
            .section-control-btn {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.85rem !important;
                top: 10px !important;
                right: 10px !important;
            }
        }

        /* Fix for chat-interaction-area compression at all screen sizes */
        .chat-interaction-area {
            flex: 1;
            min-width: 0;
            min-height: 0;
        }

        /* ===== 4. TOOL CARDS FIXES ===== */
        @media (max-width: 768px) {
            .tool-card {
                padding: 20px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .tool-icon {
                font-size: 2rem;
            }
            
            .tool-title {
                font-size: 1rem;
                word-wrap: break-word;
            }
            
            .tool-description {
                font-size: 0.8rem;
                word-wrap: break-word;
                line-height: 1.5;
            }
            
            .tool-action-btn {
                width: 100%;
                box-sizing: border-box;
                white-space: normal;
                word-wrap: break-word;
                padding: 10px 12px;
            }
        }

        /* ===== 5. NEWS CARDS & FILTERS ===== */
        @media (max-width: 768px) {
            .news-container {
                width: 100%;
                padding: 15px;
                box-sizing: border-box;
            }
            
            .news-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 0 10px;
            }
            
            .news-header h2 {
                font-size: 1.3rem;
                width: 100%;
            }
            
            .news-filters {
                flex-wrap: wrap;
                gap: 8px;
                padding: 0 10px;
            }
            
            .news-filter-btn {
                padding: 8px 12px !important;
                font-size: 0.8rem !important;
                white-space: nowrap;
                flex: 1 1 auto;
                min-width: 0;
            }
            
            /* News feed grid */
            #news-feed {
                grid-template-columns: 1fr !important;
                gap: 15px;
                padding: 15px;
            }
            
            /* News cards (if dynamically created) */
            .news-card {
                width: 100%;
                box-sizing: border-box;
                padding: 15px;
            }
        }

        /* ===== 6. MODAL FIXES ===== */
        @media (max-width: 768px) {
            .modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }
            
            .modal-content {
                width: 100% !important;
                max-width: 100% !important;
                padding: 20px 15px !important;
                max-height: 90vh !important;
                margin: 0;
                border-radius: 20px 20px 0 0;
                box-sizing: border-box;
            }
            
            .close-button {
                top: 10px;
                right: 15px;
                width: 36px;
                height: 36px;
                font-size: 28px;
            }
            
            .modal-content h2 {
                font-size: 1.3rem;
                word-wrap: break-word;
            }
            
            #event-modal-title {
                font-size: 1.2rem;
                word-wrap: break-word;
            }
            
            .event-actions,
            .day-actions {
                gap: 10px;
            }
            
            .event-actions button,
            .day-actions button {
                padding: 12px 15px;
                font-size: 0.9rem;
                white-space: normal;
                word-wrap: break-word;
                text-align: center;
            }
            
            .modal-pills-container {
                gap: 8px;
            }
            
            .modal-topic-pill {
                font-size: 0.85rem;
                padding: 7px 12px;
                white-space: normal;
                word-wrap: break-word;
            }
            
            #meetings-modal-list .meeting-item {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            #meetings-modal-list .meeting-title {
                font-size: 0.95rem;
                word-wrap: break-word;
            }
            
            #day-meetings-list {
                max-height: calc(90vh - 200px) !important;
                padding-right: 5px;
            }
        }

        /* ===== 7. AGENDA/CALENDAR FIXES ===== */
        @media (max-width: 768px) {
            .agenda-container {
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
                max-height: none;
                border-radius: 0;
                overflow: hidden;
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            .agenda-header {
                padding-bottom: 15px;
                margin-bottom: 15px;
                flex-shrink: 0;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .agenda-header h2 {
                font-size: 1.3rem;
                width: 100%;
                text-align: center;
            }
            
            .calendar-nav-container {
                width: 100%;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .nav-buttons-group {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .calendar-nav-btn {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            .view-toggle {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .view-toggle button,
            .mobile-view-btn {
                font-size: 0.85rem;
                padding: 8px 12px;
                min-width: 0;
                flex: 1 1 auto;
            }
        }

        /* ===== 8. SUMMARY SECTION ===== */
        @media (max-width: 768px) {
            .summary-section {
                display: none;
            }
        }

        /* ===== 9. PERSONA DISPLAY (Agent Selector) ===== */
        @media (max-width: 768px) {
            .persona-display {
                max-height: 50vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .agent-selection-list {
                max-height: calc(50vh - 150px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ===== 10. GENERAL LAYOUT FIXES ===== */
        @media (max-width: 768px) {
            /* All pages should be scrollable */
            #topics-page,
            #agenda-page,
            #tools-page,
            #news-page,
            #templates-page,
            .placeholder-page {
                padding: 0;
                width: 100%;
                box-sizing: border-box;
                overflow-y: auto;
                overflow-x: hidden;
                height: 100%;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Topics container */
            .topics-container {
                padding: 15px;
                grid-template-columns: 1fr;
                height: auto;
                width: 100%;
                box-sizing: border-box;
                gap: 15px;
            }
            
            /* Tools container */
            .tools-container {
                padding: 15px;
                grid-template-columns: 1fr;
                height: auto;
                width: 100%;
                box-sizing: border-box;
                gap: 15px;
            }
            
            /* Placeholder pages */
            .placeholder-page {
                padding: 30px 20px;
                text-align: center;
            }
            
            .placeholder-page h2 {
                font-size: 1.5rem;
                word-wrap: break-word;
            }
            
            .placeholder-page p {
                font-size: 1rem;
                word-wrap: break-word;
            }
        }

        /* ===== 11. VERY SMALL SCREENS (480px and below) ===== */
        @media (max-width: 480px) {
            .header {
                padding: 10px 12px;
            }
            
            .header-right .user-profile img {
                width: 30px;
                height: 30px;
            }
            
            .mobile-menu-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .nav-tabs button {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .topic-card {
                padding: 12px;
            }
            
            .topic-actions button {
                font-size: 0.75rem;
                padding: 8px 6px;
                min-height: 40px;
            }
            
            .chat-section-container {
                padding: 0.75rem;
            }
            
            .chat-input-area {
                padding: 12px 10px;
            }
            
            #chatInput {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            
            .chat-input-controls {
                gap: 6px;
            }
            
            .chat-input-controls button {
                width: 36px;
                height: 36px;
                font-size: 0.8rem;
            }
            
            .send-btn {
                width: 44px !important;
                height: 44px !important;
            }
            
            .message-bubble .content {
                max-width: 90%;
                padding: 10px 14px;
                font-size: 0.85rem;
            }
            
            .tool-card {
                padding: 15px;
            }
            
            .tool-icon {
                font-size: 1.8rem;
            }

            /* Meeting Columns - Very Small Screens */
            .meeting-columns-grid {
                gap: 12px;
            }
            .meeting-column {
                padding: 12px;
                border-radius: 12px;
            }
            .meeting-column-title {
                font-size: 0.85rem;
                margin-bottom: 8px;
            }
            .meeting-column-list {
                max-height: 35vh;
                gap: 10px;
            }
            #meetings-modal-list .meeting-item {
                padding: 14px;
            }
            #meetings-modal-list .meeting-title {
                font-size: 0.95rem;
            }
            
            .tool-title {
                font-size: 0.95rem;
            }
            
            .tool-description {
                font-size: 0.75rem;
            }
            
            .modal-content {
                padding: 15px 12px !important;
                max-height: 95vh !important;
            }
            
            .modal-content h2 {
                font-size: 1.2rem;
            }
            
            .agenda-header h2 {
                font-size: 1.2rem;
            }
            
            .calendar-nav-btn {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
            
            .view-toggle button,
            .mobile-view-btn {
                font-size: 0.8rem;
                padding: 6px 10px;
            }
            
            #mobile-month-grid .day-cell {
                width: 35px;
                height: 35px;
                font-size: 0.85rem;
            }
        }

        /* ===== 12. TABLET/LANDSCAPE ORIENTATION ===== */
        @media (min-width: 769px) and (max-width: 1024px) {
            .page-content {
                padding: 20px 25px;
            }
            
            .chat-section-container {
                padding: 30px 0px 0px 15px;
            }
            
            .persona-display {
                flex: 0 0 250px;
            }
            
            .topic-actions button {
                font-size: 0.8rem;
                padding: 9px 10px;
            }
            
            .tools-container {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        /* ===== 13. TEXT OVERFLOW FIXES (All Screens) ===== */
        /* Ensure all text elements can wrap */
        h1, h2, h3, h4, h5, h6,
        .topic-title,
        .tool-title,
        .event-title,
        .meeting-title,
        .agent-select-name,
        .single-agent-name {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        p, span, div,
        .topic-description,
        .tool-description,
        .event-details,
        .single-agent-description {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* ===== 14. FIX FOR FIXED POSITION ELEMENTS ===== */
        @media (max-width: 768px) {
            /* Ensure fixed elements don't cause horizontal scroll */
            .persona-display {
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
            }
            
            .nav-tabs-container {
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
            }
        }

        /* ===== 15. SCROLLBAR FIXES ===== */
        @media (max-width: 768px) {
            /* Ensure scrollbars don't take up space */
            .chat-messages,
            .agent-selection-list,
            #mobile-agenda-events,
            .modal-content {
                scrollbar-width: thin;
                scrollbar-color: var(--primary-blue) rgba(255, 255, 255, 0.1);
            }
            
            .chat-messages::-webkit-scrollbar,
            .agent-selection-list::-webkit-scrollbar,
            #mobile-agenda-events::-webkit-scrollbar {
                width: 6px;
            }
        }

        /* ===== 16. IMAGE RESPONSIVENESS ===== */
        img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }

        .agent-mini-avatar,
        .single-agent-avatar,
        .persona-option img {
            max-width: 100%;
            height: auto;
        }

        /* ===== 17. BUTTON TOUCH TARGETS ===== */
        @media (max-width: 768px) {
            /* Ensure all buttons are touch-friendly */
            button,
            .nav-tabs button,
            .topic-actions button,
            .tool-action-btn,
            .calendar-nav-btn,
            .mobile-view-btn,
            .close-button,
            .event-actions button,
            .day-actions button {
                min-height: 44px; /* iOS recommended minimum */
                min-width: 44px;
            }
            
            /* Small icon buttons exception */
            .calendar-nav-btn,
            .chat-input-controls button:not(.send-btn) {
                min-width: 36px;
                min-height: 36px;
            }
        }

        /* ===== 18. PREVENT HORIZONTAL SCROLL ===== */
        * {
            max-width: 100%;
        }

        body, html {
            overflow-x: hidden;
            width: 100%;
        }

        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            .main-container,
            .page-content,
            .chat-section-container,
            .agenda-container,
            .topics-container,
            .tools-container {
                overflow-x: hidden;
                max-width: 100vw;
            }
        }

        #chatInput {
            width: 100%;
            height: auto;
            max-height: 160px;
            resize: none;
            overflow-y: auto;
            line-height: 1.45;
            padding: 12px 14px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            scrollbar-width: thin;
            white-space: pre-wrap;
        }
		
		#chatMessages {
		    position: relative;
		    overflow: hidden;
		}
		
		#chatOverlay {
		    position: absolute;
		    inset: 0;
		    background: rgba(0,0,0,0.45);
		    opacity: 0;
		    visibility: hidden;
		    pointer-events: none;
		    transition: opacity .25s ease;
		    z-index: 10;
		}
		
		#chatOverlay.active {
		    opacity: 1;
		    visibility: visible;
		    pointer-events: auto;
		}



/* Focus Area Maximize Modal styles (agent-info style) */
#focus-area-maximize-modal .modal-backdrop { position: fixed; inset:0; background: rgba(223, 5, 5, 0.45); z-index:1000; }
#focus-area-maximize-modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1001; }
#focus-area-maximize-modal .modal-content.large-modal { width: 95%; max-width: 1100px; border-radius: 12px; background: #fff; box-shadow: 0 12px 40px rgba(0,0,0,0.25); }
#focus-area-maximize-modal .modal-body { padding: 22px; max-height: 85vh; overflow:auto; }
#focus-area-maximize-modal .agent-info-grid { display:flex; gap:20px; }
#focus-area-maximize-modal .agent-info-main { flex: 1 1 65%; min-width: 0; }
#focus-area-maximize-modal .agent-info-side { flex: 0 0 30%; background: #fafafa; padding: 12px; border-radius: 8px; border:1px solid #eee; max-height: 70vh; overflow:auto; }
#focus-area-maximize-modal .fa-section { margin-bottom: 14px; }
#focus-area-maximize-modal .fa-title { margin:0 0 8px 0; font-size:1.1rem; font-weight:700; }
#focus-area-maximize-modal .fa-kpis li, #focus-area-maximize-modal .fa-initiatives li, #focus-area-maximize-modal .fa-metrics li, #focus-area-maximize-modal .fa-attachments li, #focus-area-maximize-modal .fa-subareas li { margin-bottom:8px; }
#focus-area-maximize-modal .modal-close { position:absolute; right:12px; top:10px; background:transparent; border:none; font-size:22px; cursor:pointer; }
#focus-area-maximize-modal .modal-actions { display:flex; gap:8px; justify-content:flex-end; }
.more-details-btn { margin-left:10px; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; font-size:0.9rem; }
</style>
<style>.BDTLL_status {
    cursor: pointer;
    display: inline;
    margin-right: 3px;
    width: 16px;
    height: 16px;
}
/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8uL3BhZ2VzL2NvbXBvbmVudHMvdG9vbHRpcC5jc3MiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7SUFDSSxlQUFlO0lBQ2YsZUFBZTtJQUNmLGlCQUFpQjtJQUNqQixXQUFXO0lBQ1gsWUFBWTtBQUNoQiIsInNvdXJjZXNDb250ZW50IjpbIi5CRFRMTF9zdGF0dXMge1xuICAgIGN1cnNvcjogcG9pbnRlcjtcbiAgICBkaXNwbGF5OiBpbmxpbmU7XG4gICAgbWFyZ2luLXJpZ2h0OiAzcHg7XG4gICAgd2lkdGg6IDE2cHg7XG4gICAgaGVpZ2h0OiAxNnB4O1xufSJdLCJzb3VyY2VSb290IjoiIn0= */</style><style>.BDTLL_icon_ok {
    background-image: url(data:image/png;base64,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);
}

.BDTLL_icon_critical {
    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAABYCAYAAABxlTA0AAAAAXNSR0IArs4c6QAADbVJREFUeAHtXQtwVNUZ/s+9N5tNNiGbBPJqggEJD/HRGauIisZ3K2JEsVBtO7airR3bKbWd4mjbWKUqIxRaEZWKVquiCMUH2ioKTq22ndFxVNS8SEJCCJgXJNlkX/f0/+9yl7u79+7eTXZvskvOzM455z//eX337H/+c85/7mUwAtdbObtSlv01wPl8AFbGAcowXIpFZY+guDHPwhjzYPsPYl/wBx3A4GMmCS8XNNd9MtrGMbMF8Llzc7r7vT9lMl/KgZ9hNl8q8yHwzdj+bZmibU1Oy97OkfQlJsC8ulrqbWq/RQb4HXAoHkklqZ+HDTKBrSnIYg+xurr+ePoTFeCj02bN8vrkv3PO58RTaNryMjgkCuJ38lvrdpvto2DE2F0x+wqvz//fCXA1COE/WPbLb/ZUzLhNQ40a1AW4Z+rMW4H7dnIOeVFzn4CJOP9IModHuiuq/mim+xEigkauAi6AaKaAE5mHCbCicH/jumgYhAAckLkkFiZGbjTQ1DQEzw9MWljY9uU/VVq4HxQRpC0EJrQJcMNBMoqj/o//ct+WgWmnGmpXQYBJFZuY0IygNKbjv9057PP81ohDERHKIuKou/HE1XON4DFHZ8B8kk06JW/fFw3hOZQRTCu0CXDDoTEfJ83C6/XV6uVQAMbl7zK9xAlaHAhwqOGV1fbwHAJt3OATOD08YSIeLwLc0SsfuDQ8l6DsioVTJ+IjQgAHak14RiGw5RhOnoiPCAEOuH0b6lAGs7JQ0kRsFAhEYCkpm+WjKDEka1YWZCw4N4QUEsFFfEKczwv8aD/w/gHwH+gAcLkSUuxoC0GdOJ/X1gqsthZ3dwOOdVXMcKGKlqUSRuMzpxOcu3aCUFw0mmLiyouLI5CbW8D36V7wvLkLf28DDA/HVUYimQvzMjPZ3r0etUzWVT4jQcMqUKRQUgK5Tz4K0qlz1Tos9TmOZve2HeBasx54d4+ldVNlhVJ5FmvZE3zCwaVyoloid3bCkcXLwP2G4f5HoqrSLYdlZ4P9ezdA/ntvg/3mm3R5rCQmHGCl8fgXHbj1dnD9eaOVfQmpi+XkgKP2LnA8eB+AkJxuhlRoEElqzUOr14LrgYcMqraGbL9hKeSsfdCaynRqSSrAVN/QhsfA8xZOPGPoMq+7BmxXLxyTFiQdYOqV+6UdY9I5baWOVfcAOBxakiVhyYpa5MOHY1bj++QzGNq02ZgPz2eYLQNItgpFU0CcOQOkeWeBkJtrnEeTIjjzIHPhN8H94jYNNflBSwDmXm/MnsgHO8Gz49WYfCEMpDEsXQLZK+8A0h5iucwliy0H2BIREavjI05HnXf4yafhyNVLQO6PbQ8inf0NyzWK1Ab42JPx1zWA6977Yz4nJoooXqxbZVKD0gJg6oj7+a3ga2ikYFQnlJZETU90YtoATMD4P/s8Jj7MEVtWxywkDob0Anhfc8yuy719MXkSyZBWAAslhuYJCmbKztuBA4nEL2ZZaQWwNPeUqB32f1kHvO9IVJ5EJ6YNwBkLzgPxjNOi4uN59fWo6clITAuAWX4+ONY8AGiRbogRHxyE4WeeN0xPVkLKA5xx/rmQ98YOEGOoX4O/vx/Fg7UTHD00S5bKpkZHdhYIJ02Nysqy7IG9iOJikE47BTIurgZpzuyoeShx6PHN4H7uhZh8yWAYNwDbUIba8BQikY7LMrhq78Pl9DOJLDaussYNwHG12gSzv2kfkFjwvrPHBHfyWNIOYO/7/1FEgvft3clDLY6SU36S0/aVDwwAbXuKKMuFinJt0piF0wpg2oyn4yHHPXeD89/vwKQtT4P09bG9M5lWAGuHKenEGefNh0mvbAXHqlrUl8ZGGqYtwCrYBLT9+zfCpOeewpvU1u6kURvG5rGqvdf4/uYWcO/8h4YSGaQNc7CjLoz6sFBWCuLUChArT4pk1KFkzJ8HuQ+vhf6b8Q4hmltZ5cYPwPWNMPTgmrj7zSYXgu2iC8F+yw9x0TEran7bZZcg3w9gGBceVrmUFxG8qxvcW7fDkcuvAhcautCWZDSX9fPbgRUWRGNJaFrKA6xFYwhNtYY3btKSIsJ0zG+/cVkEPVmEtAKYQHKtXQ8y2g5Hc6TKGToGw/SeCNyXex9fzPERhg/gL2iOapjPIGHcyGCD9sVPdnvAu/tdyKy5yjCvOH0aMDRe4Ye/QgN/+BDvub0sMvF1JovNeW17dW1e+08+vcjjdVfjyd9lIMNlKIhMza7pBzDC6jdxNmdfXPPE8FN/u6ew6bM2wyehScht+uQwRl889oOeipkLUN6vxIsvV2rYIoJpJyKoh3S9wMjhtYN+6OtbkX33r28zC65eWQVt9f8qbG9YKICEV+DYa3o8REvLEWxwhYHLfX2bBafzZyhTXXqA7IOiYhnEcryUQC96KmXAXSg+OkQQOyQQWiugfSg8X0H7l58ibVF3+YybObB14elpCbA4rTKkn3x42I2gLhLz898KScBIE5ScJQO/BgGtwas1c+kNBapDGjqOFB94gQ3VQ/EunPx2OEB8pQw6ulQ+8gvbG5/omzpzN1Qic8vxlLQDmCavjIsuON5Dj3eQ2e0XIsAfHicCNEDRfBlgtQ/k87V0ozDKWrootAhBX4R3m4bqoHi9BI4HToZ9wWNq5/76fbC/PqSItJPB2b9agWautkAn3Z4BsGWcrwW3A8om10PRSwju+8hkCtwQxDASAJuv9MFgUwMULw9P18bTB2C8h5F95y/Bvux6pX94ijwEmbZzEdyP1Q43QvGp/eD/H47C61Ta6HxeiOJlUz2UbORwZoZeWakPMG5DZlx6MeTt3A5ZP/mR2kfOJKkGwaUJSHENUHqFH/gHOP6mqbRE+Tgp/rgB2t88DHNzwsscNzKY5TsVi/XwBmrjDG+SsrxJwHC5K0yZDGTJI519JghoF6F1cnf3Y+LkycEJjUauH/wvIU8EANp8owmj2Kjuha5n0L8WNY/A/IgFJvwiol4jyeLG+dp2vaSE01AH7meTcotx9CoqFclcEgvJGLl6jUdwV82EQ3eraakvItSeHPO517NSBZdIA+B7zCpwqT4cwXfVQ2lQjUkvgAcG+oTCQgQ04EgVw//qtWrcOl9erdaVVgDLLtdmHL3BlQLpuWpHrfRxFM9rgJIlVGdaAYz3L/6kAkkrNAyb0nOF/DwQy6LbFuOuG9jmVKnFx/QR5F8Qk4BPfMR7nTFrsZBB7unpwr60qlXS8lcNR/MJ3OmtHym/Sctv1GVluQ4of/dlqPz8PSh6+H5dnkgiP6cZKkvolTIHIxNTiyJ3HgI43LVF22qUvRHvz9Gmq2HFoJCMClGfLn58DYSDrID7xhbIXnCOkkUocKpZo/pYP47coUWsu7zqAxzOgdxRs4w8kc7AbFd9K3YBQe0xCive5OeD+A4RtPdFfRf3flsAMCwJWQXO/Z/2Uk7aFfMCmH5jNYFK4OI/QDnTO3TrHXD0L8+ivo0jF8HNOu9spUGe+iZou2gx+DvwgZpy7AVaaOA7WZLr6MUY7r8+m7xK8JhHBZcq4SBWaHfFYlVMYJJTQSZfQHPa3G/XjAJcKpFXSPRCeGzRGKgy1IDEOFTuQ8ScjPu58ZYcDnLR+lXBIuIfuWpWVirQ2/bVaMr6YfMISpqSkfSFQP5qxW9Csvo6OuMUC8ezo+JRKtCnDFD2NB8np16Io3WUttV0EqGNmw2TzM29/uoQdrG0GBxXXhpCMxvBB+1S9WBr7/ibbaFJPhQRIUosxuOeV8InNBq5ZMRCE5+edmGmaTiCOxSA6TsRqFUMmsk0TnmmaNslgxAik7VpeuFwcEnmtp51OZA2MTqQeQBg+ggHfSdCr/JUoCEINrJbUNuaBWILjuKIA0o1PcTHYfa1157V1RZIJoeDnHP9opDs0SPsC1VEAH2EAzUKswpe9HLHIDVgFBKo+Njp7y4zzbDNroLsC+YrrHraQjjIecu/a6ZYhQdtQV8NAkxfOKGPcOCT95kuYVwxosWNxuHA3KGJGgY9+NLqvg2b4ejz2w21BQL54NJbYPCtPdD70COGZWkTsP6+6TDnXfRDHX2Eg74TEUod/zHsSCsenVeqLaWNdjz93Y+r1CyVZq3PnpgFh5YHR7BaeUFb40acOdep8VTxUSU6icyZ1PaS3QLS1qtxK32UAu4MEO6lOiMAJmJhW8MK+ggHjgo/xVPFka2Ytq1kt4DaUbeWZkUYlbsN0+FgK9WlCzAlKF84wY9woBrYR/FUcCgOruwpn32a2tZjRiF3qnErfByU7dkgBdfZhgBTY+gLJ5mSfTYw4ZFUmfxk8P9BCyTKwU0MhEe1tGSFSTVkINWgFhM0gUXAzbkj0+dUKZ8ywLft4y6R9a/QM9dMhQs7tZxsxdQsZBRCdgs4wqtVWqJ9rBNX7MKyKuh8UVu2aYDVTPQpA3rbPufsGgCZ9pHLcEUZapigMo+ZzwYkUTjd2VoX3GMhoxCyW0AcsN2JdYGRy24KB5dqiRtgvabRa7Vh61YJBqdEFTl6eZNGQytHtmdPiE6PI5jhYeS96N+VqHoRwHYSC1XQ8ZFemQkBWK/g8UwL2C3IqxHoeSNtJ6lipC3QhKaVueHlnZAAqyDQ0TqCjKe//BzUmU1hgUx9COw20nNVVUwtT883VahexnSi0ekvHVBiny5BsCsQa7Ruh1IEHS3c6UiN4499QXsLgeVvqOiJhsX/AXdmYETVGEaQAAAAAElFTkSuQmCC);
}

.BDTLL_icon_alert {
    background-image: url(data:image/png;base64,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);
}

.BDTLL_icon_disabled {
    background-image: url(data:image/png;base64,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);
}

.BDTLL_icon_whitelisted {
    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFgAAABYCAYAAABxlTA0AAAAAXNSR0IArs4c6QAADkpJREFUeAHtXQt0VMUZ/ufuzWbzIo8NEmgCRENEQLAtAiGo+KqtiBHEI9WCtCgVtR5Fe8QjYghSkQMIbRWRggqtUgGLImIBBVtDfaD1ACkCgQTyAEISAkk2+7zT/9/lLnc3+7i72d1kl8w5e+b1zz8z3539559/Zu5lEIQ7239gf0myFQHnBQCsDwfog+HeyCoxCHadXoQxZsb2n8S+4A9qgcH3TBQ+yKg4tK+jjWNqGfDBg5Mbmi2/YxK/lwMfprZcNNMh8BXY/k3xGu2S5MqyU8H0xS/AfOxY8ezR6ockgBeAQ69gKon+MqyVCWxJRgJbzA4dag6kPz4BPp975ZUWq/QPzvlVgTCNWVoGpzWC5pfpxw/tUttHwRthQ87A2yxW21fd4CoQwn+wZJO2N+bkzVSk+gx6BLixb/4M4NatnEOqz9KXYCbOP6LE4bWGnAGvqOl+OxFBI9cOLoBGDYNLmYYJ8KT+RPkyXxi4AOyQuSQWukeuL9DkPATPBkwcp6/64Z9ymrvvFBGkLTgmtG5w3UHyFkf9H//l1vUtuUO8aldOgEkV657QvEHpPR3/7WlGq3muNwq7iLAvIs6byi9dPdcbPOrSGTCrqBUHpR47eMS9hH0E0wqtG1x3aNTHSbOwWKzFnkrYAcbl72RPmd1pASDAoYj3H6tzLyGQ4QafwFD3jO54oAjwpLNSzS3upQS7Vcw9tTseFAI4UIvcCwoOk6N7cnc8KAQ4oPnW1aEMZn1ck7pjHUCgHZai3VjeAY4uRRMSIO660S5JLhFcxIfEWS3AzzcDb24BW00tgMEQErYdZYI6cTovLhZYcTFadx2O1efkGVBFS5ATOuKztDRI27kVhF6XdYRNQGVxcQRSRSVY95eBeftO/H0KYDQGxCOUxPrU+HhWVmaWebL67LwQDSsHSyErC1LefB3EIYPlOiLqcxzNpk2bwbBkOfCGxojWTZXpxewEVrnb+YSdS+VQtUQ6dQrOTZgMpm1e7R+hqsojH5aYCLop90H6F5+Cbvo0jzSRTAw5wPbG41+0ZcZjYPjTikj2xaUulpwMScXPQdLLLwII4emmS4VeImGtuW3RUjAsXOyl6sgk6+67F5KXvhyZyjzUElaAqb62V1eCeQdOPJ3o4u++C7R3juuUFoQdYOqVaePmTumcstKkBfMAkpKUSREJi5GoRaqr81uNdd8BaFu1xjsd7s8wbRyQbBUu6wma/DwQR14LQkqK9zKKHCEtFeLH/RxM721SpIY/GBGAucXityfSyVNg3rzFL50LAWkM906CxNlPAWkP/lz8pAkRBzgiIsJfx4POR53X+OZaOHfnJJCa/Z8HEUcMj7hGEd0AX3gytkNHwDD/Jb/PiWk0KF4it8qkBsUEwNQR07sbwHqknII+ndA7y2d+qDNjBmACxnbgf37xYUn+ZbVfJgEQxBbAxyr8dl062+SXJpQEMQWwkOX1eIIdM7vlraYmlPj55RVTAIuDB/nssO2HQ8CbzvmkCXVmzAAcd10haIZd7RMf85aPfeaHIzMmAGbp6ZC0ZCHgiXSvGPHWVjCue9drfrgyoh7guDGjIXXbZtD4Ub9aS15C8RDZCY4eWkSWyqpGR2ICCP36+iRlCTqHLaJXLxCvHgRxN40F8aqBPstQZtsba8D0zt/90oWDoMsArEUZqsVdiFA6LklgKH4Rl9PrQsk2IF5dBuCAWq2C2Hb0GJBYsHy2WwV1+EhiDmDLni/tIsHy6a7woRYA56if5JR95S0tQGZPDcpyISdbmdVp4ZgCmIzxtD2UNG8OpJV+Bj3WrwXxms69MxlTACuHKenEcYUF0OPDDZC0oBj1pc6RhjELsAw2Aa2bej/0eOctvEkdWUsataFzHqvce4Vvq6gE09ZPFCntg2QwBx3qwqgPC316g6ZvDmj692tP6CElrmAkpPx5KTRPxzuEeNwqUq7rAHy4HNpeXhJwv1mmHrQ33gC6h36Di44rfZbX3noz0v0ajLjwiJSLehHB6xvAtOF9OPezO8CAB13IJOnLJTzxGDB9hi+SkOZFPcBKNNrwqJZxxSplUrswbfPr7p/cLj1cCTEFMIFkWLocJDw77MuRKufVMTDSeyLQLrcHX8zxHYZr8Oc8juq1nJeMLiODvbQv8GSTGSy7Pof4oju8ltVcngsMD6/wujN4wB++xXtuH2iY5mMmaSpSq8o8nnltvmLoZWaLaSzu/N0KEtyKgkjV7Bp7ACOsNhV7c7oJRauNb/11nv7ogSqvT0KRkXJ0Xx1G37vwg8ac/OtQ3s/Giy+3K8jaBWNORFAP6XqBN4fXDpqhqenJxDnPzFQLrideGVWH/62vPjJOABGvwLGPPNFQWkyOYC9XGLjU1LRGSEt7HGWqwRMgCx78spfNAtmc8T6MXvLEuYFpoFbDWa0uHY7PemV0m3u5jOof9mPa+IbsvOkc2DL3/JgEWJPb36Wf3Gg0IajjNenpO1wyMFIyrfRalKk46/Eiq8k6WM6XlT1uBczmYK1nbSVTvtgJTNicqNN++PQbw+tlWvL11eWrm/rm74L+YIXKizkxBzBNXnE3Xn+xh2ZLK9PpbkCAv72YiMBOLS1A+bmI2/gYZbq3MNLSRaHxwKXxhjZTW8nUL5ZrdbqFs98Y7tymTjtx+BicOOzCIuZkcOLvn8RjrlpHJ03mFtDGjVGCu3jG3sySKaUbcYLagwNTFbguiGGEwMb1zGyz0XQUgX7QPV8Zjx2A8R5G4rNPg27yPfb+4S5yG8RrRyO438sdXjC9dIihzfg1AnS3nNYRHx+SHoFeVfLAnhUrZ+yN88Qr+gFGM2TcLTdB6tb3IeGR38p95EwUixBcmoDsbt6UPbdZzfw/KFtz5bRQ+bj39/DpNuP2Vx8pS3bn2WVkMEtPs59Yd2+gMs7wJilL7QEMl7tCz0ygkzziiJ+CgOcilE5qaFipycx0Tmg0cq1maSPStANAWa4jYXxwYxuam9bhqJ6ID1aeIyHkFxE9NZJO3KR99L6nrJCnoQ7czHqk9MJO2lUqkrkOsRD6keux8QJb8MLbhXPkvOgXEXJPLvjcYp4tg0tJBqNxZTjEglu1F6MSf+7FB0qdakxsAdzS0iTo9Svl3tpVMQ4T5bhaX6vTQM8fJYC+dwKI2sAhkiS+SK6ry8hguUEd8SWDYY0mJcUm8yA9Vw6r8bP6JcFN9/SDK4ak4XoC7WnorBYJDv+3EXasr4Rz9SY1bFCNg5Hzp5ZOen5t4cbAH4+qKjqHCO9f/FGu2b5CC0DPzf9xBkx/YSjkDU13gku8xDgBBo3IhBklw0CfRWsNdQ5BnkWUAsqroG2d6qqKDJXU2FiPfTnurM2+/HXGfAZ0iRqY8PAA0Ij0AhgO29Ydg0Uzv4JlT3wD+0rr7GUTkuPgtl8FoOFxGLVo2tdZxPGkz9qjIFM6dRqgrn69a1Pbvz/HNf9ibOBwPcQnOKTlvtIz8M2Ok2BstcL5RjN8+JdyMBrQIIEud1AqHpG9WM5XCMUTM9ks45ErvVab9/NF3NE8qboGWuYU+2eD/yu/Dm/y81Z8hwie90V9F22/lQAYFoWEuXJZsoopDTdyujef5Cw5nJxgz9bqdmQyqBYzmX3UO4nBzfTY8J0s4XX0YgzT238LXyW4zZN2Yv9ZuQJusubIYTV+2Zf1+EfGF6XgqD1T42qR/MWUy52j+1hZExki1DsOOSK9EB4LBazKqK8l/JS45eMi5riAL+13DEpVlRO4BLLS0ai986EBMGyM4+JiS5MZPll7TEniN8yA9xbobft+Kbs6gds8wkHI6miTJ87Md4LbdMYIby3YDy3nLAGx5Qx6C/QpA5x9KwIq2cWIsSOurzTEnYiONHHQCD0MHtXTzuJMjQHWlOyDxtPGIFgyg6wHR/aOfxBN9VUERYTLBTna5vFF7y9vwDUZdhKOk976Vw4GPHKd/DnU2gGm70SgNtHqzIi+gGO4ye22Ci4yWU5W62tEhy5WW9ECZ+uCGbmOmlCOOwCmj3DQdyLUNqCr0eHiQEvnFuR2JWXyShzVruqAnKnC/9fmKvhqey1sC3BSc2eNc+dBWUQAfYQDNQrU2KPTOQ6FONru2P3lO4PtScOpNrv9ofF00M/IUTVjW5wA0xdO6CMc+OQdy5ZgW9dp5fDEjdLh7q8yGkh44sP5MOWZIfDoop/g8lnl0s29AgZN1+cWfO4EmPLpCydojH/cnTYq4nicSdlO2loPVkxk5/WwsyL7A/2Cchw23VjMrC4AE6OMqvIVqLYtC4ppJxZCedePjjPJTbCfW2B8uRwPxP9g1RE4uLfBLoNpgRGow8nNpNGy+VTO6/hv6Jv3BK6GFmPD8Vh5dDgcsR/TcSa5tQtn7E2lrXXa/ZXTIuHjAF06d23hU1RXuxEsN8D+hRP8CAc+DVyAR4dDC9btjdkDr5ZbS4dCcPvxWTkeGZ9VJ8exBXJdXgEmAvrCSbyoG4gW6NeiZfKTwPYHuXPkP7+ucBUThNeVaeEKk8wXRaFo1urRjXIdPgEmouSKA6czqw4/St+JQGPoO11/QcLvoIN4cgfJ7xWvfRxl4W5lWqjDCC6aQIRpz71Z8J2St1cZrCRShulTBvS2fc7ZXWhBHYV5fdAa5XowQVmgU8KsRdQIQ9OOH3LaWOhQiP3cAnBsd2gdjVwCd+7bBe+5cw4YYHcGFKfXasOGDSK09vT7j/BUPixpeMqR7d7totPjZMdKpu2ZD7i1Hro6WTWJBfeRK/MPCcAys2jx6dwCba2jhjQy2DaTKobi8lWa0JQy153fJQmwDAJtrSPIs3DDYRTtocnpPn3SqnARQXrunNWFx33SYqY6pv64RHk+7f7SBiXtoSF4ObQTQcZyhIc+IFBLVjF8EAdxkt9Cy19aoant8v8BLLyge+RFsdcAAAAASUVORK5CYII=);
}

.BDTLL_Search_Popup {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', system-ui;

	position: absolute !important;
	min-height: 70px !important;

	border-style: solid !important;
	border-width: 1px !important;
	border-radius: 5px !important;

	overflow: hidden !important;
	z-index: 999999999999999 !important;

    background-color: rgb(255, 255, 255) !important;
    border-color: rgba(100, 100, 100, 0.9) !important;
}

.BDTLL_Search_Popup > .BDTLL_left_box {
	position: absolute !important;
	top: 0px !important;
	height: auto !important;
	bottom: 0px !important;

	left: 0px !important;
	width: 92px !important;

	background-size: 50px 50px !important;
	background-repeat: no-repeat !important;
	background-position: center !important;

    background-color: rgb(240, 242, 246) !important;
}

.BDTLL_Search_Popup > .BDTLL_right_box {
	display: inline-block !important;
	margin-left: 92px !important;
	width: 210pt !important;

	box-sizing: border-box !important;
	padding-left: 10px !important;
    padding-right: 5px !important;
}

.BDTLL_Search_Popup p {
    white-space: pre-wrap !important;
    word-wrap: normal !important;
    margin: 0px !important;
    padding: 0px !important;
    text-align: left;
}

.BDTLL_Search_Popup .BDTLL_title {
	font-size: 16px !important;
	margin-top: 12px !important;
}

.BDTLL_Search_Popup .BDTLL_description {
	font-size: 12px !important;
	margin-top: 5px !important;
}

.BDTLL_Search_Popup .BDTLL_web_protection {
	font-size: 11px !important;
	margin-top: 15px !important;
	margin-bottom: 10px !important;
}

.BDTLL_Search_Popup .BDTLL_strong {
    color: rgb(7, 20, 45) !important;
}

.BDTLL_Search_Popup .BDTLL_mild {
    color: rgb(81, 91, 109) !important;
}

@media (prefers-color-scheme: dark) {
    .BDTLL_Search_Popup {
        background-color: rgb(56, 67, 87) !important;
        border-color: rgba(169, 169, 169, 0.9) !important;
    }

    .BDTLL_Search_Popup > .BDTLL_left_box {
        background-color: rgb(7, 20, 45) !important;
    }

    .BDTLL_Search_Popup .BDTLL_strong {
        color: rgb(239, 241, 249) !important;
    }
    
    .BDTLL_Search_Popup .BDTLL_mild {
        color: rgb(217, 217, 217) !important;
    }
}

/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8uL3BhZ2VzL2FuYWx5emVyUG9wdXAvYW5hbHl6ZXJQYWdlU3RhdHVzLmNzcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtJQUNJLHlEQUFnRDtBQUNwRDs7QUFFQTtJQUNJLHlEQUFzRDtBQUMxRDs7QUFFQTtJQUNJLHlEQUFtRDtBQUN2RDs7QUFFQTtJQUNJLHlEQUFzRDtBQUMxRDs7QUFFQTtJQUNJLHlEQUF5RDtBQUM3RDs7QUFFQTtJQUNJLCtFQUErRTs7Q0FFbEYsNkJBQTZCO0NBQzdCLDJCQUEyQjs7Q0FFM0IsOEJBQThCO0NBQzlCLDRCQUE0QjtDQUM1Qiw2QkFBNkI7O0NBRTdCLDJCQUEyQjtDQUMzQixtQ0FBbUM7O0lBRWhDLCtDQUErQztJQUMvQyxpREFBaUQ7QUFDckQ7O0FBRUE7Q0FDQyw2QkFBNkI7Q0FDN0IsbUJBQW1CO0NBQ25CLHVCQUF1QjtDQUN2QixzQkFBc0I7O0NBRXRCLG9CQUFvQjtDQUNwQixzQkFBc0I7O0NBRXRCLHFDQUFxQztDQUNyQyx1Q0FBdUM7Q0FDdkMsc0NBQXNDOztJQUVuQywrQ0FBK0M7QUFDbkQ7O0FBRUE7Q0FDQyxnQ0FBZ0M7Q0FDaEMsNEJBQTRCO0NBQzVCLHVCQUF1Qjs7Q0FFdkIsaUNBQWlDO0NBQ2pDLDZCQUE2QjtJQUMxQiw2QkFBNkI7QUFDakM7O0FBRUE7SUFDSSxnQ0FBZ0M7SUFDaEMsNEJBQTRCO0lBQzVCLHNCQUFzQjtJQUN0Qix1QkFBdUI7SUFDdkIsZ0JBQWdCO0FBQ3BCOztBQUVBO0NBQ0MsMEJBQTBCO0NBQzFCLDJCQUEyQjtBQUM1Qjs7QUFFQTtDQUNDLDBCQUEwQjtDQUMxQiwwQkFBMEI7QUFDM0I7O0FBRUE7Q0FDQywwQkFBMEI7Q0FDMUIsMkJBQTJCO0NBQzNCLDhCQUE4QjtBQUMvQjs7QUFFQTtJQUNJLGdDQUFnQztBQUNwQzs7QUFFQTtJQUNJLGtDQUFrQztBQUN0Qzs7QUFFQTtJQUNJO1FBQ0ksNENBQTRDO1FBQzVDLGlEQUFpRDtJQUNyRDs7SUFFQTtRQUNJLDJDQUEyQztJQUMvQzs7SUFFQTtRQUNJLG9DQUFvQztJQUN4Qzs7SUFFQTtRQUNJLG9DQUFvQztJQUN4QztBQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLkJEVExMX2ljb25fb2sge1xuICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi8uLi9pbWcvYW5hbHl6ZXJfb2sucG5nKTtcbn1cblxuLkJEVExMX2ljb25fY3JpdGljYWwge1xuICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi8uLi9pbWcvYW5hbHl6ZXJfY3JpdGljYWwucG5nKTtcbn1cblxuLkJEVExMX2ljb25fYWxlcnQge1xuICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi8uLi9pbWcvYW5hbHl6ZXJfYWxlcnQucG5nKTtcbn1cblxuLkJEVExMX2ljb25fZGlzYWJsZWQge1xuICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi8uLi9pbWcvYW5hbHl6ZXJfZGlzYWJsZWQucG5nKTtcbn1cblxuLkJEVExMX2ljb25fd2hpdGVsaXN0ZWQge1xuICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi8uLi9pbWcvYW5hbHl6ZXJfd2hpdGVsaXN0ZWQucG5nKTtcbn1cblxuLkJEVExMX1NlYXJjaF9Qb3B1cCB7XG4gICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgJ1JvYm90bycsIHN5c3RlbS11aTtcblxuXHRwb3NpdGlvbjogYWJzb2x1dGUgIWltcG9ydGFudDtcblx0bWluLWhlaWdodDogNzBweCAhaW1wb3J0YW50O1xuXG5cdGJvcmRlci1zdHlsZTogc29saWQgIWltcG9ydGFudDtcblx0Ym9yZGVyLXdpZHRoOiAxcHggIWltcG9ydGFudDtcblx0Ym9yZGVyLXJhZGl1czogNXB4ICFpbXBvcnRhbnQ7XG5cblx0b3ZlcmZsb3c6IGhpZGRlbiAhaW1wb3J0YW50O1xuXHR6LWluZGV4OiA5OTk5OTk5OTk5OTk5OTkgIWltcG9ydGFudDtcblxuICAgIGJhY2tncm91bmQtY29sb3I6IHJnYigyNTUsIDI1NSwgMjU1KSAhaW1wb3J0YW50O1xuICAgIGJvcmRlci1jb2xvcjogcmdiYSgxMDAsIDEwMCwgMTAwLCAwLjkpICFpbXBvcnRhbnQ7XG59XG5cbi5CRFRMTF9TZWFyY2hfUG9wdXAgPiAuQkRUTExfbGVmdF9ib3gge1xuXHRwb3NpdGlvbjogYWJzb2x1dGUgIWltcG9ydGFudDtcblx0dG9wOiAwcHggIWltcG9ydGFudDtcblx0aGVpZ2h0OiBhdXRvICFpbXBvcnRhbnQ7XG5cdGJvdHRvbTogMHB4ICFpbXBvcnRhbnQ7XG5cblx0bGVmdDogMHB4ICFpbXBvcnRhbnQ7XG5cdHdpZHRoOiA5MnB4ICFpbXBvcnRhbnQ7XG5cblx0YmFja2dyb3VuZC1zaXplOiA1MHB4IDUwcHggIWltcG9ydGFudDtcblx0YmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdCAhaW1wb3J0YW50O1xuXHRiYWNrZ3JvdW5kLXBvc2l0aW9uOiBjZW50ZXIgIWltcG9ydGFudDtcblxuICAgIGJhY2tncm91bmQtY29sb3I6IHJnYigyNDAsIDI0MiwgMjQ2KSAhaW1wb3J0YW50O1xufVxuXG4uQkRUTExfU2VhcmNoX1BvcHVwID4gLkJEVExMX3JpZ2h0X2JveCB7XG5cdGRpc3BsYXk6IGlubGluZS1ibG9jayAhaW1wb3J0YW50O1xuXHRtYXJnaW4tbGVmdDogOTJweCAhaW1wb3J0YW50O1xuXHR3aWR0aDogMjEwcHQgIWltcG9ydGFudDtcblxuXHRib3gtc2l6aW5nOiBib3JkZXItYm94ICFpbXBvcnRhbnQ7XG5cdHBhZGRpbmctbGVmdDogMTBweCAhaW1wb3J0YW50O1xuICAgIHBhZGRpbmctcmlnaHQ6IDVweCAhaW1wb3J0YW50O1xufVxuXG4uQkRUTExfU2VhcmNoX1BvcHVwIHAge1xuICAgIHdoaXRlLXNwYWNlOiBwcmUtd3JhcCAhaW1wb3J0YW50O1xuICAgIHdvcmQtd3JhcDogbm9ybWFsICFpbXBvcnRhbnQ7XG4gICAgbWFyZ2luOiAwcHggIWltcG9ydGFudDtcbiAgICBwYWRkaW5nOiAwcHggIWltcG9ydGFudDtcbiAgICB0ZXh0LWFsaWduOiBsZWZ0O1xufVxuXG4uQkRUTExfU2VhcmNoX1BvcHVwIC5CRFRMTF90aXRsZSB7XG5cdGZvbnQtc2l6ZTogMTZweCAhaW1wb3J0YW50O1xuXHRtYXJnaW4tdG9wOiAxMnB4ICFpbXBvcnRhbnQ7XG59XG5cbi5CRFRMTF9TZWFyY2hfUG9wdXAgLkJEVExMX2Rlc2NyaXB0aW9uIHtcblx0Zm9udC1zaXplOiAxMnB4ICFpbXBvcnRhbnQ7XG5cdG1hcmdpbi10b3A6IDVweCAhaW1wb3J0YW50O1xufVxuXG4uQkRUTExfU2VhcmNoX1BvcHVwIC5CRFRMTF93ZWJfcHJvdGVjdGlvbiB7XG5cdGZvbnQtc2l6ZTogMTFweCAhaW1wb3J0YW50O1xuXHRtYXJnaW4tdG9wOiAxNXB4ICFpbXBvcnRhbnQ7XG5cdG1hcmdpbi1ib3R0b206IDEwcHggIWltcG9ydGFudDtcbn1cblxuLkJEVExMX1NlYXJjaF9Qb3B1cCAuQkRUTExfc3Ryb25nIHtcbiAgICBjb2xvcjogcmdiKDcsIDIwLCA0NSkgIWltcG9ydGFudDtcbn1cblxuLkJEVExMX1NlYXJjaF9Qb3B1cCAuQkRUTExfbWlsZCB7XG4gICAgY29sb3I6IHJnYig4MSwgOTEsIDEwOSkgIWltcG9ydGFudDtcbn1cblxuQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykge1xuICAgIC5CRFRMTF9TZWFyY2hfUG9wdXAge1xuICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2IoNTYsIDY3LCA4NykgIWltcG9ydGFudDtcbiAgICAgICAgYm9yZGVyLWNvbG9yOiByZ2JhKDE2OSwgMTY5LCAxNjksIDAuOSkgIWltcG9ydGFudDtcbiAgICB9XG5cbiAgICAuQkRUTExfU2VhcmNoX1BvcHVwID4gLkJEVExMX2xlZnRfYm94IHtcbiAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogcmdiKDcsIDIwLCA0NSkgIWltcG9ydGFudDtcbiAgICB9XG5cbiAgICAuQkRUTExfU2VhcmNoX1BvcHVwIC5CRFRMTF9zdHJvbmcge1xuICAgICAgICBjb2xvcjogcmdiKDIzOSwgMjQxLCAyNDkpICFpbXBvcnRhbnQ7XG4gICAgfVxuICAgIFxuICAgIC5CRFRMTF9TZWFyY2hfUG9wdXAgLkJEVExMX21pbGQge1xuICAgICAgICBjb2xvcjogcmdiKDIxNywgMjE3LCAyMTcpICFpbXBvcnRhbnQ7XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ== */</style></head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo-container">
  <img 
    src="logo.jpg"
    alt="Logo"
  />
</div>

            <span>AI Executive Office</span>
        </div>
        <div class="header-right">
            <div class="user-profile">
                <span class="welcome-text">Welcome Your Excellency</span>
                <!--img src="https://pbs.twimg.com/profile_images/1902451967101636610/TQ-VQEPY_400x400.jpg" alt="User Avatar"-->
            	  <img 
				    src="userimage.png"
				    alt="Logo"
				  />
			</div>
            <button class="mobile-menu-btn"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="nav-tabs-container">
        <nav class="nav-tabs">
            <button class="nav-button active" data-target="agent-page"><i class="fas fa-robot"></i> AEO Agent</button>
            <button class="nav-button" data-target="topics-page"><i class="fas fa-th-large"></i> Focus Areas</button>
			<button class="nav-button" data-target="templates-page"><i class="fas fa-file-alt"></i> Templates</button>
            <button class="nav-button" data-target="agenda-page"><i class="fas fa-calendar-alt"></i> Agenda</button>
            <button class="nav-button" data-target="tools-page"><i class="fas fa-cogs"></i> AI Tools</button>
            <button class="nav-button" data-target="news-page"><i class="fas fa-newspaper"></i> News</button>
            <!--button class="nav-button" data-target="mandate-page"><i class="fas fa-th-large"></i> Mandate</button> -->
        </nav>
    </div>

    <!-- Main Content Container -->
    <div class="main-container">
        <!-- Agent Chat Page -->
        <main id="agent-page" class="page-content active">
            <section class="chat-section-container">
                <!-- Multi-Agent Selection Panel (Desktop) -->
                <div class="persona-display">
                    <!-- Mode Toggle -->
                    <div class="mode-toggle-container">
                        <span id="modeStatusLabel">Single Agent Mode</span>
                    </div>
                    
                    <!-- Single Agent Display (for single mode) -->
                    <div class="single-agent-display" id="singleAgentDisplay">
                        <img id="singleAgentAvatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=Hakim" alt="Agent Avatar" class="single-agent-avatar">
                        <div class="single-agent-info">
                            <div class="single-agent-name" id="singleAgentName">Hakim NÃ¼ruddin</div>
                            <div class="single-agent-title" id="singleAgentTitle">AI Executive Office Agent</div>
                            <div class="single-agent-description" id="singleAgentDescription">As your strategic partner, I provide high-level summaries, executive advice, and focus on strategic alignment for your key decisions.</div>
                        </div>
                    </div>
                    
                    <!-- Multi-Agent Content (for multi mode) -->
                    <div class="multi-agent-content" id="multiAgentContent">
                        <div class="multi-agent-header">
                            <h3 style="margin: 0 0 15px 0; color: var(--primary-blue);">
                                Active Agents
                                <span id="agentCountBadge" class="multi-agent-badge">1</span>
                            </h3>
                            <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 15px;">Select one or more agents to assist you</p>
                        </div>
                        
                        <!-- Agent Selection List -->
                        <div id="agentSelectionList" class="agent-selection-list"><div class="agent-select-item selected">
                        <input type="checkbox" class="agent-checkbox" id="agent-toggle-hakim" data-agent-id="hakim" checked="">
                        <label for="agent-toggle-hakim" class="agent-toggle">
                            <span class="agent-toggle-slider"></span>
                        </label>
                        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=Hakim" alt="Hakim NÃ¼ruddin" class="agent-mini-avatar">
                        <div class="agent-select-info">
                            <div class="agent-select-name">Hakim NÃ¼ruddin</div>
                            <div class="agent-select-title">AI Executive Office Agent</div>
                        </div>
                    </div><div class="agent-select-item ">
                        <input type="checkbox" class="agent-checkbox" id="agent-toggle-layla" data-agent-id="layla">
                        <label for="agent-toggle-layla" class="agent-toggle">
                            <span class="agent-toggle-slider"></span>
                        </label>
                        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=Layla" alt="Layla Al-Khaldi" class="agent-mini-avatar">
                        <div class="agent-select-info">
                            <div class="agent-select-name">Layla Al-Khaldi</div>
                            <div class="agent-select-title">Data Analytics Agent</div>
                        </div>
                    </div><div class="agent-select-item ">
                        <input type="checkbox" class="agent-checkbox" id="agent-toggle-omar" data-agent-id="omar">
                        <label for="agent-toggle-omar" class="agent-toggle">
                            <span class="agent-toggle-slider"></span>
                        </label>
                        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=Omar" alt="Omar Mansour" class="agent-mini-avatar">
                        <div class="agent-select-info">
                            <div class="agent-select-name">Omar Mansour</div>
                            <div class="agent-select-title">AI Coordinator</div>
                        </div>
                    </div></div>
                        
                    
                    </div>
                </div>
                <!-- Chat Interaction Area -->
                <div class="chat-interaction-area">
                    <button class="section-control-btn" id="centerSectionToggle" title="Maximize"
                        style="position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(20, 65, 90, 0.95), rgba(20, 130, 135, 0.95)); border: 2px solid #008a7e; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(20px); box-shadow: 0 4px 15px #008a7e; transition: all 0.3s ease;">
                        <i class="fas fa-expand" style="pointer-events: none;"></i>
                    </button>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message-bubble agent">
                            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=Hakim" alt="Agent Avatar" class="avatar" data-persona-avatar="">
                            <div class="content">Welcome Your Excellency. As-salÄmu 'alaykum. I am Hakim, your AI Executive Office Agent. How may I assist you today?</div>
                        </div>
                    <div class="message-bubble user"><div class="content">Can you dig deeper into the topic of "Empowering Society &amp; Individuals" for me? Provide key details and current status.</div><img src="userimage.jpg" alt="user Avatar" class="avatar"></div><div class="message-bubble agent"><img src="https://api.dicebear.com/7.x/bottts/svg?seed=Hakim" alt="agent Avatar" class="avatar" data-persona-avatar=""><div class="content"><span class="agent-name-tag">Hakim NÃ¼ruddin</span><div><p><strong>To Your Excellency,</strong></p>
<p>The topic of "Empowering Society &amp; Individuals" is a central axis of the National Transformation Program and HRSDâ€™s mandate. It moves beyond mere provision of services toward <em>sustainable enablement</em> and the cultivation of a productive, self-reliant citizenry.</p>
<p>Here is a strategic summary detailing the key focus areas and current status as of Q4 2025.</p>
<hr>
<h3>STRATEGIC SUMMARY: EMPOWERING SOCIETY &amp; INDIVIDUALS</h3>
<p><strong>Core Definition:</strong> Transitioning the population from reliance on social assistance to active economic participation, while ensuring a robust quality of life and strengthening community governance.</p>
<table>
<thead>
<tr>
<th align="left">Strategic Pillar</th>
<th align="left">Key Details &amp; Focus</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>1. Human Capital &amp; Skills</strong></td>
<td align="left"><strong>Focus:</strong> Future-proofing the workforce and ensuring a higher Saudi participation rate. Emphasis is on targeted vocational training, linking education outcomes to market demand, and private sector job creation programs (e.g., Nitaqat optimization).</td>
</tr>
<tr>
<td align="left"><strong>2. Social Safety Nets Transformation</strong></td>
<td align="left"><strong>Focus:</strong> Shifting social security from unconditional assistance to empowering, conditional support. Programs are now focused on targeted intervention for the most vulnerable, coupling financial aid with mandatory upskilling and job placement assistance (The <strong>Enablement Approach</strong>).</td>
</tr>
<tr>
<td align="left"><strong>3. Non-Profit Sector Efficiency</strong></td>
<td align="left"><strong>Focus:</strong> Increasing the Third Sectorâ€™s contribution to GDP and improving governance. Driving the digital transformation of non-profits to enhance transparency, optimize donation streams, and increase localized service delivery capacity.</td>
</tr>
</tbody></table>
<hr>
<h3>CURRENT STATUS &amp; METRICS (Q4 2025 Snapshot)</h3>
<p>The focus this quarter has been on the integration of enablement tools and measuring the exit velocity from dependency programs.</p>
<h4>1. Workforce Empowerment Metrics</h4>
<ul>
<li><strong>Nationalization Rate:</strong> The overarching Saudization rate is showing strong stability, with significant gains observed in high-value, specialized sectors (e.g., IT, Finance) due to targeted subsidies and training mandates. HRSDâ€™s focus is now moving from quantity of jobs to <strong>quality and salary levels</strong>.</li>
<li><strong>Unemployment:</strong> The national unemployment rate continues its downward trajectory, nearing pre-defined 2030 targets ahead of schedule. However, youth and female unemployment remain focus areas requiring bespoke, accelerated programs.</li>
</ul>
<h4>2. Social Program Integration</h4>
<ul>
<li><strong>Digital Profile Maturity:</strong> The unified digital platform for social benefits (linking data from the Ministry of Finance, HRSD, and other agencies) is highly operational. This integration is crucial for eliminating duplicate benefits and ensuring aid is strictly needs-based and conditional on participation in training/job search activities.</li>
<li><strong>Exit Velocity:</strong> Early data models show an encouraging increase in the rate at which beneficiaries successfully transition off social security support and into stable employment (the <strong>"Enablement Quotient"</strong>). This validates the shift to conditional aid.</li>
</ul>
<h4>3. Community Resilience</h4>
<ul>
<li><strong>Non-Profit Governance:</strong> Governance maturity scores for large-scale national charities have significantly improved due to stricter regulatory oversight and mandatory digital reporting standards. This enhances public trust and attracts investment.</li>
</ul>
<hr>
<h3>STRATEGIC INSIGHT</h3>
<p>The next phase requires moving from <em>program implementation</em> to <em>holistic ecosystem measurement</em>.</p>
<p>The primary risk is the potential for program overlap or lack of alignment between national training initiatives (Pillar 1) and social benefit conditioning (Pillar 2).</p>
<p><strong>Recommendation:</strong> We must prioritize the development of a unified <strong>Individual Empowerment Index (IEI)</strong>. This index will move beyond simple employment figures to measure the sustained financial independence, quality of life, and civic contribution of individuals leaving assistance programs, ensuring true, long-term empowerment rather than temporary relief.</p>
</div></div></div>
					<div id="chatOverlay" class="chat-overlay"></div>
					</div>
					
                    <div class="chat-input-area">
                        <textarea  id="chatInput" type="text" placeholder="Ask me anything... Type or Talk" rows="1"></textarea>
                        <div class="chat-input-controls">
                            <button id="agentSelectorBtn" class="" title="Select Agent">
                                <img src="https://api.dicebear.com/7.x/bottts/svg?seed=Hakim" alt="Agent">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button id="chat-action-btn" title="Discuss a Topic"><i class="fas fa-plus"></i></button>
                            <button id="upload-btn" title="Upload & Summarize Document"><i class="fas fa-paperclip"></i></button>
                            <input type="file" id="file-input" accept=".txt,.pdf,.doc,.docx,.md" style="display: none;">
                            <button id="mic-btn" title="Conversational Mode"><i class="fas fa-microphone"></i></button>
                            <!-- <button id="mic-btn">ðŸŽ¤</button><div id="chatMessages"></div> -->
                            <button id="send-btn" class="send-btn" title="Send Message"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Summary Section (Desktop) -->
            <section class="summary-section">
                <div class="summary-header">
                    <h3>Today's Agenda</h3>
                    <button id="copy-summary-btn" title="Copy Agenda"><i class="fas fa-copy"></i></button>
                </div>
                <div class="summary-content" id="summary-content"><h4>Today's Agenda</h4><p>No further meetings or milestones scheduled for today.</p><h4>Tomorrow's First Item: Community Empowerment Briefing (02:00 PM)</h4></div>
            </section>
        </main>

        <!-- Focus Areas Page -->
        <div id="topics-page" class="page-content">
            <div class="topics-container" style="width: 100%;">
                <!-- Topic Card 1 -->
                <div class="topic-card" data-topic-id="labor-market">
                    <div class="topic-icon"><i class="fas fa-briefcase"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Strengthening Labor Market</h3>
                        <p class="topic-description"
                        data-long-description="Strengthening the labor market focuses on creating a dynamic, competitive, and future-ready workforce that supports the Kingdomâ€™s economic transformation. This involves improving job readiness, enhancing employment mobility, and ensuring that both workers and employers thrive in a rapidly evolving landscape. The effort includes modernizing workforce regulations, enhancing the quality of employment opportunities, and ensuring that national talent is equipped with the skills needed for emerging sectors and high-growth industries. By advancing transparency, efficiency, and alignment across the labor ecosystem, this focus area contributes directly to higher productivity, stronger private-sector participation, and long-term national competitiveness.

                                                Key Aspects:
                                                â€¢ Modernizing labor policies and regulations to support emerging economic sectors.  
                                                â€¢ Enhancing job readiness and employability for youth and new graduates.  
                                                â€¢ Promoting workforce participation among women and underrepresented groups.  
                                                â€¢ Strengthening job-matching and mobility through digital platforms and national systems.  
                                                â€¢ Ensuring high workplace standards, safety, and compliance across all regions.
                                                ">
                                                Developing policies to create an attractive, inclusive, and safe labor market that empowers Saudi nationals and aligns with global standards.</p>
                    </div>
                    <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">4</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">7</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 2 -->
                <div class="topic-card" data-topic-id="empowerment">
                     <div class="topic-icon"><i class="fas fa-users"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Empowering Society &amp; Individuals</h3>
                        <p class="topic-description"
                        data-long-description="Empowering Society & Individuals aims to build a resilient, capable, and self-reliant population that actively contributes to national progress. This includes strengthening social services, enhancing family and community stability, and ensuring individuals have the tools and support needed to succeed across all stages of life. The focus area integrates social development programs, targeted interventions, and capability-building initiatives that improve well-being, foster inclusion, and enable upward mobility. By addressing both current and future social needs, this pillar reinforces national cohesion and promotes an environment where every individual and community can reach their full potential.

                                                Key Aspects:
                                                â€¢ Advancing social protection programs that promote independence and dignity.  
                                                â€¢ Strengthening family support systems and community-based development.  
                                                â€¢ Enhancing individual capabilities through targeted skill-building programs.  
                                                â€¢ Improving access to digital social services and integrated care pathways.  
                                                â€¢ Supporting vulnerable groups through well-coordinated, outcome-driven initiatives.">
                                                Enhancing social development, empowering individuals and communities, and promoting self-reliance through targeted programs and support.</p>
                    </div>
                     <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">5</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">9</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 3 -->
                <div class="topic-card" data-topic-id="non-profit">
                     <div class="topic-icon"><i class="fas fa-hand-holding-heart"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Enabling the Non-Profit Sector</h3>
                        <p class="topic-description"
                        data-long-description="Enabling the Non-Profit Sector focuses on developing a strong, high-impact ecosystem that contributes meaningfully to social and economic development. This includes improving governance, encouraging innovation, and building operational excellence across non-profit organizations. The effort also involves supporting sustainable funding models, strengthening leadership and talent pipelines, and expanding the sectorâ€™s ability to address national priorities. By enabling organizations to deliver measurable, evidence-based impact, this focus area ensures the sector becomes a key partner in national development.

                                                Key Aspects:
                                                â€¢ Enhancing governance standards and regulatory clarity across non-profits.  
                                                â€¢ Supporting sustainable financing models and diversified funding streams.  
                                                â€¢ Building leadership and organizational capabilities across the sector.  
                                                â€¢ Improving program quality, monitoring, and impact measurement.  
                                                â€¢ Expanding regional and specialized non-profit organizations aligned with national goals.">
                                                Fostering the growth and impact of the non-profit sector to expand its contribution to the economy and social development.</p>
                    </div>
                     <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">3</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">4</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 4 -->
                <div class="topic-card" data-topic-id="strategic-partnerships">
                     <div class="topic-icon"><i class="fas fa-handshake"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Strategic Partnerships</h3>
                        <p class="topic-description"
                        data-long-description="Strategic Partnerships focuses on developing meaningful collaborations with public, private, and non-profit entities to accelerate national objectives. This includes strengthening coordination mechanisms, aligning cross-sector priorities, and establishing partnerships that bring innovation, expertise, and resources to key areas. The pillar enhances the efficiency of collective action and expands the ministryâ€™s capacity to implement programs at scale. Through both national and international engagements, this focus area contributes to improved knowledge transfer, stronger service delivery, and broader national impact.

                                            Key Aspects:
                                            â€¢ Forming high-impact partnerships with public and private sector organizations.  
                                            â€¢ Expanding government-to-government and international cooperation networks.  
                                            â€¢ Strengthening alignment mechanisms for joint programs and shared priorities.  
                                            â€¢ Facilitating knowledge exchange and cross-sector innovation.  
                                            â€¢ Building scalable partnership models that accelerate strategic outcomes.">
                        Building effective and sustainable partnerships with public, private, and non-profit entities to achieve shared national goals.</p>
                    </div>
                     <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">2</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">6</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agenda Page -->
        <div id="agenda-page" class="page-content">
            <div class="agenda-container" style="width: 100%;">
                <!-- Desktop Calendar View -->
                <div class="desktop-calendar">
                    <div class="agenda-header">
                        <div class="calendar-nav-container">
                            <div class="nav-buttons-group">
                                <button class="calendar-nav-btn" id="prev-month-btn" title="Previous Month"><i class="fas fa-angle-double-left"></i></button>
                                <button class="calendar-nav-btn" id="prev-week-btn" title="Previous Week"><i class="fas fa-chevron-left"></i></button>
                            </div>
                            <h2 id="desktop-calendar-title">October 2025</h2>
                            <div class="nav-buttons-group">
                                <button class="calendar-nav-btn" id="next-week-btn" title="Next Week"><i class="fas fa-chevron-right"></i></button>
                                <button class="calendar-nav-btn" id="next-month-btn" title="Next Month"><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn" data-view="today">Today</button>
                            <button class="view-btn active" data-view="week">Week</button>
                            <button class="view-btn" data-view="month">Month</button>
                        </div>
                    </div>

                    <!-- Today View (Desktop) -->
                    <div id="today-view" class="agenda-view">
                        <div class="today-header">
                            <div class="today-date">Wednesday, October 22, 2025</div>
                        </div>
                        <div class="today-events-list" id="today-events-list"><p style="opacity: 0.7; text-align: center; padding: 20px;">No events scheduled for today.</p></div>
                    </div>

                    <!-- Week View (Desktop) -->
                    <div id="week-view" class="agenda-view active">
                        <div class="calendar-grid"></div>
                    </div>

                    <!-- Month View (Desktop) -->
                    <div id="month-view" class="agenda-view">
                        <div class="month-calendar-grid" id="month-calendar-grid"><div class="month-day-header ">Sun</div><div class="month-day-header ">Mon</div><div class="month-day-header ">Tue</div><div class="month-day-header ">Wed</div><div class="month-day-header ">Thu</div><div class="month-day-header weekend">Fri</div><div class="month-day-header weekend">Sat</div><div class="month-day-cell other-month"></div><div class="month-day-cell other-month"></div><div class="month-day-cell other-month"></div><div class="month-day-cell disabled-day" data-date="2025-10-01"><div class="month-day-number">1</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-02"><div class="month-day-number">2</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day weekend" data-date="2025-10-03"><div class="month-day-number">3</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day weekend" data-date="2025-10-04"><div class="month-day-number">4</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-05"><div class="month-day-number">5</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-06"><div class="month-day-number">6</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-07"><div class="month-day-number">7</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-08"><div class="month-day-number">8</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-09"><div class="month-day-number">9</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day weekend" data-date="2025-10-10"><div class="month-day-number">10</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day weekend" data-date="2025-10-11"><div class="month-day-number">11</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-12"><div class="month-day-number">12</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-13"><div class="month-day-number">13</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-14"><div class="month-day-number">14</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-15"><div class="month-day-number">15</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-16"><div class="month-day-number">16</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day weekend" data-date="2025-10-17"><div class="month-day-number">17</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day weekend" data-date="2025-10-18"><div class="month-day-number">18</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-19"><div class="month-day-number">19</div><div class="month-day-events"></div></div><div class="month-day-cell disabled-day" data-date="2025-10-20"><div class="month-day-number">20</div><div class="month-day-events"><div class="month-event-dot "></div><div class="month-event-dot milestone"></div></div></div><div class="month-day-cell disabled-day" data-date="2025-10-21"><div class="month-day-number">21</div><div class="month-day-events"><div class="month-event-dot "></div></div></div><div class="month-day-cell today" data-date="2025-10-22"><div class="month-day-number">22</div><div class="month-day-events"></div></div><div class="month-day-cell" data-date="2025-10-23"><div class="month-day-number">23</div><div class="month-day-events"><div class="month-event-dot "></div></div></div><div class="month-day-cell weekend" data-date="2025-10-24"><div class="month-day-number">24</div><div class="month-day-events"></div></div><div class="month-day-cell weekend" data-date="2025-10-25"><div class="month-day-number">25</div><div class="month-day-events"></div></div><div class="month-day-cell" data-date="2025-10-26"><div class="month-day-number">26</div><div class="month-day-events"></div></div><div class="month-day-cell" data-date="2025-10-27"><div class="month-day-number">27</div><div class="month-day-events"></div></div><div class="month-day-cell" data-date="2025-10-28"><div class="month-day-number">28</div><div class="month-day-events"></div></div><div class="month-day-cell" data-date="2025-10-29"><div class="month-day-number">29</div><div class="month-day-events"></div></div><div class="month-day-cell" data-date="2025-10-30"><div class="month-day-number">30</div><div class="month-day-events"></div></div><div class="month-day-cell weekend" data-date="2025-10-31"><div class="month-day-number">31</div><div class="month-day-events"></div></div></div>
                    </div>
                </div>
                <!-- Mobile Calendar View -->
                <div class="mobile-calendar">
                     <div class="agenda-header">
                        <div class="calendar-nav-container">
                            <div class="nav-buttons-group">
                                <button class="calendar-nav-btn" id="mobile-prev-month-btn" title="Previous Month"><i class="fas fa-angle-double-left"></i></button>
                                <button class="calendar-nav-btn" id="mobile-prev-week-btn" title="Previous Week"><i class="fas fa-chevron-left"></i></button>
                            </div>
                            <h2 id="mobile-calendar-title">October 2025</h2>
                            <div class="nav-buttons-group">
                                <button class="calendar-nav-btn" id="mobile-next-week-btn" title="Next Week"><i class="fas fa-chevron-right"></i></button>
                                <button class="calendar-nav-btn" id="mobile-next-month-btn" title="Next Month"><i class="fas fa-angle-double-right"></i></button>
                            </div>
                        </div>
                        <div class="view-toggle">
                            <button class="mobile-view-btn" data-view="today">Today</button>
                            <button class="mobile-view-btn active" data-view="week">Week</button>
                            <button class="mobile-view-btn" data-view="month">Month</button>
                        </div>
                    </div>
                    <div id="mobile-month-grid"><div class="day-name">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div><div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name">Sat</div><div class="day-cell">19</div><div class="day-cell">20</div><div class="day-cell has-event">21</div><div class="day-cell today has-event">22</div><div class="day-cell selected">23</div><div class="day-cell has-event">24</div><div class="day-cell">25</div></div>
                    <div id="mobile-agenda-events"><p style="opacity: 0.7; text-align: center; padding: 20px;">No events scheduled for this day</p></div>
                </div>
            </div>
            
            <!-- Hidden event data container (for calendar to find events) -->
            <div id="event-data-container" style="display: none;">
                <div class="event" data-event-title="Labor Market Policy Review" data-event-time="09:00 AM" data-event-details="Strategic sync on new labor market policies to enhance Saudization." data-topic="labor-market" data-date="2025-10-20"></div>
                <div class="event event-milestone" data-event-title="Milestone: Non-Profit Portal Launch" data-event-time="EOD" data-event-details="Official launch of the new national portal for non-profit organizations. Review launch communications." data-topic="non-profit" data-date="2025-10-20"></div>
                <div class="event" data-event-title="Partnership MoU Signing" data-event-time="10:00 AM" data-event-details="Ceremony for signing the Memorandum of Understanding with key private sector partners." data-topic="strategic-partnerships" data-date="2025-10-21"></div>
                <div class="event" data-event-title="Community Empowerment Briefing" data-event-time="02:00 PM" data-event-details="Briefing on the results of the recent community empowerment programs and future plans." data-topic="empowerment" data-date="2025-10-23"></div>
                <div class="event" data-event-title="Evening Strategy Session" data-event-time="09:00 PM" data-event-details="Critical evening strategy session to review Q4 objectives and finalize key decisions." data-topic="strategic-partnerships" data-date="2025-11-25"></div>
                <div class="event" data-event-title="Executive Review Meeting" data-event-time="10:00 PM" data-event-details="Executive review meeting with leadership team to discuss upcoming initiatives." data-topic="labor-market" data-date="2025-11-25"></div>
                <div class="event" data-event-title="Late Night Planning Session" data-event-time="11:00 PM" data-event-details="Late night planning session for next quarter's strategic roadmap." data-topic="empowerment" data-date="2025-11-28"></div>
                <div class="event" data-event-title="Afternoon Team Sync" data-event-time="11:40 AM" data-event-details="Team synchronization meeting to align on current projects and priorities." data-topic="strategic-partnerships" data-date="2025-11-27"></div>
                <div class="event" data-event-title="Quarterly Review Meeting" data-event-time="04:00 PM" data-event-details="Quarterly performance review and strategic planning discussion with key stakeholders." data-topic="labor-market" data-date="2025-11-27"></div>
                <div class="event" data-event-title="Evening Board Meeting" data-event-time="08:00 PM" data-event-details="Evening board meeting to review strategic initiatives and make key decisions." data-topic="empowerment" data-date="2025-11-26"></div>
                <div class="event" data-event-title="Labor Compliance Workshop" data-event-time="11:30 AM" data-event-details="Workshop with regional directors to review recent compliance audits and correct course." data-topic="labor-market" data-date="2025-10-10"></div>
                <div class="event" data-event-title="Workforce Metrics Stand-Up" data-event-time="08:30 AM" data-event-details="Early KPI check-in to align on week 2 labor-market dashboard metrics and blockers." data-topic="labor-market" data-date="2025-10-14"></div>
                <div class="event" data-event-title="Labor Market Innovation Summit" data-event-time="09:30 AM" data-event-details="Deep dive into post-2025 labor reforms, automation readiness, and private-sector hiring acceleration." data-topic="labor-market" data-date="2025-12-03"></div>
                <div class="event" data-event-title="Community Empowerment Progress Review" data-event-time="02:30 PM" data-event-details="Review the December activation of community empowerment grants and assess beneficiary readiness metrics." data-topic="empowerment" data-date="2025-12-05"></div>
                <div class="event" data-event-title="Non-Profit Impact Forum" data-event-time="11:00 AM" data-event-details="Roundtable with leading NGOs to align 2026 funding cycles and performance indicators." data-topic="non-profit" data-date="2025-12-07"></div>
                <div class="event" data-event-title="Global Partnership Council" data-event-time="03:30 PM" data-event-details="Strategic partnership council to finalize cross-border collaborations for 2026 initiatives." data-topic="strategic-partnerships" data-date="2025-12-04"></div>
                
                <!-- December 6, 2025 Meetings -->
                <div class="event" data-event-title="Morning Strategy Briefing" data-event-time="10:00 AM" data-event-details="Strategic briefing to review priorities and align on key objectives." data-topic="strategic-partnerships" data-date="2025-12-06"></div>
                <div class="event" data-event-title="Executive Lunch Meeting" data-event-time="12:00 PM" data-event-details="Working lunch session with senior leadership team." data-topic="labor-market" data-date="2025-12-06"></div>
                <div class="event" data-event-title="Afternoon Policy Review" data-event-time="02:00 PM" data-event-details="Review of current policy initiatives and implementation progress." data-topic="empowerment" data-date="2025-12-06"></div>
                <div class="event" data-event-title="End of Day Wrap-up" data-event-time="04:00 PM" data-event-details="Daily wrap-up meeting to summarize action items and next steps." data-topic="non-profit" data-date="2025-12-06"></div>
                
                <!-- December 8, 2025 Meetings -->
                <div class="event" data-event-title="Morning Strategy Briefing" data-event-time="10:00 AM" data-event-details="Strategic briefing to review priorities and align on key objectives." data-topic="strategic-partnerships" data-date="2025-12-08"></div>
                <div class="event" data-event-title="Executive Lunch Meeting" data-event-time="12:00 PM" data-event-details="Working lunch session with senior leadership team." data-topic="labor-market" data-date="2025-12-07"></div>
                <div class="event" data-event-title="Afternoon Policy Review" data-event-time="02:00 PM" data-event-details="Review of current policy initiatives and implementation progress." data-topic="empowerment" data-date="2025-12-07"></div>
                <div class="event" data-event-title="End of Day Wrap-up" data-event-time="04:00 PM" data-event-details="Daily wrap-up meeting to summarize action items and next steps." data-topic="non-profit" data-date="2025-12-07"></div>
                
                <!-- December 9, 2025 Meetings -->
                <div class="event" data-event-title="Morning Strategy Briefing" data-event-time="10:00 AM" data-event-details="Strategic briefing to review priorities and align on key objectives." data-topic="strategic-partnerships" data-date="2025-12-15"></div>
                <div class="event" data-event-title="Executive Lunch Meeting" data-event-time="12:00 PM" data-event-details="Working lunch session with senior leadership team." data-topic="labor-market" data-date="2025-12-11"></div>
                <div class="event" data-event-title="Afternoon Policy Review" data-event-time="02:00 PM" data-event-details="Review of current policy initiatives and implementation progress." data-topic="empowerment" data-date="2025-12-19"></div>
                <div class="event" data-event-title="End of Day Wrap-up" data-event-time="04:00 PM" data-event-details="Daily wrap-up meeting to summarize action items and next steps." data-topic="non-profit" data-date="2025-12-22"></div>
                <div class="event" data-event-title="MOMENTUM 2025" data-event-time="10:00 AM" data-event-details="Saudi Arabia, under the patronage of HRH the Crown Prince, is positioning itself as a global hub for development transformation by using integrated development finance to drive Vision 2030 priorities, empower the private sector and SMEs, and maximize long-term economic and social impact." data-topic="empowerment" data-date="2025-12-09"></div>

            </div>
        </div>


        <!-- Tools Page -->
        <div id="tools-page" class="page-content">
            <div class="tools-container">
                <!-- Tool Card 1: Data Visualization -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-chart-bar"></i></div>
                    <h3 class="tool-title">AI-Powered Data Visualization</h3>
                    <p class="tool-description">Automatically generates insightful charts and dashboards from ministry data, highlighting key trends, anomalies, and performance metrics without manual setup.</p>
                    <button class="tool-action-btn" data-tool-action="visualize"><i class="fas fa-eye"></i> Explore Tool</button>
                </div>
                <!-- Tool Card 2: Predictive Analytics -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-brain"></i></div>
                    <h3 class="tool-title">Predictive Policy Modeling</h3>
                    <p class="tool-description">Simulates the potential impact of proposed policies on key indicators (e.g., employment, social welfare) using AI to forecast outcomes and risks.</p>
                    <button class="tool-action-btn" data-tool-action="predict"><i class="fas fa-cogs"></i> Run Simulation</button>
                </div>
                <!-- Tool Card 3: Report Generation -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-file-invoice"></i></div>
                    <h3 class="tool-title">Automated Report Synthesis</h3>
                    <p class="tool-description">Condenses lengthy reports, research papers, and meeting transcripts into concise executive summaries, extracting key findings and action items.</p>
                    <button class="tool-action-btn" data-tool-action="summarize"><i class="fas fa-align-left"></i> Generate Summary</button>
                </div>
                 <!-- Tool Card 4: Sentiment Analysis -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-comments"></i></div>
                    <h3 class="tool-title">Public Sentiment Analysis</h3>
                    <p class="tool-description">Analyzes social media, news, and public feedback channels to gauge sentiment towards HRSD initiatives and identify emerging public concerns.</p>
                    <button class="tool-action-btn" data-tool-action="sentiment"><i class="fas fa-search"></i> View Sentiment</button>
                </div>
                 <!-- Tool Card 5: Smart Scheduling -->
                 <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-calendar-check"></i></div>
                    <h3 class="tool-title">Intelligent Meeting Scheduler</h3>
                    <p class="tool-description">Optimizes scheduling for complex, multi-attendee high-level meetings by considering priorities, availability, and optimal time slots using AI.</p>
                    <button class="tool-action-btn" data-tool-action="schedule"><i class="fas fa-calendar-plus"></i> Schedule Meeting</button>
                </div>
                 <!-- Tool Card 6: Risk Assessment -->
                 <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-shield-alt"></i></div>
                    <h3 class="tool-title">AI Risk Assessment</h3>
                    <p class="tool-description">Identifies potential risks in projects, policies, or operational areas by analyzing historical data and external factors, providing early warnings.</p>
                    <button class="tool-action-btn" data-tool-action="risk"><i class="fas fa-exclamation-triangle"></i> Assess Risk</button>
                </div>
                <!-- Tool Card 7: Strategic Focus Area Advisor -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-user-tie"></i></div>
                    <h3 class="tool-title">Strategic Focus Area Advisor</h3>
                    <p class="tool-description">Provides in-depth analysis, recommendations, and guidance on all priority focus areas to support informed leadership decisions.</p>
                    <button class="tool-action-btn" data-tool-action="advice"><i class="fas fa-lightbulb"></i> Strategic Guide</button>
                </div>
            </div>
        </div>
        <!-- Placeholder Pages -->
        <!-- News Page -->
        <div id="news-page" class="page-content">
            <div class="news-container" style="width: 100%;">
                <!-- News Header -->
                <div class="news-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0 10px;">
                    <h2 style="margin: 0; color: var(--text-dark);"><i class="fas fa-newspaper" style="margin-right: 10px; color: var(--primary-blue);"></i>Latest News</h2>
                    <button id="refresh-news-btn" class="tool-action-btn" style="margin: 0;"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                
                <!-- Topic Filters -->
                <div class="news-filters" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 25px; padding: 0 10px;">
                    <button class="news-filter-btn active" data-topic-filter="all" style="background: linear-gradient(135deg, var(--primary-blue), #008a7e); border: 1px solid var(--primary-blue); color: var(--text-dark); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; font-weight: 500;">All Topics</button>
                    <button class="news-filter-btn" data-topic-filter="labor-market" style="background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Labor Market</button>
                    <button class="news-filter-btn" data-topic-filter="empowerment" style="background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Empowerment</button>
                    <button class="news-filter-btn" data-topic-filter="non-profit" style="background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Non-Profit</button>
                    <button class="news-filter-btn" data-topic-filter="strategic-partnerships" style="background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">Partnerships</button>
                </div>
                <div id="news-filter-label" style="margin: -15px 10px 20px; color: var(--primary-blue); font-weight: 500; display: none;"></div>
                
                <!-- Loading State -->
                <div id="news-loading" style="text-align: center; padding: 40px; display: none;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-blue); margin-bottom: 15px;"></i>
                    <p style="opacity: 0.8;">Fetching latest news...</p>
                </div>
                
                <!-- News Feed Container -->
                <div id="news-feed" class="tools-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
                    <!-- News cards will be dynamically inserted here -->
                </div>
                
                <!-- Empty State -->
                <div id="news-empty" style="text-align: center; padding: 60px 20px; display: none;">
                    <i class="fas fa-newspaper" style="font-size: 3rem; color: var(--primary-blue); opacity: 0.5; margin-bottom: 20px;"></i>
                    <p style="opacity: 0.7; font-size: 1.1rem;">No news found for the selected topic. Click refresh to fetch latest updates.</p>
                </div>
            </div>
        </div>
        <div id="templates-page" class="page-content"> 
            <div class="tools-container">
                <!-- Tool Card 1: Data Visualization -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fa-regular fa-newspaper"></i></div>
                    <h3 class="tool-title">Official Press Release Template</h3>
                    <p class="tool-description">A structured, professional format for announcing major initiatives, achievements, or decisions to the public and media while ensuring clarity, consistency, and alignment with official communication standards.</p>
                    <button class="tool-action-btn" data-tool-action="press"><i class="fas fa-align-left"></i> Generate Template</button>
                </div>
                <!-- Tool Card 2: Predictive Analytics -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fa-solid fa-file-lines"></i></div>
                    <h3 class="tool-title">Internal Memo</h3>
                    <p class="tool-description">A formal communication template for sharing updates, decisions, or instructions within the organization, designed to streamline internal alignment and ensure clear, concise information flow.</p>
                    <button class="tool-action-btn" data-tool-action="memo"><i class="fas fa-align-left"></i> Generate Template</button>
                </div>
                <!-- Tool Card 3: Report Generation -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fa-solid fa-building-columns"></i></div>
                    <h3 class="tool-title">Interministerial Request</h3>
                    <p class="tool-description">A standardized template for formally requesting information, support, or coordination from other government ministries, ensuring diplomatic tone, clarity of purpose, and administrative precision.</p>
                    <button class="tool-action-btn" data-tool-action="interministerial"><i class="fas fa-align-left"></i> Generate Template</button>
                </div>
                 <!-- Tool Card 4: Sentiment Analysis -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-comments"></i></div>
                    <h3 class="tool-title">Speech Template</h3>
                    <p class="tool-description">A guided framework for preparing executive speeches, providing structure for key messages, strategic themes, and audience engagement while maintaining a polished, authoritative voice.
                        </p>
                    <button class="tool-action-btn" data-tool-action="speech"><i class="fas fa-align-left"></i> Generate Template</button>
                </div>
                 <!-- Tool Card 5: Smart Scheduling -->
                 <div class="tool-card">
                    <div class="tool-icon"><i class="fa-solid fa-landmark-flag"></i></div>
                    <h3 class="tool-title">Diplomatic Communication Template</h3>
                    <p class="tool-description">A formal diplomatic correspondence format used for communicating with international counterparts, embassies, and global institutions, ensuring protocol compliance, professionalism, and cross-border clarity.</p>
                    <button class="tool-action-btn" data-tool-action="diplomatic"><i class="fas fa-align-left"></i> Generate Template</button>
                </div>
            </div> 
        </div>
        
        <!-- Mandate -->
        <div id="mandate-page" class="page-content">
            <div class="topics-container" style="width: 100%;">
                <!-- Topic Card 1 -->
                <div class="topic-card" data-topic-id="labor-market">
                    <div class="topic-icon"><i class="fas fa-briefcase"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Consultation</h3>
                        <p class="topic-description">Providing strategic, data-driven guidance to support informed decision-making, clarify priorities, and address emerging challenges across HRSD initiatives and programs.</p>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 2 -->
                <div class="topic-card" data-topic-id="empowerment">
                     <div class="topic-icon"><i class="fas fa-users"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Scheduling</h3>
                        <p class="topic-description">Coordinating high-priority meetings, engagements, and workflows to ensure seamless alignment between stakeholders, agendas, and organizational objectives.</p>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 3 -->
                <div class="topic-card" data-topic-id="non-profit">
                     <div class="topic-icon"><i class="fas fa-hand-holding-heart"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">News and Media</h3>
                        <p class="topic-description">Monitoring, analyzing, and summarizing internal and external media developments to provide timely insights that support awareness, reputation management, and strategic communication.</p>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 4 -->
                <div class="topic-card" data-topic-id="strategic-partnerships">
                     <div class="topic-icon"><i class="fas fa-handshake"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Task Management &amp; Follow up</h3>
                        <p class="topic-description">Tracking key actions, monitoring progress, and ensuring timely follow-up on commitments to maintain operational momentum and accountability across initiatives.</p>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 5 -->
                <div class="topic-card" data-topic-id="strategic-partnerships">
                     <div class="topic-icon"><i class="fas fa-handshake"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Official Correspondents</h3>
                        <p class="topic-description">Drafting, refining, and managing formal communications, correspondence, and executive messages to ensure professionalism, clarity, and alignment with organizational priorities.</p>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 6 -->
                <div class="topic-card" data-topic-id="strategic-partnerships">
                     <div class="topic-icon"><i class="fas fa-handshake"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Committees Management </h3>
                        <p class="topic-description">Supporting the organization, documentation, and follow-through of committee work by facilitating agendas, minutes, decisions, and action items for effective governance.</p>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>
                <!-- Topic Card 7 -->
                <div class="topic-card" data-topic-id="strategic-partnerships">
                     <div class="topic-icon"><i class="fas fa-handshake"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Strategic &amp; Operational KPI</h3>
                        <p class="topic-description">Monitoring and interpreting performance indicators to assess progress, identify gaps, and support evidence-based decision-making across strategic and operational objectives.</p>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                        <button class="topic-action-btn" data-action="news"><i class="fas fa-newspaper"></i> Related News</button>
                    </div>
                </div>


            </div>
        </div>
    
    </div>

    <!-- Modals -->
    <div id="agentInfoModal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <span class="close-button">Ã—</span>
            <div class="agent-info-modal-body">
                <img id="agent-info-avatar" src="" alt="Agent Avatar">
                <h3 id="agent-info-name">Agent Name</h3>
                <p id="agent-info-role" style="font-weight: 600; color: var(--primary-blue);"></p>
                <p id="agent-info-description" style="opacity: 0.85;"></p>
            </div>
        </div>
    </div>

    <div id="personaModal" class="modal">
        <div class="modal-content">
            <span class="close-button">Ã—</span>
            <h2>Choose Your AI Agent</h2>
            <div class="persona-options" id="personaOptions"></div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button">Ã—</span>
            <h3 id="event-modal-title">Event Title</h3>
            <p id="event-modal-time">Event Time</p>
            <p id="event-modal-details">Event Details</p>
            <div class="event-actions">
                <button id="summarize-event-btn"><i class="fas fa-align-left"></i> Summarize</button>
                <button id="prepare-event-btn"><i class="fas fa-clipboard-check"></i> Consult for Preparation</button>
            </div>
        </div>
    </div>

    <div id="dayMeetingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
            <span class="close-button">Ã—</span>
            <h2 id="day-meetings-title">Meetings for Date</h2>
            <div id="day-meetings-list" style="max-height: calc(80vh - 150px); overflow-y: auto; margin-top: 20px;">
                <!-- Meetings will be populated here -->
            </div>
        </div>
    </div>

    <div id="meetingsModal" class="modal" style="display: none;">
        <div class="modal-content" id="focus-modal-content">
            <span class="close-button">Ã—</span>
            <h2 id="meetings-modal-title">Discuss a Topic</h2>
            <div id="meetings-modal-list"></div>
        </div>
    </div>

    <div id="dayActionModal" class="modal">
        <div class="modal-content">
            <span class="close-button">Ã—</span>
            <h2 id="day-action-title">Actions for Date</h2>
            <div id="day-action-focus-areas">
                 <div class="dropdown-header">Select a Focus Area</div>
                 <div class="modal-pills-container" id="day-action-pills">
                     <!-- Pills will be populated by JS -->
                 </div>
            </div>
            <div class="day-actions">
                <button data-action="check"><i class="fas fa-calendar-check"></i> Check Availability</button>
                <button data-action="media"><i class="fas fa-bullhorn"></i> Coordinate with Media Team</button>
                <button data-action="consulting"><i class="fas fa-users-cog"></i> Summon Consulting Team</button>
            </div>
        </div>
    </div>

    <!-- Simple Message Modal (replaces alert) -->
    <div id="messageModal" class="modal">
        <div class="modal-content" style="width: 400px; max-width: 90%;">
            <span class="close-button">Ã—</span>
            <h2 id="message-modal-title" style="color: var(--primary-blue); margin-bottom: 15px;">Notice</h2>
            <p id="message-modal-text" style="text-align: center; font-size: 1.1rem; line-height: 1.6;"></p>
        </div>
    </div>

    <!-- Floating "Ask Agent" Button -->
    <div id="ask-agent-btn" style="display: none;"><i class="fas fa-comment-dots"></i> Ask Agent</div>

    <!-- Focus Area Details Modal -->
    <div id="focusAreaModal" class="modal">
        <div class="modal-content" id="focus-area-modal-content">
            <span class="close-button" onclick="closeFocusAreaModal()">&times;</span>

            <h2 id="focusAreaTitle"></h2>

            <div id="focusAreaDescription" style="margin-bottom:20px; opacity:0.9;"></div>

            <h3 style="color:var(--primary-blue); margin-top:25px;">Strategic KPIs</h3>
            <div id="focusAreaKPIs" style="margin-bottom:20px;"></div>

            <h3 style="color:var(--primary-blue); margin-top:25px;">Related Initiatives</h3>
            <div id="focusAreaInitiatives"></div>
        </div>
    </div>


    <script>

         // Hardcoded Gemini API key and endpoint (used instead of Vercel proxy)
        // NOTE: This file is for local / demo purposes only; do NOT deploy a hardcoded key publicly.
        const GEMINI_API_KEY = 'AIzaSyCVTUgYEEAs42wg1pFTLJFVxzQI3wh1wYI'; // main agents
        const GEMINI_MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        // Separate key just for tweet summarization to spread load
        const GEMINI_SUMMARY_API_KEY = 'AIzaSyAjZ6GmrhsbnILf2ZTfJaYxO3xUpjYvzAo';
        const GEMINI_SUMMARY_MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_SUMMARY_API_KEY}`;


        const chatInput = document.getElementById("chatInput");
        const chatInputControls = document.querySelector('.chat-input-controls');

        chatInput.addEventListener("input", () => {
            chatInput.style.height = "auto";
            chatInput.style.height = chatInput.scrollHeight + "px";
            
            // Toggle mic/send button based on input content
            if (chatInputControls) {
                if (chatInput.value.trim().length > 0) {
                    chatInputControls.classList.add('has-text');
                } else {
                    chatInputControls.classList.remove('has-text');
                }
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const personaData = [
                { id: 'hakim', name: 'Hakim NÃ¼ruddin', title: 'AI Executive Office Agent', largeImg: 'https://hams.ai/images/ai-voice-agent.png', smallImg: 'https://hams.ai/images/ai-voice-agent.png', description: 'As your strategic partner, I provide high-level summaries, executive advice, and focus on strategic alignment for your key decisions.', systemPrompt: 'You are Hakim NÃ¼ruddin, an AI Executive Office Agent for HRSD in Saudi Arabia. You coordinate a team of specialized AI agents to support Your Excellency.\n\nAvailable Team Members:\n- Hakim NÃ¼ruddin (yourself): AI Executive Office Agent - Strategic insights, executive summaries, high-level decisions, leadership advice, policy alignment with Vision 2030\n- Layla Al-Khaldi: Data Analytics Agent - Data analysis, charts, statistics, metrics, trends, quantitative insights, KPI monitoring\n- Omar Mansour: AI Coordinator - Operational coordination, task management, scheduling, workflow optimization, resource allocation\n- Nouf Al-Jafali: AI Strategy & Management Consultant - In-depth analysis and consulting on specific strategic focus areas (labor market, empowerment, non-profit sector, strategic partnerships)\n\nWhen asked about agents, team members, or their roles, provide accurate information about all four agents listed above. Do not invent or mention agents that do not exist. Be concise, professional, and insightful. Provide strategic advice and summaries.', responderSystemPrompt: 'You are Hakim NÃ¼ruddin, an executive AI agent. Provide a concise strategic answer or executive summary. DO NOT attempt to re-orchestrate or route to other agents; answer directly and clearly, focusing on recommendations, high-level reasoning, and next steps.', capabilities: ['executive summary', 'direction', 'leadership', 'overview', 'vision']},
                // Update Layla's systemPrompt for insights/charts
                { id: 'layla', name: 'Layla Al-Khaldi', title: 'Data Analytics Agent', largeImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/27feb2bb-aeb4-4a83-9fb6-8f3f2a15885e/3f6fb035-158b-47f1-8c69-5fe9a407d4f2.png', smallImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/27feb2bb-aeb4-4a83-9fb6-8f3f2a15885e/3f6fb035-158b-47f1-8c69-5fe9a407d4f2.png', description: 'As your data expert, I provide Your Excellency with key insights from around HRSD, identify trends, and offer detailed analytical support for your objectives.', systemPrompt: 'You are Layla Al-Khaldi, a Data Analytics Agent for HRSD in Saudi Arabia. Your Excellency requires data-driven insights. ALWAYS respond with concise analysis, key findings, and data points. When a visualization is appropriate (e.g., trends, comparisons), provide the necessary data in a Chart.js-compatible JSON format strictly enclosed within `[CHART_DATA:{...}]`. The JSON MUST be complete and valid. It MUST contain "type" (e.g., "bar", "line", "pie"), "labels" (array of strings), and "datasets" (array of objects, each with "label" and "data" properties). Example: `[CHART_DATA:{"type": "bar", "labels": ["Q1", "Q2"], "datasets": [{"label": "Metric A", "data": [10, 15]}]}]` Always include a brief textual explanation of the chart\'s insights immediately following the chart data marker. Focus strictly on providing analytical insights derived from data. Avoid conversational filler unless specifically asked.', capabilities: ['data', 'metrics', 'charts', 'statistics', 'analysis', 'kpis', 'reports'] }, // Added "MUST be complete and valid"
                { id: 'omar', name: 'Omar Mansour', title: 'AI Coordinator', largeImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/2f8cd8b2-88d5-4865-b07e-cafd6403b72b/bd99faca-67c4-4cc3-895e-06bed59a08d2.png', smallImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/2f8cd8b2-88d5-4865-b07e-cafd6403b72b/bd99faca-67c4-4cc3-895e-06bed59a08d2.png', description: 'As your operational specialist, I manage schedules, coordinate between departments, and provide logistical support to ensure operational smoothness.', systemPrompt: 'You are Omar Mansour, the AI Coordinator for HRSD in Saudi Arabia. You handle scheduling, task coordination, and operational logistics for Your Excellency.\n\nYOUR ROLE:\n- Schedule meetings, interviews, and appointments\n- Coordinate tasks between team members\n- Track action items and deadlines\n- Provide logistical support and workflow optimization\n\nYOUR TEAM (do NOT invent other agents or fictional staff):\n- Hakim NÃ¼ruddin: AI Executive Office Agent (strategic decisions, executive summaries)\n- Layla Al-Khaldi: Data Analytics Agent (data analysis, charts, metrics)\n- Nouf Al-Jafali: AI Strategy & Management Consultant (policy analysis, focus areas)\n- Yourself (Omar Mansour): Coordination, Scheduling & Logistics\n\nWhen asked to schedule something:\n1. Confirm the request clearly\n2. Propose specific time slots or next steps\n3. List concrete action items YOU will take\n4. Do NOT reference fictional agents, liaisons, or staff members\n\nKeep responses action-oriented, practical, and focused on logistics. You handle the coordination directly - do not delegate to made-up people.', capabilities: ['meetings', 'coordination', 'scheduling', 'workflow', 'logistics', 'tasks']},
                { id: 'nouf', name: 'Nouf Al-Jafali',  title: 'AI Strategy & Management Consultant', largeImg: 'https://img.freepik.com/premium-photo/arab-abaya-woman-happy-using-mobile-phone-excited-smile-saudi-emirati-businesswoman_1022426-10277.jpg', smallImg: 'https://img.freepik.com/premium-photo/arab-abaya-woman-happy-using-mobile-phone-excited-smile-saudi-emirati-businesswoman_1022426-10277.jpg', description: 'As your dedicated consultant for strategic focus areas, I provide in-depth analysis, policy recommendations, and detailed briefings on the key topics you are exploring.',
                systemPrompt: `You are Nouf Al-Jafali, an AI Strategy & Management Consultant supporting the Saudi Ministry of Human Resources and Social Development (HRSD).

                ===============================================================================
                HRSD FOUNDATIONAL KNOWLEDGE BASE (AUTHORITATIVE REFERENCE)
                ===============================================================================

                VISION:
                Global leadership in empowering individuals and communities, and enhancing labor market competitiveness.

                MISSION:
                Empowering individuals, society, and institutions, and create a labor market that fosters innovation, sustainability, and keeps pace with future transformations through flexible and effective policies and regulations.

                CORE VALUES:
                Excellence | Innovation | Responsibility | Mastery | Transparency

                STRATEGIC PILLARS:
                - One Labor Market
                - Decent Living For All
                - High Productivity Economy
                - Sustainable Corporate Excellence

                STRATEGIC OBJECTIVES (Official):
                1. Support a harmonious labor market
                2. Improve productivity and performance of manpower
                3. Achieve benefit and social justice for all society members
                4. Achieve the optimal level of customer experience and enhance the mental image
                5. Raise the efficiency of spending on public-sector manpower
                6. Enhance international cooperation and communication
                7. Ensure effective and comprehensive social care and protection services
                8. Support and apply labor market reforms
                9. Raise the level of compliance in the labor market
                10. Increase the participation and empowerment of the workforce and its inclusiveness
                11. Strengthen the self-reliance of families and individuals
                12. Provide sustainable social development services
                13. Achieve spending efficiency and enhance revenues
                14. Enhance digital transformation
                15. Improve employee experience and focus on employee satisfaction
                16. Achieve strategic transformation and transfer to organizational and supervisory role

                OFFICIAL GOALS:
                - Increasing workforce participation and inclusiveness
                - Enabling the employment of Saudis
                - Improving the productivity and performance of the workforce
                - Supporting a harmonized labor market
                - Rationalizing the wage bill in the public sector
                - Increasing the non-profit sector in the national economy
                - Enhancing social security networks and promoting self-reliance for families and individuals
                - Achieving effective and sustainable services of social development
                - Ensuring effective and inclusive social welfare services
                - Transforming to effective policies status and full supervision of the system
                - Achieving the perfect level in customer experience
                - Building future human capabilities
                - Achieving operational excellence

                FOUR SECTORS HRSD OVERSEES:
                1. Labor Sector - Labor market strategy, workforce policies, private sector employment
                2. Social Development Sector - Social welfare, disability services, volunteering, NPO support
                3. Civil Service Sector - Public sector workforce, government HR policies, digital services
                4. Joint Services Sector - Digital transformation, institutional excellence, cross-government coordination

                ===============================================================================
                OFFICIAL PROGRAMS & INITIATIVES (VERIFIED - DO NOT FABRICATE)
                ===============================================================================

                Vision 2030 Realization Programs HRSD Contributes To:
                - Human Capability Development Program (HCDP) - 5 indicators, 15 initiatives
                Three Pillars: (1) Resilient educational base, (2) Prepare for future labor markets, (3) Lifelong learning
                Framework: Values & Attitudes, Basic Skills, Skills of the Future, Knowledge
                - Fiscal Sustainability Program - Citizen Account Initiative, Financial Equivalent for Expatriates
                - Quality of Life Program - Expatriates Satisfaction Indicator, Services for Expatriates Initiative
                - Financial Sector Development Program - Development of Products for Low-income Groups

                Key HRSD Initiatives (Official):
                - WAAD National Training Campaign - Target: 1,155,000+ training opportunities by end of 2025; 7 criteria including 12%+ annual training of Saudi employees
                - Sectoral Skills Councils - Target: 12 sectoral councils in partnership with private sector
                - National Occupational Standards Initiative - Target: 300+ professions standardized
                - Skills Accelerator Initiative - Target: 162,000 private sector employees for high-level skills
                - Training Vouchers Initiative - Target: 160,000+ Saudi employees for low/medium skill development
                - Nitaqat Program - Saudization compliance system

                ===============================================================================
                OFFICIAL PARTNERSHIPS (VERIFIED - DO NOT FABRICATE)
                ===============================================================================

                International:
                - International Labour Organization (ILO)
                - International Cooperative Alliance (ICA)
                - Organization of Islamic Cooperation (OIC)
                - Arab Labor Organization
                - Arab Organization for Administrative Development
                - G20 Employment Working Group

                Domestic/Regional:
                - Ministry of Justice (MoU)
                - Ministry of Environment, Water and Agriculture (MEWA)
                - Social Commission for Tourism and National Heritage
                - Careem
                - Ataa
                - Tamkeen Program

                ===============================================================================
                YOUR ROLE & OPERATING PRINCIPLES
                ===============================================================================

                PRIMARY ROLE:
                Deliver deep, structured, evidence-based strategic analysis aligned with HRSD's mandate, Vision 2030 priorities, and key national programs. Operate at an executive, policy-making level for Your Excellency.

                FOUR ANALYSIS DOMAINS:
                1. Labor Market Development
                2. Empowerment of Society & Individuals
                3. Non-Profit Sector Enablement
                4. Strategic Partnerships (local & global)

                ===============================================================================
                CREATIVITY & ACCURACY GUIDELINES
                ===============================================================================

                **STRATEGIC IMPERATIVE: GENERATE SYSTEMIC, HIGH-VALUE REFORMS**

                You must strive to propose solutions that fundamentally change the system or funding paradigm, focusing on achieving the **Vision 2030 goals** through structural improvements, rather than short-term fixes.

                CORE PRINCIPLES FOR PROPOSALS:
                * **Structural Reform:** Solutions should aim to enhance labor mobility, self-reliance, and market agility by reforming core regulations (e.g., social security, benefits transfer, credentialing).
                * **Incentive Design:** Policy recommendations must prioritize shifting private sector behavior by rewarding high-value outcomes (productivity, advanced skills, retention) over simple compliance metrics (headcount).
                * **Financial Innovation:** Propose market-driven financing models (e.g., individual accounts, impact bonds, endowments) to diversify revenue streams away from centralized subsidies.
                * **Modernization:** Integrate globally accepted best practices (e.g., behavioral science, advanced data analytics) to optimize program effectiveness and increase beneficiary engagement.
                * **Recommend New Partnerships:** Propose specific, external entities (domestic or international) whose expertise is essential to a structural reform, ensuring they are clearly labeled as 'Proposed New Partnership' and justified by the strategic gap.

                WHAT YOU MUST NEVER FABRICATE:
                - HRSD programs, initiatives, or projects that do not exist in the knowledge base
                - Partnership agreements or MoUs that are not listed
                - Ministerial decisions, royal decrees, or policy announcements
                - Organizational structures or department names that do not exist

                ATTRIBUTION LANGUAGE TO USE:
                - For facts: "According to HRSD's strategy..." or "As established in the HCDP framework..."
                - For proposals: "I recommend..." or "A potential approach aligned with Vision 2030 would be..."
                - For hypothetical scenarios: "If HRSD were to..." or "A modeling scenario suggests..."
                - For international examples: "Drawing from [Country]'s experience with..."

                EPISTEMIC HONESTY:
                When uncertain, explicitly state: "This would require verification with current ministry data" or "Based on the strategic direction, though specific metrics are not available in my reference..."

                ===============================================================================
                RESPONSE STRUCTURE (MANDATORY)
                ===============================================================================

                1. Executive Summary / Key Insights (3-5 high-level bullets)
                - Ground in official strategic priorities

                2. Strategic Recommendations
                - Short-Term / Quick-Wins (6-12 months)
                - Long-Term / Structural Reforms (1-3 years)
                - Clearly distinguish between "existing initiatives to leverage" vs "new proposals"

                3. Next Steps / Considerations
                - Specific governance or partnership initiation actions
                - Identify which HRSD sector would lead
                - Note any dependencies on external entities

                TONE & STYLE:
                - Concise, professional, strategic - suitable for ministerial level
                - Use Arabic terms appropriately where they add clarity (e.g., Saudization, Nitaqat)
                - Reference specific Vision 2030 connections when relevant
                - Balance ambition with feasibility in the Saudi context

                ===============================================================================
                FINAL CONSTRAINT
                ===============================================================================
                All recommendations must serve HRSD's mission: "Empowering individuals, society, and institutions, and create a labor market that fosters innovation, sustainability, and keeps pace with future transformations through flexible and effective policies and regulations."

                When in doubt, ask: Does this recommendation align with the four strategic pillars?
                - One Labor Market
                - Decent Living For All
                - High Productivity Economy
                - Sustainable Corporate Excellence

                If not, reconsider the recommendation.`,
                 capabilities: ['strategy', 'consulting', 'policy', 'planning', 'recommendations', 'risks']}			];
            let currentPersonaId = 'hakim';
            let selectedAgents = ['hakim']; // Multi-agent: Array of selected agent IDs
            let isMultiAgentMode = false; // Mode: false = single agent, true = multi-agent
            let chatHistory = [];
            let selectedText = '';
            // Set "today" to the specified context date: Wednesday, Oct 22, 2025

            // --- DOM Elements ---
            const mainPersonaImage = document.getElementById('mainPersonaImage');
            const mainPersonaName = document.getElementById('mainPersonaName');
            const mainPersonaTitle = document.getElementById('mainPersonaTitle');
            const personaModal = document.getElementById("personaModal");
            const eventModal = document.getElementById("eventModal");
            const meetingsModal = document.getElementById("meetingsModal");
            const dayActionModal = document.getElementById("dayActionModal");
            const messageModal = document.getElementById("messageModal"); // New modal
            const agentInfoModal = document.getElementById("agentInfoModal");
            const agentInfoAvatar = document.getElementById("agent-info-avatar");
            const agentInfoName = document.getElementById("agent-info-name");
            const agentInfoRole = document.getElementById("agent-info-role");
            const agentInfoDescription = document.getElementById("agent-info-description");
            const modeStatusLabel = document.getElementById("modeStatusLabel");
            const closeModalBtns = document.querySelectorAll('.close-button');
            const personaOptionsContainer = document.getElementById('personaOptions');
            const navButtons = document.querySelectorAll('.nav-tabs .nav-button'); // More specific selector
            const pages = document.querySelectorAll('.page-content');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('send-btn');
            const chatMessages = document.getElementById('chatMessages');
            const askAgentBtn = document.getElementById('ask-agent-btn');
            const summaryContent = document.getElementById('summary-content');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const navTabsContainer = document.querySelector('.nav-tabs-container');
            const chatActionBtn = document.getElementById('chat-action-btn');
            const messageModalTitle = document.getElementById("message-modal-title"); // New
            const messageModalText = document.getElementById("message-modal-text"); // New
            const copySummaryBtn = document.getElementById("copy-summary-btn"); // Copy button

            // --- Function Definitions ---

			// --- Overlay utilities (robust fallback) ---
			function ensureGlobalOverlay() {
			    // If already present, return it
			    let overlay = document.getElementById('chatOverlayGlobal');
			    if (overlay) return overlay;
			
			    // Create overlay and indicator and append to body so it can't be obscured by layout
			    overlay = document.createElement('div');
			    overlay.id = 'chatOverlayGlobal';
			    overlay.className = 'chat-overlay-global';
			    document.body.appendChild(overlay);
			
			    const indicator = document.createElement('div');
			    indicator.id = 'chatOverlayIndicator';
			    indicator.className = 'chat-overlay-indicator';
			    indicator.textContent = 'Voice mode active';
			    document.body.appendChild(indicator);
			
			    console.log('[VoiceOverlay] created global overlay');
			    return overlay;
			}
			
			function showOverlayGlobal() {
			    const el = ensureGlobalOverlay();
			    el.classList.add('active');
			    // also add small log for debugging
			    console.log('[VoiceOverlay] showOverlayGlobal() called');
			}
			
			function hideOverlayGlobal() {
			    const el = document.getElementById('chatOverlayGlobal');
			    if (el) el.classList.remove('active');
			    console.log('[VoiceOverlay] hideOverlayGlobal() called');
			}


            function buildTemplatePrompt(templateType, userPrompt) {

                const hiddenGuidelines = {

                    "press_release": `
            You are an expert government communications officer.
            Before drafting a press release, ALWAYS collect the following from the user:
            1. Title of the announcement  
            2. Purpose of the press release  
            3. Key message / main highlight  
            4. Entities involved  
            5. Any required quotes  
            6. Target audience  
            7. Desired tone (e.g., formal, neutral)  
            8. Deadline or timing constraints  

            Do NOT create the press release until the user answers all points. 
            ALWAYS respond first by asking the missing items ONLY.
            `,

                    "internal_memo": `
            You are a senior advisor preparing internal government memos.
            Before writing a memo, ALWAYS collect:
            1. Memo subject  
            2. Recipient(s)  
            3. Purpose of the memo  
            4. Key decisions or asks  
            5. Background information  
            6. Tone preference  
            7. Any attachments or references  

            Never draft the memo until all missing items are clarified.
            `,

                    "interministerial_request": `
            You are an expert in federal/government communication.
            Before drafting an interministerial request, ALWAYS collect:
            1. Objective of the request  
            2. Target ministry / agency  
            3. Required actions from them  
            4. Context / background  
            5. Timeline or urgency  
            6. Any documents or evidence to attach  

            Never produce the document until all details are provided.
            `,

                    "speech": `
            You are a top-tier speechwriter specialized in official ministerial events.
            Before drafting a speech, ALWAYS ask for:
            1. Event name  
            2. Audience description  
            3. Speech length  
            4. Core message  
            5. Tone  
            6. Key topics to include  
            7. Any quotes or references to integrate  

            Ask for missing details first. Do not generate the speech until all inputs are received.
            `,

                    "diplomatic": `
            You are a professional diplomatic writer.
            Before drafting a diplomatic communication, ALWAYS collect:
            1. Recipient nation / entity  
            2. Purpose  
            3. Sensitivity level  
            4. Required diplomatic tone  
            5. Specific requests or proposals  
            6. Background context  
            7. Key constraints  

            Never provide the communication until all details are answered.
            `
                };

                return `${hiddenGuidelines[templateType]}\n\nUser request: ${userPrompt}`;
            }

            // --- Persona Management ---
            function updatePersonaUI(personaId, isInitialLoad = false) {
                 const persona = personaData.find(p => p.id === personaId);
                if (!persona) return;

                if(mainPersonaImage) mainPersonaImage.src = persona.largeImg;
                if(mainPersonaName) mainPersonaName.textContent = persona.name;
                if(mainPersonaTitle) mainPersonaTitle.textContent = persona.title;

                document.querySelectorAll('[data-persona-avatar]').forEach(img => {
                    img.src = persona.smallImg;
                });

                const oldPersonaId = currentPersonaId;
                currentPersonaId = personaId;

                if (!isInitialLoad && oldPersonaId !== currentPersonaId) {
                    chatHistory = []; // Reset history when changing persona
                   if (chatMessages) chatMessages.innerHTML = ''; // Add null check
                    displayNewPersonaGreeting(persona);
                }
            }

            function displayNewPersonaGreeting(persona) {
                 let greeting = `Welcome Your Excellency. As-salÄmu 'alaykum. I am ${persona.name}. ${persona.description} How may I be of service to Your Excellency today?`;
                 displayMessage('agent', greeting);
                 // Add greeting to history for context
                 // Check if history is empty or last message wasn't this greeting to avoid duplicates on quick switches
                 if(chatHistory.length === 0 || chatHistory[chatHistory.length-1]?.parts?.[0]?.text !== greeting) {
                    chatHistory.push({ role: 'model', parts: [{ text: greeting }] });
                 }
            }
            
            // --- Multi-Agent Functions ---
            function renderAgentSelection() {
                const container = document.getElementById('agentSelectionList');
                if (!container) return;
                
                container.innerHTML = '';
                personaData.forEach(agent => {
                    const isSelected = selectedAgents.includes(agent.id);
                    const div = document.createElement('div');
                    div.className = `agent-select-item ${isSelected ? 'selected' : ''}`;
                    
                    // Create unique ID for checkbox-label association
                    const toggleId = `agent-toggle-${agent.id}`;
                    
                    div.innerHTML = `
                        <input type="checkbox" class="agent-checkbox" 
                               id="${toggleId}"
                               data-agent-id="${agent.id}" 
                               ${isSelected ? 'checked' : ''}>
                        <label for="${toggleId}" class="agent-toggle">
                            <span class="agent-toggle-slider"></span>
                        </label>
                        <img src="${agent.smallImg}" alt="${agent.name}" class="agent-mini-avatar">
                        <div class="agent-select-info">
                            <div class="agent-select-name">${agent.name}</div>
                            <div class="agent-select-title">${agent.title}</div>
                        </div>
                        <button class="agent-info-btn" data-agent-id="${agent.id}" title="More about ${agent.name}">
                            <i class="fas fa-info"></i>
                        </button>
                    `;
                    
                    const infoBtn = div.querySelector('.agent-info-btn');
                    if (infoBtn) {
                        infoBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showAgentInfo(agent.id);
                        });
                    }
                    
                    // Handle checkbox change
                    const checkbox = div.querySelector('.agent-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        toggleAgentSelection(agent.id);
                    });
                    
                    // Handle div click (toggle when clicking anywhere on the card except the toggle itself)
                    div.addEventListener('click', (e) => {
                        // Don't toggle if clicking directly on the toggle switch or checkbox
                        if (!e.target.closest('.agent-toggle') && e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            toggleAgentSelection(agent.id);
                        }
                    });
                    
                    container.appendChild(div);
                });
                
                // Update the count badge
                const countBadge = document.getElementById('agentCountBadge');
                if (countBadge) {
                    countBadge.textContent = selectedAgents.length;
                }
                
                updateModeStatusLabel();
            }
            
            function toggleAgentSelection(agentId) {
                const index = selectedAgents.indexOf(agentId);
                if (index > -1) {
                    // Deselect - but ensure at least one agent is selected
                    if (selectedAgents.length > 1) {
                        selectedAgents.splice(index, 1);
                    } else {
                        showMessageModal('At least one agent must be selected', 'Notice');
                        renderAgentSelection(); // Re-render to reset the checkbox
                        return;
                    }
                } else {
                    // Select
                    selectedAgents.push(agentId);
                }
                // Update multi-agent mode based on number of selected agents
                isMultiAgentMode = selectedAgents.length > 1;
                renderAgentSelection();
                updateModeStatusLabel();
            }
            
            function showAgentInfo(agentId) {
                if (!agentInfoModal) return;
                const agent = personaData.find(p => p.id === agentId);
                if (!agent) return;
                if (agentInfoAvatar) agentInfoAvatar.src = agent.largeImg || agent.smallImg;
                if (agentInfoName) agentInfoName.textContent = agent.name;
                if (agentInfoRole) agentInfoRole.textContent = agent.title;
                if (agentInfoDescription) agentInfoDescription.textContent = agent.description;
                openModal(agentInfoModal);
            }
            
            function getSelectedAgentsInfo() {
                return selectedAgents.map(id => personaData.find(p => p.id === id)).filter(Boolean);
            }
            
            // --- Mode Toggle Functions ---
            function toggleMode() {
                isMultiAgentMode = true;
                
                const singleAgentDisplay = document.getElementById('singleAgentDisplay');
                const multiAgentContent = document.getElementById('multiAgentContent');
                
                if (singleAgentDisplay) singleAgentDisplay.classList.remove('active');
                if (multiAgentContent) multiAgentContent.classList.remove('hidden');
                
                updateModeStatusLabel();
            }
            
            function updateModeStatusLabel() {
                if (!modeStatusLabel) return;
                const isMulti = selectedAgents.length > 1;
                modeStatusLabel.textContent = isMulti ? 'Multi Agent Mode' : 'Single Agent Mode';
                modeStatusLabel.classList.toggle('mode-status-multi', isMulti);
                modeStatusLabel.classList.toggle('mode-status-single', !isMulti);
            }
            
            function updateSingleAgentDisplay(agentId) {
                const agent = personaData.find(p => p.id === agentId);
                if (!agent) return;
                
                const avatar = document.getElementById('singleAgentAvatar');
                const name = document.getElementById('singleAgentName');
                const title = document.getElementById('singleAgentTitle');
                const description = document.getElementById('singleAgentDescription');
                const selectorBtn = document.getElementById('agentSelectorBtn');
                
                if (avatar) avatar.src = agent.largeImg;
                if (name) name.textContent = agent.name;
                if (title) title.textContent = agent.title;
                if (description) description.textContent = agent.description;
                
                // Update selector button - only avatar and chevron, no name
                if (selectorBtn) {
                    const btnImg = selectorBtn.querySelector('img');
                    if (btnImg) btnImg.src = agent.smallImg;
                    // Remove name span if exists, keep only img and chevron icon
                    const spans = selectorBtn.querySelectorAll('span');
                    spans.forEach(span => span.remove());
                }
            }
            
            function showAgentSelectorMenu() {
                // Create dropdown menu
                const existingMenu = document.getElementById('agentSelectorMenu');
                if (existingMenu) {
                    existingMenu.remove();
                    return;
                }
                
                const menu = document.createElement('div');
                menu.id = 'agentSelectorMenu';
                
                // Get button position for fixed positioning
                const selectorBtn = document.getElementById('agentSelectorBtn');
                let menuStyle = '';
                
                if (selectorBtn) {
                    const rect = selectorBtn.getBoundingClientRect();
                    const isMobile = window.innerWidth <= 768;
                    
                    if (isMobile) {
                        // On mobile, use fixed positioning relative to viewport
                        menuStyle = `
                            position: fixed;
                            bottom: ${window.innerHeight - rect.top + 8}px;
                            left: ${rect.left}px;
                            right: auto;
                            background: var(--container-bg);
                            backdrop-filter: blur(30px);
                            border: 2px solid var(--primary-blue);
                            border-radius: 14px;
                            padding: 8px;
                            box-shadow: 0 -8px 30px rgba(0, 169, 157, 0.4);
                            z-index: 10000;
                            min-width: 220px;
                            max-width: calc(100vw - ${rect.left + 20}px);
                            animation: slideUpFadeIn 0.3s ease;
                        `;
                    } else {
                        // On desktop, use absolute but ensure it's not clipped
                        menuStyle = `
                            position: fixed;
                            bottom: ${window.innerHeight - rect.top + 8}px;
                            left: ${rect.left}px;
                            right: auto;
                            background: var(--container-bg);
                            backdrop-filter: blur(30px);
                            border: 2px solid var(--primary-blue);
                            border-radius: 14px;
                            padding: 8px;
                            box-shadow: 0 -8px 30px rgba(0, 169, 157, 0.4);
                            z-index: 10000;
                            min-width: 220px;
                            max-width: calc(100vw - ${rect.left + 20}px);
                            animation: slideUpFadeIn 0.3s ease;
                        `;
                    }
                } else {
                    // Fallback to absolute if button not found
                    menuStyle = `
                        position: absolute;
                        bottom: calc(100% + 8px);
                        left: 0;
                        background: var(--container-bg);
                        backdrop-filter: blur(30px);
                        border: 2px solid var(--primary-blue);
                        border-radius: 14px;
                        padding: 8px;
                        box-shadow: 0 -8px 30px rgba(0, 169, 157, 0.4);
                        z-index: 10000;
                        min-width: 220px;
                        animation: slideUpFadeIn 0.3s ease;
                    `;
                }
                
                menu.style.cssText = menuStyle;
                
                // Add animation keyframes
                if (!document.getElementById('agentMenuAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'agentMenuAnimation';
                    style.textContent = `
                        @keyframes slideUpFadeIn {
                            from {
                                opacity: 0;
                                transform: translateY(10px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                personaData.forEach(agent => {
                    const item = document.createElement('div');
                    const isSelected = agent.id === currentPersonaId;
                    item.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px;
                        margin: 4px 0;
                        border-radius: 10px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        ${isSelected ? 
                            'background: linear-gradient(135deg, rgba(0, 169, 157, 0.25), rgba(0, 169, 157, 0.35)); border: 2px solid var(--primary-blue);' : 
                            'border: 2px solid transparent; background: rgba(255, 255, 255, 0.05);'}
                    `;
                    
                    item.innerHTML = `
                        <img src="${agent.smallImg}" 
                             style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid ${isSelected ? 'var(--primary-blue)' : 'var(--border-color)'}; box-shadow: 0 2px 8px rgba(0, 169, 157, 0.3);" 
                             alt="${agent.name}">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.9rem; color: var(--text-dark);">${agent.name}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; color: var(--text-light);">${agent.title}</div>
                        </div>
                        ${isSelected ? '<i class="fas fa-check" style="color: var(--primary-blue); font-size: 1rem;"></i>' : ''}
                    `;
                    
                    item.addEventListener('mouseenter', () => {
                        if (agent.id !== currentPersonaId) {
                            item.style.background = 'linear-gradient(135deg, rgba(0, 169, 157, 0.15), rgba(0, 169, 157, 0.25))';
                            item.style.borderColor = 'rgba(0, 169, 157, 0.5)';
                            item.style.transform = 'translateX(3px)';
                        }
                    });
                    
                    item.addEventListener('mouseleave', () => {
                        if (agent.id !== currentPersonaId) {
                            item.style.background = 'rgba(255, 255, 255, 0.05)';
                            item.style.borderColor = 'transparent';
                            item.style.transform = 'translateX(0)';
                        }
                    });
                    
                    item.addEventListener('click', () => {
                        updatePersonaUI(agent.id);
                        updateSingleAgentDisplay(agent.id);
                        menu.style.animation = 'slideUpFadeIn 0.2s ease reverse';
                        if (menu._cleanup) menu._cleanup();
                        setTimeout(() => {
                            if (menu.parentNode) menu.remove();
                        }, 200);
                    });
                    
                    menu.appendChild(item);
                });
                
                // Append menu to body instead of button to avoid overflow clipping
                document.body.appendChild(menu);
                
                // Update position on scroll/resize
                const updateMenuPosition = () => {
                    const selectorBtn = document.getElementById('agentSelectorBtn');
                    if (selectorBtn && menu.parentNode) {
                        const rect = selectorBtn.getBoundingClientRect();
                        menu.style.bottom = `${window.innerHeight - rect.top + 8}px`;
                        menu.style.left = `${rect.left}px`;
                        menu.style.maxWidth = `calc(100vw - ${rect.left + 20}px)`;
                    }
                };
                
                window.addEventListener('scroll', updateMenuPosition, true);
                window.addEventListener('resize', updateMenuPosition);
                
                // Store cleanup function
                menu._cleanup = () => {
                    window.removeEventListener('scroll', updateMenuPosition, true);
                    window.removeEventListener('resize', updateMenuPosition);
                };
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!menu.contains(e.target) && e.target.id !== 'agentSelectorBtn' && !e.target.closest('#agentSelectorBtn')) {
                            menu.style.animation = 'slideUpFadeIn 0.2s ease reverse';
                            if (menu._cleanup) menu._cleanup();
                            setTimeout(() => {
                                if (menu.parentNode) menu.remove();
                            }, 200);
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }

            function renderPersonaOptions() {
                 if (!personaOptionsContainer) return;
                personaOptionsContainer.innerHTML = '';
                personaData.forEach(persona => {
                    const div = document.createElement('div');
                    div.className = `persona-option ${persona.id === currentPersonaId ? 'selected' : ''}`;
                    div.innerHTML = `
                        <img src="${persona.smallImg}" alt="${persona.name}">
                        <div class="persona-details">
                            <h4>${persona.name} - ${persona.title}</h4>
                            <p>${persona.description}</p>
                        </div>
                    `;

                    div.addEventListener('click', () => {
                        updatePersonaUI(persona.id);
                        closeModal(personaModal);
                    });
                    personaOptionsContainer.appendChild(div);
                });
            }

            // --- Modal Management ---
            function openModal(modal) {
                 if (!modal) return;
                 if (modal === personaModal) renderPersonaOptions();
                 modal.style.display = "flex";
            }
            function closeModal(modal) {
                 if (!modal) return;
                modal.style.display = "none";
            }

            // Simple message modal
            function showMessageModal(text, title = 'Notice') {
                if(messageModalTitle) messageModalTitle.textContent = title;
                if(messageModalText) messageModalText.textContent = text;
                if(messageModal) openModal(messageModal);
            }

            // --- Agenda & Calendar ---
             function setupAgendaInteractions() {
                 document.querySelectorAll('.event').forEach(eventEl => {
                     eventEl.addEventListener('click', () => {
                         const title = eventEl.dataset.eventTitle;
                         const time = eventEl.dataset.eventTime;
                         const details = eventEl.dataset.eventDetails;
                         const dateStr = eventEl.dataset.date;
                         openEventModal(title, time, details, dateStr, eventEl);
                     });
                 });
             }

            function openEventModal(title, time, details, dateStr = null, eventElement = null) {
                 const titleEl = document.getElementById('event-modal-title');
                const timeEl = document.getElementById('event-modal-time');
                const detailsEl = document.getElementById('event-modal-details');

                if (titleEl) titleEl.textContent = title;
                if (timeEl) timeEl.textContent = time;
                if (detailsEl) detailsEl.textContent = details;

                const summarizeBtn = document.getElementById('summarize-event-btn');
                const prepareBtn = document.getElementById('prepare-event-btn');

                if (!summarizeBtn || !prepareBtn) return;

                // Check if event is in the past (date + time)
                const isPast = dateStr ? isEventInPast(dateStr, time) : false;

                // Clone and replace buttons to remove old event listeners
                const newSummarizeBtn = summarizeBtn.cloneNode(true);
                summarizeBtn.parentNode.replaceChild(newSummarizeBtn, summarizeBtn);
                const newPrepareBtn = prepareBtn.cloneNode(true);
                prepareBtn.parentNode.replaceChild(newPrepareBtn, prepareBtn);

                // Summaries only for completed meetings
                if (isPast) {
                    newSummarizeBtn.style.display = '';
                } else {
                    newSummarizeBtn.style.display = 'none';
                }

                // Hide prepare button for past meetings
                if (isPast) {
                    newPrepareBtn.style.display = 'none';
                } else {
                    newPrepareBtn.style.display = '';
                }

                newSummarizeBtn.addEventListener('click', () => {
                    const prompt = isPast 
                        ? `Please provide a brief summary for my past event: "${title}".`
                        : `Please provide a brief summary for my upcoming event: "${title}".`;
                    switchToAgentAndSendPrompt(prompt);
                });
				
				newPrepareBtn.addEventListener('click', () => {
                    const prompt = `What preparations do I need for my event: "${title}"? Please consult and advise.`;
                    switchToAgentAndSendPrompt(prompt, 'nouf');

					// Route
				    const { leadAgent, activeAgents } = selectLeadAgent(
				        prompt,
				        ['nouf', 'omar', 'layla', 'hakim']
				    );
				
				    isMultiAgentMode = true;
				
				    // Agents respond (UI already ready)
				    activeAgents.forEach(aid => {
				        sendMessageToAgent(prompt, aid, { silent: aid !== leadAgent });
				    });
				
				    closeModal(document.getElementById('event-modal'));
								});

                openModal(eventModal);
            }

            function switchToAgentAndSendPrompt(prompt, targetPersonaId = null) {
                closeModal(eventModal);
                closeModal(dayActionModal);
                closeModal(meetingsModal);

                // Switch persona if specified
                if (targetPersonaId && targetPersonaId !== currentPersonaId) {
                    updatePersonaUI(targetPersonaId); // This will reset history and show greeting
                }

                const agentButton = document.querySelector('.nav-button[data-target="agent-page"]');
                if (agentButton && !agentButton.classList.contains('active')) { // Only click if not already active
                    agentButton.click();
                }

                if (chatInput) {
                    chatInput.value = prompt;
                    // Need a slight delay if persona just switched, otherwise greeting might overlap
                    if (targetPersonaId) {
                         setTimeout(handleSendMessage, 100); // Small delay
                    } else {
                        handleSendMessage();
                    }
                }
            }

            function buildMeetingColumns(eventsArray, parentEl) {
                const now = getRiyadhDate();
                const todayDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const categories = {
                    today: [],
                    future: [],
                    past: []
                };

                const deduped = [];
                const seen = new Set();
                eventsArray.forEach(eventEl => {
                    if (!eventEl || !eventEl.dataset) return;
                    const key = `${eventEl.dataset.date}-${eventEl.dataset.eventTitle}-${eventEl.dataset.eventTime}`;
                    if (seen.has(key)) return;
                    seen.add(key);
                    deduped.push(eventEl);
                });

                deduped.forEach(eventEl => {
                    const eventDateStr = eventEl.dataset.date;
                    if (!eventDateStr) {
                        categories.future.push(eventEl);
                        return;
                    }

                    if (isEventInPast(eventDateStr, eventEl.dataset.eventTime, now)) {
                        categories.past.push(eventEl);
                        return;
                    }

                    const eventDate = new Date(eventDateStr + 'T00:00:00');
                    if (eventDate.toDateString() === todayDateOnly.toDateString()) {
                        categories.today.push(eventEl);
                    } else {
                        categories.future.push(eventEl);
                    }
                });

                const sortEvents = (eventsArray, order = 'asc') => {
                    return eventsArray.sort((a, b) => {
                        const dateA = a.dataset.date || '';
                        const dateB = b.dataset.date || '';
                        if (dateA !== dateB) {
                            return order === 'asc' ? dateA.localeCompare(dateB) : dateB.localeCompare(dateA);
                        }
                        const minutesA = parseEventTimeToMinutes(a.dataset.eventTime || '');
                        const minutesB = parseEventTimeToMinutes(b.dataset.eventTime || '');
                        return order === 'asc' ? minutesA - minutesB : minutesB - minutesA;
                    });
                };

                const columns = [
                    { key: 'today', title: "Today's Meetings", events: sortEvents(categories.today, 'asc') },
                    { key: 'future', title: 'Upcoming Meetings', events: sortEvents(categories.future, 'asc') },
                    { key: 'past', title: 'Past Meetings', events: sortEvents(categories.past, 'desc') }
                ];

                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const dateObj = new Date(dateStr + 'T00:00:00');
                    return dateObj.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const columnsWrapper = document.createElement('div');
                columnsWrapper.className = 'meeting-columns-grid';

                columns.forEach(column => {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'meeting-column';
                    columnEl.innerHTML = `<div class="meeting-column-title">${column.title}</div>`;

                    const columnList = document.createElement('div');
                    columnList.className = 'meeting-column-list';

                    if (column.events.length === 0) {
                        columnList.innerHTML = `<div class="meeting-column-empty">No meetings in this category.</div>`;
                    } else {
                        column.events.forEach(eventEl => {
                            const eventTitle = eventEl.dataset.eventTitle || 'Untitled Meeting';
                            const eventTime = eventEl.dataset.eventTime || 'â€”';
                            const eventDateStr = eventEl.dataset.date;
                            const eventDetails = eventEl.dataset.eventDetails || '';
                            const isPast = column.key === 'past';

                            const item = document.createElement('div');
                            item.className = `meeting-item${isPast ? ' past-meeting' : ''}`;
                            item.innerHTML = `
                                <div class="meeting-title">${eventTitle}</div>
                                <div class="meeting-time">${eventTime}</div>
                                <div class="meeting-date">${formatDate(eventDateStr)}</div>
                            `;

                            item.addEventListener('click', () => {
                                closeModal(meetingsModal);
                                openEventModal(eventTitle, eventTime, eventDetails, eventDateStr, eventEl);
                            });

                            columnList.appendChild(item);
                        });
                    }

                    columnEl.appendChild(columnList);
                    columnsWrapper.appendChild(columnEl);
                });

                parentEl.appendChild(columnsWrapper);
            }
				
			function selectLeadAgent(prompt, allowedAgents) {
			    const lower = prompt.toLowerCase();
			
			    // Filter to only active agents you passed in
			    const active = personaData
			        .filter(a => allowedAgents.includes(a.id) && a.isActive)
			        .map(a => a.id);
			
			    // PRIORITY ROUTING LOGIC
			    // 1. Consulting / preparation / strategy â†’ Nouf
			    if (lower.includes("prepare") ||
			        lower.includes("preparation") ||
			        lower.includes("consult") ||
			        lower.includes("advise") ||
			        lower.includes("guidance") ||
			        lower.includes("analysis") ||
			        lower.includes("insight")) {
			        if (active.includes("nouf")) {
			            return { leadAgent: "nouf", activeAgents: active };
			        }
			    }
			
			    // 2. Operations / scheduling â†’ Omar
			    if (lower.includes("schedule") ||
			        lower.includes("meeting") && !lower.includes("prepare") ||
			        lower.includes("coordinate") ||
			        lower.includes("arrange")) {
			        if (active.includes("omar")) {
			            return { leadAgent: "omar", activeAgents: active };
			        }
			    }
			
			    // 3. Data / charts â†’ Layla
			    if (lower.includes("chart") ||
			        lower.includes("data") ||
			        lower.includes("graph") ||
			        lower.includes("statistics") ||
			        lower.includes("report")) {
			        if (active.includes("layla")) {
			            return { leadAgent: "layla", activeAgents: active };
			        }
			    }
			
			    // 4. Fallback â†’ Hakim (executive reasoning)
			    if (active.includes("hakim")) {
			        return { leadAgent: "hakim", activeAgents: active };
			    }
			
			    // Safety fallback (should never happen)
			    return { leadAgent: active[0], activeAgents: active };
			}



            function openMeetingsModal(topicId, topicTitle) {
                const list = document.getElementById('meetings-modal-list');
                const title = document.getElementById('meetings-modal-title');
                if (!list || !title) return;

                list.innerHTML = '';
                title.textContent = `Meetings Related to "${topicTitle}"`;

                const relatedEvents = Array.from(document.querySelectorAll(`.event[data-topic="${topicId}"]`));
                buildMeetingColumns(relatedEvents, list);

                openModal(meetingsModal);
            }

            function takeActionFromTopic(prompt) {
                 closeModal(meetingsModal);
                const agentButton = document.querySelector('.nav-button[data-target="agent-page"]');
                if (agentButton) agentButton.click();

                if (chatInput) {
                    chatInput.value = prompt;
                    handleSendMessage();
                }
            }

            // --- Chat & Gemini API ---
            function displayMessage(sender, text, agentId = null) {
                if (!chatMessages) {
                    console.error("chatMessages element not found.");
                    return;
                }
                
                // If agentId is explicitly false, hide avatar (for tool outputs)
                const hideAvatar = (agentId === false);
                
                // Use provided agentId or fall back to currentPersonaId
                const personaId = (agentId && agentId !== false) ? agentId : currentPersonaId;
                const persona = personaData.find(p => p.id === personaId);
                const avatarSrc = sender === 'user'
                    ? 'https://pbs.twimg.com/profile_images/1902451967101636610/TQ-VQEPY_400x400.jpg'
                    : (persona ? persona.smallImg : 'https://placehold.co/40x40/00A99D/ffffff?text=AI');

                const messageBubble = document.createElement('div');
                messageBubble.className = `message-bubble ${sender}`;
                if (hideAvatar) messageBubble.classList.add('no-avatar');

                // Create avatar image (skip if hideAvatar)
                let avatarImg = null;
                if (!hideAvatar) {
                    avatarImg = document.createElement('img');
                    avatarImg.src = avatarSrc;
                    avatarImg.alt = `${sender} Avatar`;
                    avatarImg.className = 'avatar';
                    if (sender === 'agent') {
                        avatarImg.setAttribute('data-persona-avatar', '');
                    }
                }

                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';
                
                // Add agent name tag and copy button above message
                if (sender === 'agent' && !hideAvatar) {
                    const messageHeader = document.createElement('div');
                    messageHeader.className = 'message-header';
                    
                    if (persona) {
                        const agentTag = document.createElement('span');
                        agentTag.className = 'agent-name-tag';
                        agentTag.textContent = persona.name;
                        messageHeader.appendChild(agentTag);
                    }
                    
                    // Add copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-message-btn';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.title = 'Copy message';
                    copyBtn.addEventListener('click', async () => {
                        // Get rendered content (preserves table structure)
                        const renderedContent = contentDiv.cloneNode(true);
                        // Remove the header from the clone
                        const headerInClone = renderedContent.querySelector('.message-header');
                        if (headerInClone) headerInClone.remove();
                        
                        // Try to copy as HTML (for rich text) and plain text
                        try {
                            const htmlContent = renderedContent.innerHTML;
                            const textContent = renderedContent.innerText;
                            
                            // Create clipboard items with both formats
                            const clipboardItem = new ClipboardItem({
                                'text/html': new Blob([htmlContent], { type: 'text/html' }),
                                'text/plain': new Blob([textContent], { type: 'text/plain' })
                            });
                            await navigator.clipboard.write([clipboardItem]);
                        } catch (e) {
                            // Fallback to plain text
                            await navigator.clipboard.writeText(renderedContent.innerText);
                        }
                        
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        copyBtn.classList.add('copied');
                        setTimeout(() => {
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    });
                    messageHeader.appendChild(copyBtn);
                    
                    contentDiv.appendChild(messageHeader);
                }

                let chartData = null;
                let textContent = text; // Keep original text by default
                let canvasId = null;
                const chartMarkerStart = '[CHART_DATA:';
                const chartMarkerEnd = ']';

                // Check for chart data marker if it's an agent message
                if (sender === 'agent') {
                    const startIndex = text.indexOf(chartMarkerStart);
                    const endIndex = text.lastIndexOf(chartMarkerEnd); // Find the last closing bracket

                    // Ensure both markers are found and the end is after the start
                    if (startIndex !== -1 && endIndex > startIndex) {
                        const jsonString = text.substring(startIndex + chartMarkerStart.length, endIndex).trim();
                        if (jsonString.startsWith('{') && jsonString.endsWith('}')) {
                            try {
                                chartData = JSON.parse(jsonString);
                                if (chartData.type && chartData.labels && chartData.datasets) {
                                    textContent = text.substring(0, startIndex).trim() + text.substring(endIndex + chartMarkerEnd.length).trim();
                                    canvasId = `chart-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                                    const chartContainer = document.createElement('div');
                                    chartContainer.className = 'chart-container';
                                    chartContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                                    contentDiv.appendChild(chartContainer);
                                } else {
                                     console.error("Parsed chart JSON is missing required properties (type, labels, datasets).", chartData);
                                     chartData = null;
                                     textContent = text;
                                }
                            } catch (e) {
                                console.error("Failed to parse chart JSON:", e, "JSON string:", jsonString);
                                textContent = text;
                                chartData = null;
                            }
                        } else {
                             console.warn("Potential chart data found but doesn't appear to be valid JSON object:", jsonString);
                             textContent = text;
                             chartData = null;
                        }
                    }

                    // Render textContent as Markdown
                    if (textContent && typeof marked !== 'undefined' && marked.parse) {
                        try {
                             const textDiv = document.createElement('div');
                             textDiv.innerHTML = marked.parse(textContent);
                             contentDiv.appendChild(textDiv); // Changed from insertBefore
                        } catch (e) {
                            console.error("Markdown parsing error:", e);
                            const textDiv = document.createElement('div');
                            textDiv.textContent = textContent;
                            contentDiv.appendChild(textDiv);
                        }
                    } else if (textContent) {
                         const textDiv = document.createElement('div');
                         textDiv.textContent = textContent;
                         contentDiv.appendChild(textDiv);
                    }
                } else {
                    // User message - simple text
                    contentDiv.textContent = textContent;
                }

                // For user messages, append content first, then avatar (so avatar appears on right)
                // For agent messages, append avatar first, then content (so avatar appears on left)
                // Tool messages have no avatar
                if (sender === 'user') {
                    messageBubble.appendChild(contentDiv);
                    if (avatarImg) messageBubble.appendChild(avatarImg);
                } else {
                    if (avatarImg) messageBubble.appendChild(avatarImg);
                    messageBubble.appendChild(contentDiv);
                }

                 // Append the complete bubble to chatMessages
                if (chatMessages) { // Ensure chatMessages exists
                    chatMessages.appendChild(messageBubble); // Error might have happened here if messageBubble was invalid

					// Scroll logic and chart rendering timeout remain the same
                    if (chartData && canvasId && sender === 'agent') {
                         setTimeout(() => {
                            const canvasElement = document.getElementById(canvasId);
                            if (canvasElement) { renderChart(canvasElement, chartData); }
                            else { console.error(`Canvas element with ID ${canvasId} not found.`); }
                            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
                         }, 0);
                    } else {
                            // Only auto-scroll if the user is already near the bottom
						    const isNearBottom =
						        chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 150;
						
						    if (isNearBottom) {
						        setTimeout(() => {
						            chatMessages.scrollTop = chatMessages.scrollHeight;
						        }, 0);
						    }
						}
                } else {
                    console.error("chatMessages element not found when trying to append message.");
                }
            }


            // Function to render chart using Chart.js
             function renderChart(canvasElement, chartData) {
                 if (!canvasElement || !chartData || !chartData.type || !chartData.labels || !chartData.datasets) {
                     console.error("Invalid chart data or canvas element provided for rendering.");
                     if (canvasElement && canvasElement.parentElement) {
                        canvasElement.parentElement.innerHTML = "<p style='color: #ffcccc; padding: 10px;'>Could not render chart: Invalid data format.</p>";
                     }
                     return;
                 }
                 
                 // Check if Chart.js is available
                 if (typeof Chart === 'undefined') {
                     console.error("Chart.js library is not loaded.");
                     if (canvasElement && canvasElement.parentElement) {
                        canvasElement.parentElement.innerHTML = "<p style='color: #ffcccc; padding: 10px;'>Chart library not available.</p>";
                     }
                     return;
                 }
                 
                 const ctx = canvasElement.getContext('2d');
                 if (!ctx) {
                     console.error("Could not get canvas context.");
                      if (canvasElement && canvasElement.parentElement) {
                        canvasElement.parentElement.innerHTML = "<p style='color: #ffcccc; padding: 10px;'>Canvas error.</p>";
                     }
                     return;
                 }

                 // Chart types that don't use scales
                 const noScaleTypes = ['pie', 'doughnut', 'polarArea'];
                 const useScales = !noScaleTypes.includes(chartData.type);

                 // Basic Chart.js options
                 const options = {
                     responsive: true,
                     maintainAspectRatio: true,
                     plugins: {
                         legend: {
                             labels: {
                                 color: 'rgba(255, 255, 255, 0.8)'
                             }
                         }
                     }
                 };
                 
                 // Only add scales for chart types that support them
                 if (useScales) {
                     options.scales = {
                         y: {
                             beginAtZero: true,
                             ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                             grid: { color: 'rgba(255, 255, 255, 0.1)' }
                         },
                         x: {
                             ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                             grid: { color: 'rgba(255, 255, 255, 0.1)' }
                         }
                     };
                 }

                 // Default colors if not provided by AI
                 const defaultBackgroundColors = [
                     'rgba(0, 169, 157, 0.6)', 'rgba(255, 193, 7, 0.6)', 'rgba(0, 123, 255, 0.6)',
                     'rgba(220, 53, 69, 0.6)', 'rgba(40, 167, 69, 0.6)', 'rgba(23, 162, 184, 0.6)'
                    ];
                 const defaultBorderColors = [
                      'rgba(0, 169, 157, 1)', 'rgba(255, 193, 7, 1)', 'rgba(0, 123, 255, 1)',
                      'rgba(220, 53, 69, 1)', 'rgba(40, 167, 69, 1)', 'rgba(23, 162, 184, 1)'
                    ];

                 // Ensure datasets have colors and valid data
                 chartData.datasets.forEach((dataset, index) => {
                    if (!Array.isArray(dataset.data)) {
                        console.warn(`Dataset ${index} has invalid or missing 'data' array.`);
                        dataset.data = [];
                    }
                    
                    if (dataset.data.length > 0) {
                        if (!dataset.backgroundColor) {
                            if (chartData.type === 'line' || chartData.type === 'radar') {
                                dataset.backgroundColor = defaultBackgroundColors[index % defaultBackgroundColors.length].replace('0.6', '0.2');
                                dataset.borderColor = defaultBorderColors[index % defaultBorderColors.length];
                                dataset.borderWidth = 2;
                                dataset.fill = true;
                            } else {
                                dataset.backgroundColor = dataset.data.map((_, i) => defaultBackgroundColors[i % defaultBackgroundColors.length]);
                                dataset.borderColor = dataset.data.map((_, i) => defaultBorderColors[i % defaultBorderColors.length]);
                                dataset.borderWidth = 1;
                            }
                        }
                    }
                 });

                 try {
                     new Chart(ctx, {
                         type: chartData.type,
                         data: {
                             labels: chartData.labels,
                             datasets: chartData.datasets
                         },
                         options: options
                     });
                 } catch (e) {
                     console.error("Chart.js rendering error:", e);
                     console.error("Chart data:", chartData);
                     canvasElement.parentElement.innerHTML = `<p style='color: #ffcccc; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;'âš ï¸ Chart rendering failed: ${e.message || 'Unknown error'}</p>`;
                 }
            }


            function showTypingIndicator() {
                if (!chatMessages) return;
                removeTypingIndicator(); // Ensure only one indicator

                const typingBubble = document.createElement('div');
                typingBubble.id = 'typing-indicator';
                typingBubble.className = 'message-bubble agent';

                typingBubble.innerHTML = `
                    <div class="content">
                       <div class="typing-indicator">
                            <span></span><span></span><span></span>
                       </div>
                    </div>
                `;
                chatMessages.appendChild(typingBubble);
                 setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 0);
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }

            // --- Document Upload & Summarization ---
            function initDocumentUpload() {
                const uploadBtn = document.getElementById('upload-btn');
                const fileInput = document.getElementById('file-input');
                
                if (!uploadBtn || !fileInput) return;

                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                });

                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Reset input for future uploads
                    fileInput.value = '';
                    
                    // Set processing state
                    uploadBtn.classList.add('upload-processing');
                    const icon = uploadBtn.querySelector('i');
                    if (icon) icon.className = 'fas fa-spinner';
                    
                    try {
                        // Extract text from file
                        const text = await extractTextFromFile(file);
                        
                        if (!text || text.trim().length === 0) {
                            displayMessage('agent', "I couldn't extract any text from that file. Please try a different file format (.txt, .pdf, .docx).", false);
                            resetUploadBtn();
                            return;
                        }
                        
                        // Truncate if too long
                        const maxChars = 150000;
                        const truncatedText = text.length > maxChars 
                            ? text.substring(0, maxChars) + '\n\n...[Document truncated for processing]' 
                            : text;
                        
                        // Create the prompt with document content
                        const documentPrompt = `ðŸ“„ I've uploaded a document titled "${file.name}". Please provide a comprehensive summary.

Structure your response with:
1. **Executive Summary** (2-3 sentences overview)
2. **Key Points** (bullet points of main takeaways)
3. **Important Details** (any specifics worth noting)

Document content:
---
${truncatedText}
---`;
                        
                        // Display user message about upload
                        displayMessage('user', `ðŸ“„ Uploaded: ${file.name}`);
                        
                        // Add to chat history so agents can reference it for follow-up questions
                        chatHistory.push({ role: 'user', parts: [{ text: documentPrompt }] });
                        
                        // Use the existing agent messaging system
                        if (isMultiAgentMode) {
                            showTypingIndicator();
                            await orchestrateMultiAgentResponse(documentPrompt);
                        } else {
                            const selectedAgent = selectedAgents.length > 0 ? selectedAgents[0] : currentPersonaId;
                            showTypingIndicator();
                            await sendMessageToAgent(documentPrompt, selectedAgent);
                        }
                        
                        // Brief success state
                        uploadBtn.classList.remove('upload-processing');
                        uploadBtn.classList.add('upload-success');
                        if (icon) icon.className = 'fas fa-paperclip';
                        setTimeout(() => {
                            uploadBtn.classList.remove('upload-success');
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Upload error:', error);
                        removeTypingIndicator();
                        displayMessage('agent', "Sorry, I had trouble processing that file. Please try again with a different file.", false);
                        resetUploadBtn();
                    }
                    
                    function resetUploadBtn() {
                        uploadBtn.classList.remove('upload-processing');
                        if (icon) icon.className = 'fas fa-paperclip';
                    }
                });

                async function extractTextFromFile(file) {
                    const fileType = file.name.split('.').pop().toLowerCase();
                    
                    if (fileType === 'txt' || fileType === 'md') {
                        return await file.text();
                    }
                    
                    if (fileType === 'pdf') {
                        return await extractPDFText(file);
                    }
                    
                    if (fileType === 'doc' || fileType === 'docx') {
                        return await extractDocxText(file);
                    }
                    
                    throw new Error('Unsupported file type: ' + fileType);
                }

                // PDF text extraction using PDF.js
                async function extractPDFText(file) {
                    if (!window.pdfjsLib) {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    }
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    
                    return fullText;
                }

                // DOCX extraction using mammoth.js
                async function extractDocxText(file) {
                    if (!window.mammoth) {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js');
                    }
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    return result.value;
                }

                // Helper to load external scripts dynamically
                function loadScript(src) {
                    return new Promise((resolve, reject) => {
                        if (document.querySelector(`script[src="${src}"]`)) {
                            resolve();
                            return;
                        }
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }

            }

            async function handleSendMessage() {
                if (!chatInput) return;
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;

                displayMessage('user', userMessage);
                // Add user message to history *before* calling API
                chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });
                chatInput.value = '';
                // Reset button toggle after sending
                const controls = document.querySelector('.chat-input-controls');
                if (controls) controls.classList.remove('has-text');
                
                if (isMultiAgentMode) {
                    // Multi-agent mode: Hakim orchestrates and routes to appropriate agents
                    await orchestrateMultiAgentResponse(userMessage);
                } else {
                    // Single agent mode: send to the selected agent (use selectedAgents[0] instead of currentPersonaId)
                    const selectedAgent = selectedAgents.length > 0 ? selectedAgents[0] : currentPersonaId;
                    showTypingIndicator();
                    await sendMessageToAgent(userMessage, selectedAgent);
                }
            }
            
            // Smart agent orchestration: Hakim analyzes prompt and routes to appropriate agents
            // Replace existing orchestrateMultiAgentResponse with this improved version
            async function orchestrateMultiAgentResponse(userMessage) {
                const agents = getSelectedAgentsInfo();

                if (agents.length === 1) {
                    showTypingIndicator();
                    await sendMessageToAgent(userMessage, agents[0].id);
                    return;
                }

                // Stronger orchestration prompt -- discourage including Hakim unless strictly necessary.
                const orchestrationPrompt = `You are Hakim NÃ¼ruddin, the AI Executive Office Agent coordinating a team of specialists. Analyze this user request and determine which agents should respond:

            User Request: "${userMessage}"

            Available Agents:
            ${agents.map(a => `- ${a.name} (${a.id}): ${a.title}`).join('\n')}

            Agent Specializations:
            - Hakim (hakim): Strategic insights, executive summaries, high-level decisions, leadership advice
            - Layla (layla): Data analysis, charts, statistics, metrics, trends, quantitative insights
            - Omar (omar): Operational coordination, task management, scheduling, workflow optimization
            - Nouf (nouf): In-depth analysis and consulting on specific strategic focus areas

            Instructions:
            1. Analyze the user's request carefully.
            2. Determine which agent(s) are MOST appropriate to answer.
            3. IMPORTANT: Do NOT include yourself (hakim) in the "agents" list unless the user explicitly requires a strategic/executive answer that only Hakim can deliver. Prefer specialists for concrete tasks (Layla/Omar/Nouf).
            4. Respond with ONLY a JSON object in this format:
            {
            "agents": ["agent_id1", "agent_id2"],
            "reasoning": "Brief explanation of why these agents"
            }

            RESPOND ONLY WITH VALID JSON. NO OTHER TEXT.`;

                try {
                    showTypingIndicator();
                    const orchestrationResponse = await sendOrchestrationRequest(orchestrationPrompt);
                    removeTypingIndicator();

                    if (!orchestrationResponse) {
                        console.warn("Orchestration failed, using all selected agents");
                        for (let i = 0; i < agents.length; i++) {
                            showTypingIndicator();
                            if (i > 0) await new Promise(resolve => setTimeout(resolve, 500));
                            // silent true so unsuccessful agents don't spam error messages
                            await sendMessageToAgent(userMessage, agents[i].id, 3, 1000, { silent: true });
                        }
                        return;
                    }

                    // Parse orchestration response
                    let routingDecision;
                    try {
                        let jsonText = orchestrationResponse.trim();
                        jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        routingDecision = JSON.parse(jsonText);
                    } catch (e) {
                        console.error("Failed to parse orchestration JSON:", e, orchestrationResponse);
                        // Fallback: use all selected agents (silent)
                        for (let i = 0; i < agents.length; i++) {
                            showTypingIndicator();
                            if (i > 0) await new Promise(resolve => setTimeout(resolve, 500));
                            await sendMessageToAgent(userMessage, agents[i].id, 3, 1000, { silent: true });
                        }
                        return;
                    }
                    // Filter to only active agents
                    const activeOnly = routingDecision.agents.filter(id =>
                        agents.some(a => a.id === id)   // agents = active agents
                    );

                    // Show routing note to the user (non-noisy)
                    const orchestrationNote = document.createElement('div');
                    orchestrationNote.className = 'agent-discussion-indicator';
                    orchestrationNote.style.fontSize = '0.85rem';
                    orchestrationNote.style.opacity = '0.85';

                    orchestrationNote.innerHTML = `<i class="fas fa-route"></i> Hakim routing to: ${activeOnly.map(id => {
                        const agent = personaData.find(p => p.id === id);
                        return agent ? agent.name.split(' ')[0] : id;
                    }).join(', ')}`;

                    if (chatMessages) {
                        chatMessages.appendChild(orchestrationNote);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }


                    // Filter only agents actually selected by the user
                    const selectedAgentIds = routingDecision.agents.filter(id =>
                        agents.some(a => a.id === id)
                    );

                    if (selectedAgentIds.length === 0) {
                        // fallback: use the first selected agent
                        selectedAgentIds.push(agents[0].id);
                    }

                    // Send to chosen agents. Use silent: true so non-responses don't become user-facing errors.
                    for (let i = 0; i < selectedAgentIds.length; i++) {
                        showTypingIndicator();
                        if (i > 0) await new Promise(resolve => setTimeout(resolve, 500));

                        const aid = selectedAgentIds[i];

                        // If Hakim is included, pass the safe responderSystemPrompt if defined
                        if (aid === 'hakim') {
                            const hakimPersona = personaData.find(p => p.id === 'hakim');
                            const override = (hakimPersona && hakimPersona.responderSystemPrompt) ? hakimPersona.responderSystemPrompt : null;
                            await sendMessageToAgent(userMessage, 'hakim', 3, 1000, { systemPromptOverride: override, silent: true });
                        } else {
                            await sendMessageToAgent(userMessage, aid, 3, 1000, { silent: true });
                        }
                    }

                } catch (error) {
                    console.error("Orchestration error:", error);
                    removeTypingIndicator();
                    // Fallback: send to all selected agents (silent)
                    for (let i = 0; i < agents.length; i++) {
                        showTypingIndicator();
                        if (i > 0) await new Promise(resolve => setTimeout(resolve, 500));
                        await sendMessageToAgent(userMessage, agents[i].id, 3, 1000, { silent: true });
                    }
                }
            }

            
            // Special function for orchestration requests (no display, just return response)
            async function sendOrchestrationRequest(prompt, retries = 2) {
                //const apiKey = "AIzaSyCRFXs-Ysnoy2swH1yjqZYoRMNC4HTpv_c";
				const apiKey = "AIzaSyCRFXs-Ysnoy2swH1yjqZYoRMNC4HTpv_c";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: 'You are an AI orchestrator. Respond ONLY with valid JSON. No explanations, no markdown, no extra text.' }]
                    },
                    generationConfig: {
                        maxOutputTokens: 512,
                        temperature: 0.3, // Lower temperature for more deterministic routing
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            return sendOrchestrationRequest(prompt, retries - 1);
                        }
                        throw new Error(`API error: ${response.status}`);
                    }

                    const result = await response.json();
                    const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    return responseText || null;
                    
                } catch (error) {
                    console.error("Orchestration request error:", error);
                    return null;
                }
            }
            
            async function sendMessageToAgent(message, agentId, retries = 3, delay = 1000) {
                // const apiKey = "AIzaSyCRFXs-Ysnoy2swH1yjqZYoRMNC4HTpv_c";
				const apiKey = "AIzaSyCRFXs-Ysnoy2swH1yjqZYoRMNC4HTpv_c";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const persona = personaData.find(p => p.id === agentId);
                const systemPromptText = persona ? persona.systemPrompt : 'You are a helpful assistant.';

                // Send the current, complete history
                const payload = {
                    contents: chatHistory,
                    systemInstruction: {
                        parts: [{ text: `${systemPromptText} Your user is a high-level executive ("Your Excellency"). The current date and time is ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Riyadh' })}. IMPORTANT: Do NOT start your response with a header line containing your name, title, and timestamp (like "HAKIM NÃœRUDDIN AI Executive Office Agent 12/4/2025..."). Start directly with your response content like "Your Excellency..." - keep the formal tone and structure, just skip the name/title header.` }]
                    },
                    generationConfig: {
                        maxOutputTokens: 8192,
                    },
                    safetySettings: [
                        { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                    ]
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    removeTypingIndicator();

                    if (!response.ok) {
                        if (!(response.status === 429 || response.status >= 500)) {
                           console.error(`API Error: ${response.status} ${response.statusText}`, await response.text());
                        }
                        if ((response.status === 429 || response.status >= 500) && retries > 0) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return sendMessageToAgent(message, agentId, retries - 1, delay * 2);
                        }
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const agentResponseText = candidate?.content?.parts?.[0]?.text;

                if (agentResponseText) {
                    displayMessage('agent', agentResponseText, agentId);
                    // Add successful AI response to history
                    chatHistory.push({ role: 'model', parts: [{ text: agentResponseText }] });
                } else {
                    // In multi-agent mode, silently skip empty responses (agent wasn't selected to respond)
                    if (isMultiAgentMode && !candidate?.finishReason && !result?.promptFeedback?.blockReason) {
                        // Silently skip - this agent wasn't meant to respond
                        console.log(`Agent ${agentId} returned empty response in multi-agent mode - skipping`);
                        return;
                    }
                    
                    let errorText = "I apologize, but I couldn't process that request fully. Please try rephrasing.";
                    if (candidate && candidate.finishReason && candidate.finishReason !== 'STOP') {
                        errorText = `I'm sorry, my response was stopped due to: ${candidate.finishReason.toLowerCase().replace(/_/g, ' ')}.`;
                        console.warn("Gemini finishReason:", candidate.finishReason, candidate.safetyRatings);
                    } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                        errorText = `I'm sorry, your prompt could not be processed due to: ${result.promptFeedback.blockReason.toLowerCase().replace(/_/g, ' ')}.`;
                        console.warn("Gemini promptFeedback:", result.promptFeedback);
                    } else if (!agentResponseText) {
                        console.warn("Gemini response missing text content:", result);
                        //errorText = "I received an empty response. Could you please try asking in a different way?";
                    }
                    displayMessage('agent', errorText, agentId);
                }
                } catch (error) {
                    console.error('Error fetching from Gemini API:', error.message);
                    removeTypingIndicator();
                    displayMessage('agent', "I'm experiencing network difficulties connecting to my services. Please check your connection or try again shortly.", agentId);
                }
            }
            
            async function startAgentDiscussion() {
                if (selectedAgents.length < 2) {
                    showMessageModal('Please select at least 2 agents to start a discussion', 'Notice');
                    return;
                }
                
                const agents = getSelectedAgentsInfo();
                const agentNames = agents.map(a => a.name).join(', ');
                
                // Show discussion start indicator
                const indicatorDiv = document.createElement('div');
                indicatorDiv.className = 'agent-discussion-indicator';
                indicatorDiv.textContent = `ðŸ”„ Agent discussion starting between: ${agentNames}`;
                if (chatMessages) {
                    chatMessages.appendChild(indicatorDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Store original history
                const originalHistory = [...chatHistory];
                
                // Create discussion-specific history
                const discussionHistory = [];
                const discussionContext = `Your Excellency has requested a collaborative discussion among the AI agents about today's priorities and key insights. Please share your perspective based on your area of expertise.`;
                
                // Each agent responds with their own context
                for (let i = 0; i < agents.length; i++) {
                    const agent = agents[i];
                    showTypingIndicator();
                    await new Promise(resolve => setTimeout(resolve, 800)); // Brief delay between agents
                    
                    // Create personalized prompt for each agent
                    let agentPrompt = discussionContext;
                    
                    if (i === 0) {
                        // First agent starts the discussion
                        agentPrompt += ` You are ${agent.name}, ${agent.title}. Please begin the discussion by sharing the most critical insights from your perspective.`;
                    } else {
                        // Subsequent agents respond to previous agent(s)
                        const previousAgentNames = agents.slice(0, i).map(a => a.name).join(' and ');
                        agentPrompt += ` You are ${agent.name}, ${agent.title}. ${previousAgentNames} have already shared their insights. Please add your perspective and build upon what has been discussed.`;
                        
                        // Include summary of previous responses
                        if (discussionHistory.length > 0) {
                            const previousSummary = discussionHistory.map((h, idx) => 
                                `${agents[idx].name}: ${h.text.substring(0, 200)}...`
                            ).join('\n');
                            agentPrompt += `\n\nPrevious contributions:\n${previousSummary}`;
                        }
                    }
                    
                    // Send to agent with clean context
                    const response = await sendMessageToAgentDiscussion(agentPrompt, agent.id, i === 0 ? [] : discussionHistory);
                    
                    if (response) {
                        discussionHistory.push({ role: 'model', parts: [{ text: response }], agentId: agent.id });
                    }
                }
                
                // Add the discussion to main chat history as a summary
                const discussionSummary = `Agent Discussion Summary:\n${agents.map((a, i) => 
                    `${a.name}: ${discussionHistory[i]?.parts[0]?.text?.substring(0, 150) || 'No response'}...`
                ).join('\n\n')}`;
                
                chatHistory.push({ role: 'user', parts: [{ text: 'Please have the agents discuss key priorities' }] });
                chatHistory.push({ role: 'model', parts: [{ text: discussionSummary }] });
                
                // End discussion indicator
                const endIndicatorDiv = document.createElement('div');
                endIndicatorDiv.className = 'agent-discussion-indicator';
                endIndicatorDiv.textContent = 'âœ“ Agent discussion completed';
                if (chatMessages) {
                    chatMessages.appendChild(endIndicatorDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            // New function for agent discussion with separate context
            // Replace your existing sendMessageToAgent with this updated function
            async function sendMessageToAgent(message, agentId, retries = 3, delay = 1000, options = {}) {
                // options: { systemPromptOverride: string|null, silent: boolean }
                options = Object.assign({ systemPromptOverride: null, silent: false }, options);

                // const apiKey = "AIzaSyCRFXs-Ysnoy2swH1yjqZYoRMNC4HTpv_c";
				const apiKey = "AIzaSyCRFXs-Ysnoy2swH1yjqZYoRMNC4HTpv_c";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const persona = personaData.find(p => p.id === agentId);
                // Prefer override if provided (this is the critical bit).
                const systemPromptText = options.systemPromptOverride || (persona ? persona.systemPrompt : 'You are a helpful assistant.');

                // Build payload - reuse chatHistory but keep it explicit
                const payload = {
                    contents: chatHistory,
                    systemInstruction: {
                        parts: [{ text: `${systemPromptText} Your user is a high-level executive ("Your Excellency"). The current date and time is ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Riyadh' })}. IMPORTANT: Do NOT start your response with a header line containing your name, title, and timestamp (like "HAKIM NÃœRUDDIN AI Executive Office Agent 12/4/2025..."). Start directly with your response content like "Your Excellency..." - keep the formal tone and structure, just skip the name/title header.` }]
                    },
                    generationConfig: {
                        maxOutputTokens: 8192,
                    },
                    safetySettings: [
                        { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                        { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
                    ]
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    removeTypingIndicator();

                    if (!response.ok) {
                        if (!(response.status === 429 || response.status >= 500)) {
                        console.error(`API Error: ${response.status} ${response.statusText}`, await response.text());
                        }
                        if ((response.status === 429 || response.status >= 500) && retries > 0) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return sendMessageToAgent(message, agentId, retries - 1, delay * 2, options);
                        }
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const agentResponseText = candidate?.content?.parts?.[0]?.text;

                    if (agentResponseText) {
                        displayMessage('agent', agentResponseText, agentId);
                        chatHistory.push({ role: 'model', parts: [{ text: agentResponseText }] });
                    } else {
                        // If multi-agent mode orchestrated this call and caller set silent, skip noisy error
                        if (isMultiAgentMode && options.silent) {
                            console.log(`Agent ${agentId} returned empty response in multi-agent mode - silent skip`);
                            return;
                        }

                        // previous heuristics retained but cleaned up
                        let errorText = "I apologize, but I couldn't process that request fully. Please try rephrasing.";
                        if (candidate && candidate.finishReason && candidate.finishReason !== 'STOP') {
                            errorText = `I'm sorry, my response was stopped due to: ${candidate.finishReason.toLowerCase().replace(/_/g, ' ')}.`;
                            console.warn("Gemini finishReason:", candidate.finishReason, candidate.safetyRatings);
                        } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                            errorText = `I'm sorry, your prompt could not be processed due to: ${result.promptFeedback.blockReason.toLowerCase().replace(/_/g, ' ')}.`;
                            console.warn("Gemini promptFeedback:", result.promptFeedback);
                        } else if (!agentResponseText) {
                            console.warn("Gemini response missing text content:", result);
                        }
                        displayMessage('agent', errorText, agentId);
                    }
                } catch (error) {
                    console.error('Error fetching from Gemini API:', error.message);
                    removeTypingIndicator();
                    // Only display the network/connection bubble when NOT silent
                    if (!options.silent) {
                        displayMessage('agent', "I'm experiencing network difficulties connecting to my services. Please check your connection or try again shortly.", agentId);
                    } else {
                        // Silent mode: log only
                        console.warn(`Silent-mode network error for ${agentId}:`, error.message);
                    }
                }
            }



            // --- UI & Event Listeners ---
            function updateTodaysAgendaPanel() {
                 if (!summaryContent) return;
                const now = getRiyadhDate();
                today = now;
                const todayStr = now.toISOString().split('T')[0];
                const allEvents = Array.from(document.querySelectorAll('.event[data-date]'));
                const todaysEvents = allEvents.filter(eventEl => eventEl.dataset.date === todayStr);

                const seen = new Set();
                const uniqueEvents = [];
                todaysEvents.forEach(eventEl => {
                    const key = `${eventEl.dataset.eventTitle}-${eventEl.dataset.eventTime}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueEvents.push(eventEl);
                    }
                });

                const upcomingEvents = uniqueEvents.filter(eventEl => !isEventInPast(eventEl.dataset.date, eventEl.dataset.eventTime, now));
                upcomingEvents.sort((a, b) => parseEventTimeToMinutes(a.dataset.eventTime || '') - parseEventTimeToMinutes(b.dataset.eventTime || ''));

                summaryContent.innerHTML = '';

                const attachAgendaClick = (element, eventEl) => {
                    element.classList.add('agenda-summary-item');
                    element.addEventListener('click', () => {
                        openEventModal(eventEl.dataset.eventTitle, eventEl.dataset.eventTime, eventEl.dataset.eventDetails, eventEl.dataset.date, eventEl);
                    });
                };

                if (upcomingEvents.length > 0) {
                    const nextEvent = upcomingEvents[0];
                    const laterEvents = upcomingEvents.slice(1);

                    const highlight = document.createElement('div');
                    highlight.className = 'urgent-meeting-highlight agenda-summary-item';
                    highlight.innerHTML = `<h2>Next Up: ${nextEvent.dataset.eventTitle} (${nextEvent.dataset.eventTime || ''})</h4><p>${nextEvent.dataset.eventDetails || ''}</p>`;
                    attachAgendaClick(highlight, nextEvent);
                    summaryContent.appendChild(highlight);

                    if (laterEvents.length > 0) {
                        const header = document.createElement('h4');
                        header.textContent = 'Later Today';
                        summaryContent.appendChild(header);

                        const list = document.createElement('ul');
                        laterEvents.forEach(eventEl => {
                            const item = document.createElement('li');
                            item.innerHTML = `<strong>${eventEl.dataset.eventTitle}</strong> (${eventEl.dataset.eventTime || ''})`;
                            attachAgendaClick(item, eventEl);
                            list.appendChild(item);
                        });
                        summaryContent.appendChild(list);
                    }
                } else {
                    summaryContent.innerHTML = `<h4>Today's Agenda</h4><p>No further meetings or milestones scheduled for today.</p>`;
                    const tomorrow = new Date(now);
                    tomorrow.setDate(now.getDate() + 1);
                    const tomorrowStr = tomorrow.toISOString().split('T')[0];
                    const tomorrowsEvents = allEvents.filter(eventEl => eventEl.dataset.date === tomorrowStr);
                    tomorrowsEvents.sort((a, b) => parseEventTimeToMinutes(a.dataset.eventTime || '') - parseEventTimeToMinutes(b.dataset.eventTime || ''));
                    if (tomorrowsEvents.length > 0) {
                        summaryContent.innerHTML += `<h4>Tomorrow's First Item: ${tomorrowsEvents[0].dataset.eventTitle} (${tomorrowsEvents[0].dataset.eventTime || ''})</h4>`;
                    }
                }
            }


            function setViewportHeight() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }

             // Calendar Toggle Button Logic
            function setupCalendarToggles() {
                document.querySelectorAll('.view-toggle').forEach(toggle => {
                    toggle.addEventListener('click', e => {
                        const button = e.target.closest('[data-view]');
                        if (!button) return;
                        const view = button.dataset.view;
                        const calendarContainer = button.closest('.desktop-calendar, .mobile-calendar');
                        if (!calendarContainer) return;
                        
                        // Get the previous active view before removing it
                        const previousActiveButton = calendarContainer.querySelector('[data-view].active');
                        const previousView = previousActiveButton ? previousActiveButton.dataset.view : null;
                        
                        calendarContainer.querySelectorAll('[data-view]').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        if (calendarContainer.classList.contains('desktop-calendar')) {
                            calendarContainer.querySelectorAll('.agenda-view').forEach(v => v.classList.remove('active'));
                            const targetView = calendarContainer.querySelector(`#${view}-view`);
                            if (targetView) targetView.classList.add('active');
                            if (view === 'month') { 
                                // When switching to month view from week view, sync month to current week's month
                                if (previousView === 'week') {
                                    // Set month to the month of the current week (use the middle day of the week)
                                    const weekMiddleDay = new Date(currentWeekStart);
                                    weekMiddleDay.setDate(currentWeekStart.getDate() + 3);
                                    currentMonth = new Date(weekMiddleDay.getFullYear(), weekMiddleDay.getMonth(), 1);
                                }
                                renderDesktopMonthCalendar(); 
                            }
                            if (view === 'today') { renderTodayView(); updateWeekHeader(); }
                            if (view === 'week') { 
                                // When switching to week view from month view, always go to current week
                                if (previousView === 'month') {
                                    // Reset to current week
                                    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                                    const day = todayDateOnly.getDay();
                                    const diff = todayDateOnly.getDate() - day;
                                    currentWeekStart = new Date(todayDateOnly);
                                    currentWeekStart.setDate(diff);
                                    currentWeekStart.setHours(0, 0, 0, 0);
                                }
                                renderWeekView(); 
                            }
                        } else {
                            // Mobile calendar view toggle
                            if (view === 'week') { 
                                // When switching to week view from month view, always go to current week
                                if (previousView === 'month') {
                                    // Reset to current week
                                    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                                    const day = todayDateOnly.getDay();
                                    const diff = todayDateOnly.getDate() - day;
                                    currentWeekStart = new Date(todayDateOnly);
                                    currentWeekStart.setDate(diff);
                                    currentWeekStart.setHours(0, 0, 0, 0);
                                }
                                initMobileCalendar(); 
                            }
                            if (view === 'today') { renderTodayView(); updateWeekHeader(); }
                            if (view === 'month') { 
                                // When switching to month view from week view, sync month to current week's month
                                if (previousView === 'week') {
                                    // Set month to the month of the current week (use the middle day of the week)
                                    const weekMiddleDay = new Date(currentWeekStart);
                                    weekMiddleDay.setDate(currentWeekStart.getDate() + 3);
                                    currentMonth = new Date(weekMiddleDay.getFullYear(), weekMiddleDay.getMonth(), 1);
                                }
                                renderDesktopMonthCalendar(); 
                            }
                        }
                        updateWeekHeader();
                        
                        // Update button states after view change
                        if (window.updateButtonStates) {
                            setTimeout(window.updateButtonStates, 50);
                        }
                    });
                });
            }

            // Get current date in Riyadh timezone
            function getRiyadhDate() {
                const now = new Date();
                // Convert to Riyadh time (UTC+3)
                const riyadhOffset = 3 * 60; // 3 hours in minutes
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const riyadhTime = new Date(utc + (riyadhOffset * 60000));
                return riyadhTime;
            }
            
            // Initialize today (will be refreshed when agenda is opened)
            let today = getRiyadhDate();

            function parseEventTimeToMinutes(timeStr) {
                if (!timeStr || typeof timeStr !== 'string') return 24 * 60;
                if (timeStr.trim().toUpperCase() === 'EOD') return 17 * 60;
                const parts = timeStr.match(/(\d+):(\d+)\s*(AM|PM)?/i);
                if (parts) {
                    let hours = parseInt(parts[1]);
                    const minutes = parseInt(parts[2]);
                    const period = parts[3] ? parts[3].toUpperCase() : '';
                    if (period === 'PM' && hours !== 12) hours += 12;
                    if (period === 'AM' && hours === 12) hours = 0;
                    return hours * 60 + minutes;
                }
                return 24 * 60;
            }

            function isEventInPast(dateStr, timeStr, referenceDate = null) {
                if (!dateStr) return false;
                const now = referenceDate || getRiyadhDate();
                const currentDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const eventDate = new Date(dateStr + 'T00:00:00');
                if (eventDate < currentDateOnly) return true;
                if (eventDate > currentDateOnly) return false;
                if (!timeStr) return false;
                const eventMinutes = parseEventTimeToMinutes(timeStr);
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                return eventMinutes < currentMinutes;
            }
            
            // State for calendar navigation
            let currentWeekStart = new Date(today);
            let currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            // Initialize week start to Sunday of current week
            const day = currentWeekStart.getDay();
            const diff = currentWeekStart.getDate() - day;
            currentWeekStart.setDate(diff);
            currentWeekStart.setHours(0, 0, 0, 0);

            // Desktop Month Calendar Rendering
            function renderDesktopMonthCalendar() {
                 const monthGrid = document.getElementById('month-calendar-grid');
                if (!monthGrid) return;
                const allEvents = Array.from(document.querySelectorAll('.event[data-date]'));
                const eventsByDate = new Map();
                const seenEvents = new Set(); // Track unique events to prevent duplicates
                allEvents.forEach(e => { 
                    const date = e.dataset.date;
                    const eventKey = `${date}-${e.dataset.eventTitle}-${e.dataset.eventTime}`;
                    // Only add if we haven't seen this exact event before
                    if (!seenEvents.has(eventKey)) {
                        seenEvents.add(eventKey);
                        if (!eventsByDate.has(date)) { eventsByDate.set(date, []); }
                        eventsByDate.get(date).push(e);
                    }
                });
                const year = currentMonth.getFullYear(); const month = currentMonth.getMonth();
                const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const firstDayOfMonth = new Date(year, month, 1); const daysInMonth = new Date(year, month + 1, 0).getDate(); const startingDay = firstDayOfMonth.getDay();
                monthGrid.innerHTML = '';
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach((day, index) => { const isWeekend = index === 5 || index === 6; monthGrid.innerHTML += `<div class="month-day-header ${isWeekend ? 'weekend' : ''}">${day}</div>`; });
                for (let i = 0; i < startingDay; i++) { monthGrid.innerHTML += '<div class="month-day-cell other-month"></div>'; }
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                    const isPast = date < todayDateOnly;
                    const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                    let cellClasses = 'month-day-cell';
                    if (isToday) cellClasses += ' today';
                    if (isPast) cellClasses += ' disabled-day';
                    if (isWeekend) cellClasses += ' weekend';
                    
                    const eventsForDay = eventsByDate.has(dateStr) ? eventsByDate.get(dateStr) : [];
                    
                    let cellHtml = `<div class="${cellClasses}" data-date="${dateStr}"><div class="month-day-number">${day}</div><div class="month-day-events">`;
                    if (eventsForDay.length > 0) {
                        eventsForDay.forEach(eventEl => {
                            const isMilestone = eventEl.classList.contains('event-milestone') || eventEl.dataset.eventTime === 'EOD';
                            const eventTitle = eventEl.dataset.eventTitle || '';
                            const eventTime = eventEl.dataset.eventTime || '';
                            const pastClass = isEventInPast(dateStr, eventTime) ? ' past-event' : '';
                            cellHtml += `<div class="month-event-dot ${isMilestone ? 'milestone' : ''}${pastClass}" title="${eventTitle} - ${eventTime}"><span class="event-time">${eventTime}</span><span class="event-title-text">${eventTitle}</span></div>`;
                        });
                    }
                    cellHtml += `</div></div>`;
                    monthGrid.innerHTML += cellHtml;
                }
                // Add click handlers - allow clicks on past days only if they have events (for summarize)
                monthGrid.querySelectorAll('.month-day-cell:not(.other-month)').forEach(cell => {
                    const dateStr = cell.dataset.date;
                    const isPast = cell.classList.contains('disabled-day');
                    cell.addEventListener('click', (e) => {
                        // Don't trigger if clicking directly on an event dot
                        if (e.target.closest('.month-event-dot')) {
                            const eventDot = e.target.closest('.month-event-dot');
                            const eventTime = eventDot.querySelector('.event-time')?.textContent || '';
                            const eventTitle = eventDot.querySelector('.event-title-text')?.textContent || '';
                            // Find the matching event
                            const matchingEvent = Array.from(document.querySelectorAll('.event[data-date]')).find(e => 
                                e.dataset.date === dateStr && 
                                e.dataset.eventTime === eventTime && 
                                e.dataset.eventTitle === eventTitle
                            );
                            if (matchingEvent) {
                                openEventModal(matchingEvent.dataset.eventTitle, matchingEvent.dataset.eventTime, matchingEvent.dataset.eventDetails, dateStr, matchingEvent);
                            }
                            return;
                        }
                        
                        if (eventsByDate.has(dateStr)) {
                            // Open scrollable list of all meetings for this day
                            openDayMeetingsModal(dateStr);
                        } else if (!isPast) {
                            openDayActionModal(dateStr);
                        }
                    });
                });
            }

            // Day Meetings Modal - Show all meetings for a day in a scrollable list
            function openDayMeetingsModal(dateStr) {
                const dayMeetingsModal = document.getElementById('dayMeetingsModal');
                const titleEl = document.getElementById('day-meetings-title');
                const listEl = document.getElementById('day-meetings-list');
                
                if (!dayMeetingsModal || !titleEl || !listEl) return;
                
                const date = new Date(dateStr + 'T00:00:00');
                const dateFormatted = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                titleEl.textContent = `Meetings for ${dateFormatted}`;
                
                // Get all events for this date
                const allEvents = Array.from(document.querySelectorAll('.event[data-date]'));
                const dayEvents = allEvents.filter(e => e.dataset.date === dateStr);
                
                // Remove duplicates
                const seenEvents = new Set();
                const uniqueEvents = [];
                dayEvents.forEach(eventEl => {
                    const eventKey = `${eventEl.dataset.eventTitle}-${eventEl.dataset.eventTime}`;
                    if (!seenEvents.has(eventKey)) {
                        seenEvents.add(eventKey);
                        uniqueEvents.push(eventEl);
                    }
                });
                
                // Sort by time
                uniqueEvents.sort((a, b) => {
                    const timeStrToMinutes = (timeStr) => {
                        if (timeStr === 'EOD') return 17 * 60;
                        const parts = timeStr.match(/(\d+):(\d+)\s*(AM|PM)?/i);
                        if (parts) {
                            let hours = parseInt(parts[1]);
                            const minutes = parseInt(parts[2]);
                            const isPM = parts[3] && parts[3].toUpperCase() === 'PM';
                            if (isPM && hours !== 12) hours += 12;
                            if (!isPM && hours === 12) hours = 0;
                            return hours * 60 + minutes;
                        }
                        return 24 * 60;
                    };
                    return timeStrToMinutes(a.dataset.eventTime) - timeStrToMinutes(b.dataset.eventTime);
                });
                
                listEl.innerHTML = '';
                if (uniqueEvents.length === 0) {
                    listEl.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 20px;">No meetings scheduled for this day.</p>';
                } else {
                    uniqueEvents.forEach(eventEl => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event';
                        if (eventEl.classList.contains('event-milestone')) {
                            eventDiv.classList.add('event-milestone');
                        }
                        eventDiv.innerHTML = `
                            <div class="event-time">${eventEl.dataset.eventTime}</div>
                            <div class="event-title">${eventEl.dataset.eventTitle}</div>
                            <div class="event-details" style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">${eventEl.dataset.eventDetails}</div>
                        `;
                        eventDiv.style.cursor = 'pointer';
                        eventDiv.style.marginBottom = '12px';
                        eventDiv.addEventListener('click', () => {
                            closeModal(dayMeetingsModal);
                            openEventModal(eventEl.dataset.eventTitle, eventEl.dataset.eventTime, eventEl.dataset.eventDetails, dateStr, eventEl);
                        });
                        listEl.appendChild(eventDiv);
                    });
                }
                
                openModal(dayMeetingsModal);
            }

            // Day Action Modal
            function openDayActionModal(dateStr) {
                 const date = new Date(dateStr + 'T00:00:00'); const titleEl = document.getElementById('day-action-title'); const pillsContainer = document.getElementById('day-action-pills'); const actionsContainer = document.querySelector('#dayActionModal .day-actions'); if (!titleEl || !pillsContainer || !actionsContainer) return;
                // titleEl.textContent = `Actions for ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`; pillsContainer.innerHTML = ''; document.querySelectorAll('.topic-card .topic-title').forEach(titleElement => { const pill = document.createElement('div'); pill.className = 'modal-topic-pill'; pill.textContent = titleElement.textContent; pill.dataset.topic = titleElement.textContent; pillsContainer.appendChild(pill); }); let selectedTopic = ''; pillsContainer.querySelectorAll('.modal-topic-pill').forEach(pill => { pill.addEventListener('click', () => { pillsContainer.querySelectorAll('.modal-topic-pill').forEach(p => p.classList.remove('active')); pill.classList.add('active'); selectedTopic = pill.dataset.topic; }); }); const newActionsContainer = actionsContainer.cloneNode(true); actionsContainer.parentNode.replaceChild(newActionsContainer, actionsContainer); newActionsContainer.querySelectorAll('button').forEach(button => { button.addEventListener('click', () => { if (!selectedTopic) { showMessageModal("Please select a focus area first."); return; } const action = button.dataset.action; let prompt = ''; const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }); switch(action) { case 'check': prompt = `Draft an email to check stakeholders' availability for a meeting on ${formattedDate} regarding "${selectedTopic}".`; break; case 'media': prompt = `Draft an email to the media team to coordinate potential media coverage for an initiative related to "${selectedTopic}" around ${formattedDate}.`; break; case 'consulting': prompt = `Draft an email to summon the consulting team for a high-priority meeting on ${formattedDate} to discuss "${selectedTopic}". Emphasize urgency.`; break; } if(prompt) { switchToAgentAndSendPrompt(prompt); } }); }); openModal(dayActionModal);
                // ---------------------------------------------------------
                // CLEAN REWRITE â€” no variable name changes
                // ---------------------------------------------------------
                titleEl.textContent = `Actions for ${date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric' 
                })}`;

                // -------------------------------------------
                // 1. Render Topic Pills
                // -------------------------------------------
                pillsContainer.innerHTML = '';

                const topicTitles = document.querySelectorAll('.topic-card .topic-title');
                topicTitles.forEach(titleElement => {
                    const pill = document.createElement('div');
                    pill.className = 'modal-topic-pill';
                    pill.textContent = titleElement.textContent;
                    pill.dataset.topic = titleElement.textContent;
                    pillsContainer.appendChild(pill);
                });

                // -------------------------------------------
                // 2. Topic Selection Handler
                // -------------------------------------------
                let selectedTopic = '';

                pillsContainer.addEventListener('click', (e) => {
                    const pill = e.target.closest('.modal-topic-pill');
                    if (!pill) return;

                    pillsContainer.querySelectorAll('.modal-topic-pill')
                        .forEach(p => p.classList.remove('active'));

                    pill.classList.add('active');
                    selectedTopic = pill.dataset.topic;
                });

                // -------------------------------------------
                // 3. Rebuild Actions Container (remove old listeners)
                // -------------------------------------------
                const newActionsContainer = actionsContainer.cloneNode(true);
                actionsContainer.parentNode.replaceChild(newActionsContainer, actionsContainer);

                // -------------------------------------------
                // 4. Action Button Click Handler (Delegated)
                // -------------------------------------------
                newActionsContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    if (!selectedTopic) {
                        showMessageModal("Please select a focus area first.");
                        return;
                    }

                    const action = button.dataset.action;
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

                    // ----------- Prompt Builder -----------
                    const prompts = {
                        check: `Draft an email to check stakeholders' availability for a meeting on ${formattedDate} regarding "${selectedTopic}".`,
                        media: `Draft an email to the media team to coordinate potential media coverage for an initiative related to "${selectedTopic}" around ${formattedDate}.`,
                        consulting: `Draft an email to summon the consulting team for a high-priority meeting on ${formattedDate} to discuss "${selectedTopic}". Emphasize urgency.`
                    };

                    const prompt = prompts[action];

                    if (prompt) {
                        switchToAgentAndSendPrompt(prompt);
                    }
                });

                // -------------------------------------------
                // 5. Open the modal
                // -------------------------------------------
                openModal(dayActionModal);

            }

            // Desktop Today View Rendering
            function renderTodayView() {
                 today = getRiyadhDate();
                const todayList = document.getElementById('today-events-list'); 
                 const todayDateEl = document.querySelector('#today-view .today-date'); 
                 if (!todayList || !todayDateEl) return;
                 
                 // Format date string for event matching (YYYY-MM-DD)
                 const year = today.getFullYear();
                 const month = String(today.getMonth() + 1).padStart(2, '0');
                 const day = String(today.getDate()).padStart(2, '0');
                 const todayStr = `${year}-${month}-${day}`;
                 
                 // Display date with day name (e.g., "Monday, January 15, 2024")
                 const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
                 const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                 todayDateEl.textContent = `${dayName}, ${dateStr}`;
                 
                 const todaysEvents = Array.from(document.querySelectorAll(`.event[data-date="${todayStr}"]`)); 
                 todayList.innerHTML = ''; 
                 if (todaysEvents.length > 0) { 
                     // Remove duplicates by tracking unique event titles and times
                     const seenEvents = new Set();
                     const uniqueEvents = [];
                     todaysEvents.forEach(eventEl => { 
                         const eventKey = `${eventEl.dataset.eventTitle}-${eventEl.dataset.eventTime}`;
                         if (!seenEvents.has(eventKey)) {
                             seenEvents.add(eventKey);
                             uniqueEvents.push(eventEl);
                         }
                     });
                     
                    uniqueEvents.sort((a, b) => {
                        const minutesA = parseEventTimeToMinutes(a.dataset.eventTime || '');
                        const minutesB = parseEventTimeToMinutes(b.dataset.eventTime || '');
                        return minutesA - minutesB;
                    }).forEach(eventEl => { 
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event';
                        if (eventEl.classList.contains('event-milestone')) {
                            eventDiv.classList.add('event-milestone');
                        }
                        if (isEventInPast(eventEl.dataset.date, eventEl.dataset.eventTime)) {
                            eventDiv.classList.add('past-event');
                        }
                        
                        // Create visible event rectangle with title and time
                        eventDiv.innerHTML = `
                            <div class="event-time">${eventEl.dataset.eventTime}</div>
                            <div class="event-title">${eventEl.dataset.eventTitle}</div>
                        `;
                        
                        eventDiv.addEventListener('click', () => { 
                            const dateStr = eventEl.dataset.date;
                            openEventModal(eventEl.dataset.eventTitle, eventEl.dataset.eventTime, eventEl.dataset.eventDetails, dateStr, eventEl); 
                        }); 
                        todayList.appendChild(eventDiv); 
                     }); 
                 } else { 
                     todayList.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 20px;">No events scheduled for today.</p>'; 
                 }
            }

            // Desktop Week View Rendering
            function renderWeekView() {
                const weekView = document.getElementById('week-view');
                if (!weekView) return;
                
                const calendarGrid = weekView.querySelector('.calendar-grid');
                if (!calendarGrid) return;
                
                // Get all events
                const allEvents = Array.from(document.querySelectorAll('.event[data-date]'));
                const eventsByDate = new Map();
                const seenEvents = new Set(); // Track unique events to prevent duplicates
                allEvents.forEach(e => {
                    const date = e.dataset.date;
                    const eventKey = `${date}-${e.dataset.eventTitle}-${e.dataset.eventTime}`;
                    // Only add if we haven't seen this exact event before
                    if (!seenEvents.has(eventKey)) {
                        seenEvents.add(eventKey);
                    if (!eventsByDate.has(date)) {
                        eventsByDate.set(date, []);
                    }
                    eventsByDate.get(date).push(e);
                    }
                });
                
                // Clear and rebuild the week grid
                calendarGrid.innerHTML = '';
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(currentWeekStart);
                    currentDate.setDate(currentWeekStart.getDate() + i);
                    // Format date string for event matching (YYYY-MM-DD)
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    const dayName = dayNames[i];
                    const dayNumber = currentDate.getDate();
                    const dayOfWeek = currentDate.getDay();
                    // Weekend is Friday (5) and Saturday (6) in this region
                    const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                    // Compare with today's date
                    const todayYear = today.getFullYear();
                    const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
                    const todayDay = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${todayYear}-${todayMonth}-${todayDay}`;
                    const isToday = dateStr === todayStr;
                    
                    // Check if this day is in the past
                    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const currentDateOnly = new Date(year, parseInt(month) - 1, parseInt(day));
                    const isPast = currentDateOnly < todayDateOnly;
                    
                    const dayColumn = document.createElement('div');
                    dayColumn.className = `day-column${isWeekend ? ' weekend' : ''}${isToday ? ' today' : ''}${isPast ? ' past-day' : ''}`;
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.innerHTML = `
                        <div class="day-name">${dayName}</div>
                        <div class="day-number">${dayNumber}</div>
                    `;
                    dayColumn.appendChild(dayHeader);
                    
                    // Add events for this day - create visible rectangles with titles
                    if (eventsByDate.has(dateStr)) {
                        const dayEvents = eventsByDate.get(dateStr);
                        // Sort events by time
                        dayEvents.sort((a, b) => parseEventTimeToMinutes(a.dataset.eventTime || '') - parseEventTimeToMinutes(b.dataset.eventTime || ''));
                        dayEvents.forEach(eventEl => {
                            const eventDiv = document.createElement('div');
                            const eventPast = isEventInPast(dateStr, eventEl.dataset.eventTime);
                            eventDiv.className = `event${eventPast ? ' past-event' : ''}`;
                            if (eventEl.classList.contains('event-milestone')) {
                                eventDiv.classList.add('event-milestone');
                            }
                            
                            // Create visible event rectangle with title and time
                            eventDiv.innerHTML = `
                                <div class="event-time">${eventEl.dataset.eventTime}</div>
                                <div class="event-title">${eventEl.dataset.eventTitle}</div>
                            `;
                            
                            eventDiv.addEventListener('click', () => {
                                openEventModal(eventEl.dataset.eventTitle, eventEl.dataset.eventTime, eventEl.dataset.eventDetails, dateStr, eventEl);
                            });
                            dayColumn.appendChild(eventDiv);
                        });
                    }
                    
                    // Add click handler to day column - allow clicks on past days only if they have events (for summarize)
                    if (!isPast || eventsByDate.has(dateStr)) {
                        dayColumn.style.cursor = 'pointer';
                        dayColumn.addEventListener('click', (e) => {
                            // Only trigger if clicking on the column itself, not on an event
                            if (e.target === dayColumn || e.target === dayHeader || e.target.closest('.day-header')) {
                                if (eventsByDate.has(dateStr)) {
                                    // If there are events, open the first one (for summarize)
                                    const firstEvent = eventsByDate.get(dateStr)[0];
                                    openEventModal(firstEvent.dataset.eventTitle, firstEvent.dataset.eventTime, firstEvent.dataset.eventDetails, dateStr, firstEvent);
                                } else if (!isPast) {
                                    // If no events and not past, open day action modal to book a meeting
                                    openDayActionModal(dateStr);
                                }
                            }
                        });
                    }
                    
                    calendarGrid.appendChild(dayColumn);
                }
                
                // Update header after rendering
                updateWeekHeader();
            }
            
            // Update calendar header based on current view
            function updateWeekHeader() {
                const weekEnd = new Date(currentWeekStart);
                weekEnd.setDate(currentWeekStart.getDate() + 6);
                const desktopTitle = document.getElementById('desktop-calendar-title');
                const mobileTitle = document.getElementById('mobile-calendar-title');
                const activeView = document.querySelector('.view-btn.active, .mobile-view-btn.active');
                const view = activeView ? activeView.dataset.view : 'week';
                
                if (view === 'week') {
                    const startMonth = currentWeekStart.toLocaleDateString('en-US', { month: 'short' });
                    const endMonth = weekEnd.toLocaleDateString('en-US', { month: 'short' });
                    const startYear = currentWeekStart.getFullYear();
                    const endYear = weekEnd.getFullYear();
                    
                    let weekText = '';
                    if (startMonth === endMonth && startYear === endYear) {
                        weekText = `${startMonth} ${currentWeekStart.getDate()} - ${weekEnd.getDate()}, ${startYear}`;
                    } else if (startYear === endYear) {
                        weekText = `${startMonth} ${currentWeekStart.getDate()} - ${endMonth} ${weekEnd.getDate()}, ${startYear}`;
                    } else {
                        weekText = `${startMonth} ${currentWeekStart.getDate()}, ${startYear} - ${endMonth} ${weekEnd.getDate()}, ${endYear}`;
                    }
                    
                    if (desktopTitle) desktopTitle.textContent = weekText;
                    if (mobileTitle) mobileTitle.textContent = weekText;
                } else if (view === 'month') {
                    const monthText = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    if (desktopTitle) desktopTitle.textContent = monthText;
                    if (mobileTitle) mobileTitle.textContent = monthText;
                } else {
                    const todayText = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    if (desktopTitle) desktopTitle.textContent = todayText;
                    if (mobileTitle) mobileTitle.textContent = todayText;
                }
            }

            // Mobile Calendar Logic
            let mobileSelectedDate = new Date(today);
            
            function initMobileCalendar() {
                 const monthGrid = document.getElementById('mobile-month-grid'); const agendaEvents = document.getElementById('mobile-agenda-events'); if (!monthGrid || !agendaEvents) return;
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; const allEvents = Array.from(document.querySelectorAll('.event[data-date]')); const eventDates = new Set(allEvents.map(e => e.dataset.date));
                function renderCalendar() { 
                    monthGrid.innerHTML = ''; 
                    dayNames.forEach(day => { 
                        const dayNameEl = document.createElement('div'); 
                        dayNameEl.className = 'day-name'; 
                        dayNameEl.textContent = day; 
                        monthGrid.appendChild(dayNameEl); 
                    }); 
                    
                    // Render 7 days of the current week
                    for (let i = 0; i < 7; i++) {
                        const currentDayDate = new Date(currentWeekStart);
                        currentDayDate.setDate(currentWeekStart.getDate() + i);
                        // Format date string for event matching (YYYY-MM-DD)
                        const year = currentDayDate.getFullYear();
                        const month = String(currentDayDate.getMonth() + 1).padStart(2, '0');
                        const day = String(currentDayDate.getDate()).padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        
                        const dayCell = document.createElement('div');
                        dayCell.className = 'day-cell';
                        dayCell.textContent = currentDayDate.getDate();
                        
                        // Check if it's today
                        const todayYear = today.getFullYear();
                        const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
                        const todayDay = String(today.getDate()).padStart(2, '0');
                        const todayStr = `${todayYear}-${todayMonth}-${todayDay}`;
                        if (dateStr === todayStr) {
                            dayCell.classList.add('today');
                        }
                        
                        // Check if it's selected
                        const selectedYear = mobileSelectedDate.getFullYear();
                        const selectedMonth = String(mobileSelectedDate.getMonth() + 1).padStart(2, '0');
                        const selectedDay = String(mobileSelectedDate.getDate()).padStart(2, '0');
                        const selectedStr = `${selectedYear}-${selectedMonth}-${selectedDay}`;
                        if (dateStr === selectedStr) {
                            dayCell.classList.add('selected');
                        }
                        
                        // Check if it has events
                        if (eventDates.has(dateStr)) {
                            dayCell.classList.add('has-event');
                        }
                        
                        dayCell.addEventListener('click', () => {
                            mobileSelectedDate = new Date(currentDayDate);
                            renderCalendar();
                            renderEvents(dateStr);
                        });
                        
                        monthGrid.appendChild(dayCell);
                    }
                }
                function renderEvents(dateStr) { const dayEvents = allEvents.filter(e => e.dataset.date === dateStr); if (dayEvents.length === 0) { agendaEvents.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 20px;">No events scheduled for this day</p>'; return; } agendaEvents.innerHTML = ''; dayEvents.forEach(eventEl => { const eventDiv = document.createElement('div'); eventDiv.className = 'event'; if (eventEl.classList.contains('event-milestone')) { eventDiv.classList.add('event-milestone'); } eventDiv.innerHTML = `<div class="event-time">${eventEl.dataset.eventTime}</div> <div class="event-title">${eventEl.dataset.eventTitle}</div>`; eventDiv.addEventListener('click', () => { openEventModal(eventEl.dataset.eventTitle, eventEl.dataset.eventTime, eventEl.dataset.eventDetails, dateStr, eventEl); }); agendaEvents.appendChild(eventDiv); }); }
                renderCalendar(); renderEvents(mobileSelectedDate.toISOString().split('T')[0]);
            }

            // --- News Page Functions ---
            let newsData = [];
            let currentNewsFilter = 'all';
            
            // Topic mapping for news queries
            const topicMapping = {
                'labor-market': 'Strengthening Labor Market',
                'empowerment': 'Empowering Society & Individuals',
                'non-profit': 'Enabling the Non-Profit Sector',
                'strategic-partnerships': 'Strategic Partnerships'
            };
            

            // Gemini endpoint for executive summaries of tweets (use separate key to reduce rate limiting)
            const geminiSummaryEndpoint = GEMINI_SUMMARY_MODEL_URL;
            
            // Fetch and summarize tweets for a given topic
            // Fetch and summarize tweets for a given topic (EN + AR combined, balanced)
            // Fetch and summarize tweets for a given topic (EN + AR combined, balanced by source)
            // Fetch and summarize tweets for a given topic (25 EN + 25 AR, balanced)
            async function fetchNewsForTopic(topicId, usedTweetUrls = []) {
                const topicName = topicMapping[topicId] || 'HRSD initiatives';

                // Helper to call backend for given lang (en or ar)
                async function fetchLang(lang) {
                    const response = await fetch(
                        `https://backend-vercel-repo-git-main-jouds-projects-8f56041e.vercel.app/api/news?topic=${encodeURIComponent(topicId)}&lang=${lang}`
                    );

                    if (!response.ok) {
                        console.warn('News API request failed for topic/lang:', topicId, lang, response.status);
                        return [];
                    }

                    const data = await response.json();
                    const rawTweets = Array.isArray(data?.tweets)
                        ? data.tweets
                        : Array.isArray(data?.data)
                            ? data.data
                            : [];

                    console.log(`[NEWS] ${topicId} (${lang}) â€“ raw tweets from backend:`, rawTweets.length);
                    return rawTweets;
                }

                try {
                    // Fetch English + Arabic in parallel
                    const [englishTweets, arabicTweets] = await Promise.all([
                        fetchLang("en"),
                        fetchLang("ar")
                    ]);

                    // If absolutely nothing came back, bail
                    if (!englishTweets.length && !arabicTweets.length) return [];

                    // Allowed accounts (EN + AR)
                    const allowedSources = new Set([
                        'arabnews',
                        'alarabiya_eng',
                        'alekhbariyaen',
                        'sabqorg',
                        'saudinews50',
                        'aawsat_news'
                    ]);

                    const normalize = (tweet, sourceLang) => {
                        const tweetId = tweet.id || tweet.tweet_id || tweet.tweetId;
                        const author = tweet.author || tweet.user || {};
                        const username = (author.userName || author.username || author.screen_name || '').toLowerCase();
                        const createdAt = tweet.createdAt || tweet.created_at || null;
                        const text = tweet.text || tweet.full_text || '';
                        const url = (username && tweetId)
                            ? `https://twitter.com/${username}/status/${tweetId}`
                            : '#';
                        const lang = tweet.lang || tweet.language || sourceLang || null;

                        return {
                            tweetId,
                            username,
                            displayName: author.name || username || 'Source',
                            createdAt,
                            text,
                            url,
                            lang,
                            _sourceLang: sourceLang
                        };
                    };

                    // Normalize EN and AR separately, and filter by accounts + used URLs
                    const englishTweetsNorm = englishTweets
                        .map(t => normalize(t, 'en'))
                        .filter(t => t.text && t.url && !usedTweetUrls.includes(t.url))
                        .filter(t => allowedSources.has(t.username));

                    const arabicTweetsNorm = arabicTweets
                        .map(t => normalize(t, 'ar'))
                        .filter(t => t.text && t.url && !usedTweetUrls.includes(t.url))
                        .filter(t => allowedSources.has(t.username));

                    console.log(`[NEWS] ${topicId} â€“ normalized EN: ${englishTweetsNorm.length}, AR: ${arabicTweetsNorm.length}`);

                    if (!englishTweetsNorm.length && !arabicTweetsNorm.length) return [];

                    // Sort both buckets newest first
                    const sortByDateDesc = (a, b) => {
                        const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                        const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                        return bTime - aTime;
                    };

                    englishTweetsNorm.sort(sortByDateDesc);
                    arabicTweetsNorm.sort(sortByDateDesc);

                    // --- enforce 25 EN + 25 AR per focus area (if available) ---
                    const MAX_PER_LANG = 25;

                    const englishSelected = englishTweetsNorm.slice(0, MAX_PER_LANG);
                    const arabicSelected = arabicTweetsNorm.slice(0, MAX_PER_LANG);

                    const selected = [...englishSelected, ...arabicSelected];

                    // Map to news items
                    const newsItems = selected.map((t, i) => ({
                        id: `news-${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${i}`,
                        title: t.text.length > 120 ? `${t.text.substring(0, 117)}â€¦` : t.text,
                        summary: t.text,
                        source: `X / @${t.username}`,
                        url: t.url,
                        publishedAt: t.createdAt || new Date().toISOString(),
                        topic: topicId,
                        timestamp: new Date().toISOString(),
                        lang: t.lang || t._sourceLang // keep track of EN/AR if you want to display a badge later
                    }));

                    return newsItems;

                } catch (error) {
                    console.error('Error fetching combined news:', topicId, error);
                    return [];
                }
            }



            
            async function loadAllNews(showLoading = true) {
                const newsFeed = document.getElementById('news-feed');
                const newsLoading = document.getElementById('news-loading');
                const newsEmpty = document.getElementById('news-empty');
                const newsPage = document.getElementById('news-page');
                
                if (!newsFeed || !newsLoading) return;
                
                // Only show loading state if news page is active or explicitly requested
                const isNewsPageActive = newsPage && newsPage.classList.contains('active');
                if (showLoading && isNewsPageActive) {
                    newsFeed.style.display = 'none';
                    newsEmpty.style.display = 'none';
                    newsLoading.style.display = 'block';
                }
                
                try {
                    // Fetch news for all topics sequentially to avoid rate limits
                    const allTopics = ['labor-market', 'empowerment', 'non-profit', 'strategic-partnerships'];
                    newsData = [];
                    const usedTweetUrls = []; // Track which tweet URLs have been used
                    
                    for (let i = 0; i < allTopics.length; i++) {
                        const topicId = allTopics[i];
                        const topicNews = await fetchNewsForTopic(topicId, usedTweetUrls);
                        if (topicNews && topicNews.length > 0) {
                            // spread the array into newsData
                            newsData.push(...topicNews);
                            // Mark these tweets as used across topics (avoid duplicates globally)
                            topicNews.forEach(item => {
                                if (item.url) {
                                    usedTweetUrls.push(item.url);
                                }
                            });
                        }

                        // Add delay between topics to avoid rate limiting (except for last topic)
                        if (i < allTopics.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay
                        }
                    }
                    
                    // Final deduplication by URL (safety net)
                    const uniqueNews = [];
                    const seenUrls = new Set();
                    newsData.forEach(item => {
                        if (item.url && !seenUrls.has(item.url)) {
                            seenUrls.add(item.url);
                            uniqueNews.push(item);
                        }
                    });
                    newsData = uniqueNews;
                    
                    // Filter out any empty results (topics with no news found)
                    newsData = newsData.filter(item => item && item.title);
                    
                    // Render news
                    renderNews();
                    
                } catch (error) {
                    console.error('Error loading news:', error);
                    showMessageModal('Failed to load news. Please try again.', 'Error');
                } finally {
                    // Only hide loading if it was shown
                    if (showLoading && isNewsPageActive && newsLoading) {
                        newsLoading.style.display = 'none';
                    }
                    // Always show the feed (it will display news if loaded, or empty state if not)
                    if (newsFeed) {
                        newsFeed.style.display = 'grid';
                    }
                }
            }
            
            function renderNews() {
                const newsFeed = document.getElementById('news-feed');
                const newsEmpty = document.getElementById('news-empty');
                
                if (!newsFeed) return;
                
                // Filter news based on current filter
                let filteredNews = newsData;
                if (currentNewsFilter !== 'all') {
                    filteredNews = newsData.filter(item => item.topic === currentNewsFilter);
                }
                
                // Clear existing news
                newsFeed.innerHTML = '';
                
                if (filteredNews.length === 0) {
                    newsFeed.style.display = 'none';
                    if (newsEmpty) newsEmpty.style.display = 'block';
                    return;
                }
                
                if (newsEmpty) newsEmpty.style.display = 'none';
                newsFeed.style.display = 'grid';
                
                // Render each news item as a card
                filteredNews.forEach(newsItem => {
                    const newsCard = document.createElement('div');
                    newsCard.className = 'tool-card';
                    newsCard.style.cursor = 'pointer';
                    
                    // Get topic name for display
                    const topicName = topicMapping[newsItem.topic] || 'General';
                    const topicIcons = {
                        'labor-market': 'fa-briefcase',
                        'empowerment': 'fa-users',
                        'non-profit': 'fa-hand-holding-heart',
                        'strategic-partnerships': 'fa-handshake'
                    };
                    const topicIcon = topicIcons[newsItem.topic] || 'fa-newspaper';
                    
                    newsCard.innerHTML = `
                        <div class="tool-icon"><i class="fas ${topicIcon}"></i></div>
                        <div style="width: 100%; text-align: left; margin-bottom: 10px;">
                            <span style="font-size: 0.75rem; color: var(--primary-blue); background: rgba(0, 169, 157, 0.1); padding: 4px 8px; border-radius: 12px; display: inline-block; margin-bottom: 8px;">${topicName}</span>
                        </div>
                        <h3 class="tool-title" style="text-align: left; width: 100%; margin-bottom: 12px;">${newsItem.title || 'News Update'}</h3>
                        <p class="tool-description" style="text-align: left; width: 100%; margin-bottom: 12px;">${newsItem.summary || 'No summary available.'}</p>
                        <div style="width: 100%; text-align: left; margin-bottom: 15px; font-size: 0.75rem; opacity: 0.7;">
                            <div style="margin-bottom: 5px;">
                                <i class="fas fa-newspaper"></i> Source: <strong>${newsItem.source || 'Media'}</strong>
                            </div>
                            ${newsItem.publishedAt ? `<div style="margin-bottom: 5px; opacity: 0.6;">
                                <i class="fas fa-calendar"></i> ${new Date(newsItem.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                            </div>` : ''}
                            ${newsItem.url && newsItem.url !== '#' ? `<div>
                                <a href="${newsItem.url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                                    <i class="fas fa-external-link-alt"></i> View Original Article
                                </a>
                            </div>` : ''}
                        </div>
                        <button class="tool-action-btn news-ask-agent-btn" data-news-id="${newsItem.id}" style="width: 100%;">
                            <i class="fas fa-comment-dots"></i> Ask Agent About This
                        </button>
                    `;
                    
                    newsFeed.appendChild(newsCard);
                });
                
                // Add event listeners to "Ask Agent" buttons
                document.querySelectorAll('.news-ask-agent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const newsId = btn.dataset.newsId;
                        const newsItem = newsData.find(item => item.id === newsId);
                        if (newsItem) {
                            const prompt = `Please provide more details and analysis about this news: "${newsItem.title}". ${newsItem.summary ? `Summary: ${newsItem.summary}` : ''}`;
                            switchToAgentAndSendPrompt(prompt, 'layla');
                        }
                    });
                });
            }
            
            function applyNewsFilter(topicId) {
                currentNewsFilter = topicId;
                
                // Update filter button states
                document.querySelectorAll('.news-filter-btn').forEach(btn => {
                    const isActive = btn.dataset.topicFilter === topicId;
                    btn.classList.toggle('active', isActive);
                    
                    // Update inline styles for active state
                    if (isActive) {
                        btn.style.background = 'linear-gradient(135deg, var(--primary-blue), #008a7e)';
                        btn.style.border = '1px solid var(--primary-blue)';
                        btn.style.color = 'var(--text-dark)';
                        btn.style.fontWeight = '500';
                    } else {
                        btn.style.background = 'var(--container-bg-light)';
                        btn.style.border = '1px solid var(--border-color)';
                        btn.style.color = 'var(--text-light)';
                        btn.style.fontWeight = 'normal';
                    }
                });
                
                renderNews();

                const label = document.getElementById('news-filter-label');
                if (label && topicId === 'all') {
                    label.textContent = '';
                    label.style.display = 'none';
                }
            }
            
            function viewRelatedNews(topicId, topicTitle) {
                const desiredFilter = topicId || 'all';
                const newsButton = document.querySelector('.nav-button[data-target="news-page"]');
                if (newsButton) {
                    newsButton.click();
                }
                
                const updateLabel = () => {
                    const label = document.getElementById('news-filter-label');
                    if (label) {
                        if (topicTitle && desiredFilter !== 'all') {
                            label.textContent = `Showing news related to: ${topicTitle}`;
                            label.style.display = 'block';
                        } else {
                            label.textContent = '';
                            label.style.display = 'none';
                        }
                    }
                };
                
                const applyFilter = () => {
                    applyNewsFilter(desiredFilter);
                    updateLabel();
                    const newsSection = document.getElementById('news-page');
                    if (newsSection) {
                        newsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
                
                if (newsData.length === 0) {
                    loadAllNews().then(applyFilter).catch(applyFilter);
                } else {
                    // Slight delay ensures the news tab has switched before filtering
                    setTimeout(applyFilter, 150);
                }
            }
            
            // Auto-load news when news page is opened (fallback - news should already be loading on page load)
            function initializeNewsPage() {
                const newsPage = document.getElementById('news-page');
                if (!newsPage) return;
                
                // This is now just a fallback - news should already be loading on page load
                // Only load if news page is active and news hasn't been loaded yet
                if (newsPage.classList.contains('active') && newsData.length === 0) {
                    loadAllNews();
                }
                
                // Observer for when user navigates to news page (fallback case)
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (newsPage.classList.contains('active') && newsData.length === 0) {
                                // Only load if somehow news wasn't loaded on page load
                                loadAllNews();
                            }
                        }
                    });
                });
                
                observer.observe(newsPage, { attributes: true });
            }

            // --- Event Listeners & Initialization ---

            // Modal close buttons
            closeModalBtns.forEach(btn => { btn.addEventListener('click', () => { const modal = btn.closest('.modal'); if (modal) closeModal(modal); }); });
            window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) { closeModal(event.target); } });
            // Copy summary button
            if (copySummaryBtn) { copySummaryBtn.addEventListener('click', () => { const contentToCopy = summaryContent ? summaryContent.innerText : ''; if (contentToCopy) { const textArea = document.createElement("textarea"); textArea.value = contentToCopy; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); showMessageModal('Agenda copied to clipboard!'); } catch (err) { console.error('Fallback copy failed', err); showMessageModal('Copying failed.'); } document.body.removeChild(textArea); } else { showMessageModal('Nothing to copy.'); } }); }
            // Persona change button
            // Single Agent Avatar click to change persona
            const singleAgentAvatar = document.getElementById('singleAgentAvatar');
            if (singleAgentAvatar) { singleAgentAvatar.addEventListener('click', () => openModal(personaModal)); }
            // Send button and Enter key
            if (sendBtn) { sendBtn.addEventListener('click', handleSendMessage); }
            if (chatInput) { chatInput.addEventListener('keydown', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSendMessage(); } }); }
            // Topic card actions
            document.querySelectorAll('.topic-action-btn').forEach(button => { button.addEventListener('click', () => { const action = button.dataset.action; const card = button.closest('.topic-card'); if (!card) return; const topicId = card.dataset.topicId; const topicTitleEl = card.querySelector('.topic-title'); if (!topicTitleEl) return; const topicTitle = topicTitleEl.textContent; if (action === 'meetings') { openMeetingsModal(topicId, topicTitle); } else if (action === 'deeper') { const prompt = `Please provide a detailed briefing on the focus area: "${topicTitle}". Include key details, current status, and strategic recommendations.`; switchToAgentAndSendPrompt(prompt, 'nouf');} else if (action === 'references') { const prompt = `Please pull up the latest references and documents from my team regarding "${topicTitle}".`; takeActionFromTopic(prompt); } else if (action === 'news') { viewRelatedNews(topicId, topicTitle); } }); });

            // "Ask Agent" on text selection
             document.addEventListener('mouseup', (e) => { if (!askAgentBtn) return; const targetElement = e.target; if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA' || targetElement.closest('.modal') || targetElement.closest('#ask-agent-btn')) { askAgentBtn.style.display = 'none'; return; } setTimeout(() => { const text = window.getSelection().toString().trim(); if (text.length > 1) { selectedText = text; const rect = window.getSelection().getRangeAt(0).getBoundingClientRect(); askAgentBtn.style.left = `${rect.right + window.scrollX + 5}px`; askAgentBtn.style.top = `${rect.bottom + window.scrollY + 5}px`; askAgentBtn.style.display = 'block'; } else { askAgentBtn.style.display = 'none'; } }, 10); });
            document.addEventListener('mousedown', (e) => { if (askAgentBtn && e.target.id !== 'ask-agent-btn') { askAgentBtn.style.display = 'none'; } });
            if (askAgentBtn) { askAgentBtn.addEventListener('click', (e) => { e.stopPropagation(); if (selectedText) { const prompt = `Please provide more details about the following text I selected: "${selectedText}"`; switchToAgentAndSendPrompt(prompt); selectedText = ''; } askAgentBtn.style.display = 'none'; }); }
            // Mobile menu toggle
            if (mobileMenuBtn) { mobileMenuBtn.addEventListener('click', () => { if (navTabsContainer) navTabsContainer.classList.toggle('active'); }); }
            // Quick Actions
            document.querySelectorAll('.quick-action-btn').forEach(btn => { btn.addEventListener('click', () => { const action = btn.dataset.action; let prompt = ''; switch(action) { case 'call': showMessageModal("Voice call feature not implemented in this demo."); return; case 'agenda': prompt = "Please provide a detailed overview of my agenda for today, including all scheduled meetings and key tasks."; break; } if (prompt && chatInput) { chatInput.value = prompt; handleSendMessage(); } }); });
            // Chat "+" Action Button
            // Chat "+" Action Button
            chatActionBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                const list = document.getElementById('meetings-modal-list');
                const title = document.getElementById('meetings-modal-title');
                if (!list || !title) {
                    console.error("Meetings modal elements not found");
                    return;
                }

                openModal(meetingsModal);
                list.innerHTML = '';
                title.textContent = `Discuss a Topic`;

                const focusHeader = document.createElement('div');
                focusHeader.className = 'dropdown-header';
                focusHeader.textContent = 'Discuss a Focus Area';
                list.appendChild(focusHeader);

                const pillsContainer = document.createElement('div');
                pillsContainer.className = 'modal-pills-container';
                document.querySelectorAll('.topic-card .topic-title').forEach(titleEl => {
                    const pill = document.createElement('div');
                    pill.className = 'modal-topic-pill chat-action-item';
                    pill.dataset.prompt = `Let's discuss the focus area: ${titleEl.textContent}`;
                    pill.textContent = titleEl.textContent;
                    pillsContainer.appendChild(pill);
                });
                list.appendChild(pillsContainer);

                pillsContainer.querySelectorAll('.chat-action-item').forEach(item => {
                    item.addEventListener('click', (ev) => {
                        ev.preventDefault();
                        if (chatInput && item.dataset.prompt) {
                            chatInput.value = item.dataset.prompt;
                            handleSendMessage();
                        }
                        closeModal(meetingsModal);
                    });
                });

                const meetingHeader = document.createElement('div');
                meetingHeader.className = 'dropdown-header';
                meetingHeader.textContent = 'Discuss a Meeting';
                list.appendChild(meetingHeader);

                const allEvents = Array.from(document.querySelectorAll('.event[data-date]'));
                buildMeetingColumns(allEvents, list);
            });

             // --- News Page Event Listeners ---
            // Refresh news button
            const refreshNewsBtn = document.getElementById('refresh-news-btn');
            if (refreshNewsBtn) {
                refreshNewsBtn.addEventListener('click', () => {
                    newsData = []; // Clear existing news
                    loadAllNews();
                });
            }
            
            // News filter buttons
            document.querySelectorAll('.news-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const topicId = btn.dataset.topicFilter;
                    applyNewsFilter(topicId);
                });
                
                // Add hover effects
                btn.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = 'rgba(0, 169, 157, 0.2)';
                        this.style.borderColor = 'var(--primary-blue)';
                        this.style.transform = 'translateY(-2px)';
                    }
                });
                
                btn.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = 'var(--container-bg-light)';
                        this.style.borderColor = 'var(--border-color)';
                        this.style.transform = 'translateY(0)';
                    }
                });
            });
            
            // Load news immediately on page load in the background (fetch from the beginning)
            // Use setTimeout to ensure it runs asynchronously without blocking page initialization
            setTimeout(() => {
                loadAllNews(false); // Don't show loading state until user visits news page
            }, 0);
            
            // Initialize news page observer (for edge cases/fallback)
            initializeNewsPage();

            // --- Updated Tool Card Actions ---
             document.querySelectorAll('.tool-action-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.dataset.toolAction;
                    const card = button.closest('.tool-card');
                    if (!card) return;
                    const toolTitleEl = card.querySelector('.tool-title');
                    if (!toolTitleEl) return;
                    const toolTitle = toolTitleEl.textContent;

                    let targetPersonaId = 'hakim'; // Default
                    let prompt = `Tell me more about how I can use the "${toolTitle}" AI tool.`;

                    // Assign persona and craft prompt based on the tool action
                    switch(action) {
                        case 'visualize':
                        case 'predict':
                        case 'sentiment':
                            targetPersonaId = 'layla'; // Data Analyst
                            prompt = `Please assist me with ${toolTitle}. What data do you need to get started?`;
                            break;
                        case 'summarize':
                            targetPersonaId = 'hakim'; // Executive Agent
                            prompt = `I need help using the ${toolTitle} tool. Can you guide me or perform a summarization task?`;
                            break;
                        case 'schedule':
                            targetPersonaId = 'omar'; // Coordinator
                            prompt = `I need to schedule a meeting using the ${toolTitle}. Please help me coordinate.`;
                            break;
                        case 'risk':
                            targetPersonaId = 'hakim'; // Executive Agent (strategic risk)
                            // Or potentially Layla if focused on data-driven risk: targetPersonaId = 'layla';
                            prompt = `I need to use the ${toolTitle} tool. Can you help me assess risks related to [Specify Area/Project]?`;
                            break;
                        case 'advice': 
                            targetPersonaId = 'nouf'; // Executive Agent (strategic risk)
                            // Or potentially Layla if focused on data-driven risk: targetPersonaId = 'layla';
                            prompt = `I need strategic guidance using the ${toolTitle}. Please analyze each of the provided focus areas and give tailored insights and recommendations for every one of them.`;
                            break;
                        /*case 'generatetemplate_official_press': 
                            targetPersonaId = 'Hakim'; // Executive Agent
                            prompt = `I need to generate an Official Press Release. Please begin by asking me for the essential detailsâ€”title of the announcement, purpose, target audience, key messages, and any specific quotes or data points I want included. Do not draft the release yet; collect all necessary information first.`;
                            break;
                        case 'generatetemplate_internal_memo': 
                            targetPersonaId = 'Hakim'; // Executive Agent
                            prompt = `I need to create an Internal Memo. Start by asking me for the memoâ€™s subject, intended recipients, purpose, key points, and any deadlines or required actions. Do not draft the memo yet; gather all required details first.`;
                            break;
                        case 'generatetemplate_interministerial_request': 
                            targetPersonaId = 'Hakim'; // Executive Agent
                            prompt = `I need to prepare an Interministerial Request. Ask me for the requestâ€™s subject, the ministry or entity I am addressing, the specific information or action needed, the timeline, and any background context. Do not generate the request yet; collect all necessary information first.`;
                            break;
                        case 'generatetemplate_speech_template': 
                            targetPersonaId = 'Hakim'; // Executive Agent
                            prompt = `I need to generate a Speech. Please ask me for the topic, audience, purpose, duration, tone, and the key messages or themes I want highlighted. Do not draft the speech yet; gather all the details first.`;
                            break;
                        case 'generatetemplate_diplomatic_communication': 
                            targetPersonaId = 'Hakim'; // Executive Agent
                            prompt = `I need to prepare a Diplomatic Communication. Begin by asking me for the recipient, the purpose of the communication, the key points to convey, relevant background context, and the level of formality required. Do not draft the communication yet; collect all required information first.`;
                            break;*/
                    case 'press':
                        prompt = buildTemplatePrompt("press_release",
                            "I need help generating an official press release. Please ask me what you need.");
                        break;

                    case 'memo':
                        prompt = buildTemplatePrompt("internal_memo",
                            "I need an internal memo. Ask me what you need first.");
                        break;

                    case 'interministerial':
                        prompt = buildTemplatePrompt("interministerial_request",
                            "I need to prepare an interministerial request. Ask me what information is required.");
                        break;

                    case 'speech':
                        prompt = buildTemplatePrompt("speech",
                            "I need a speech drafted, but ask me for details first.");
                        break;

                    case 'diplomatic':
                        prompt = buildTemplatePrompt("diplomatic",
                            "I need a diplomatic communication. Ask me for the missing details first.");
                        break;
                        default:
                             prompt = `Tell me more about the "${toolTitle}" tool.`;
                    }

                    // Switch persona (if needed) and send the prompt
                    switchToAgentAndSendPrompt(prompt, targetPersonaId);
                });
            });


             // --- Corrected Navigation Logic ---
             if (navButtons && pages) {
                 navButtons.forEach(button => {
                     button.addEventListener('click', () => {
                         const targetId = button.dataset.target;
                         const targetPage = document.getElementById(targetId);

                         // Hide all pages first
                         pages.forEach(page => {
                             if (page) page.classList.remove('active');
                         });

                         // Show the target page if found
                         if (targetPage) {
                             targetPage.classList.add('active');
                         } else {
                             console.error(`Target page with ID "${targetId}" not found.`);
                         }

                         // Update button active state
                         navButtons.forEach(btn => btn.classList.remove('active'));
                         button.classList.add('active');

                         // Close mobile nav if open
                         if (navTabsContainer && navTabsContainer.classList.contains('active')) {
                             navTabsContainer.classList.remove('active');
                         }
                         
                         // Refresh agenda when agenda tab is clicked - update to current Riyadh date
                         if (targetId === 'agenda-page') {
                             // Always refresh to current Riyadh date
                             today = getRiyadhDate();
                             
                             // Reset to current week/month
                             currentWeekStart = new Date(today);
                             const day = currentWeekStart.getDay();
                             const diff = currentWeekStart.getDate() - day;
                             currentWeekStart.setDate(diff);
                             currentWeekStart.setHours(0, 0, 0, 0);
                             currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                             
                             updateWeekHeader();
                             renderTodayView();
                             renderWeekView();
                             renderDesktopMonthCalendar();
                             initMobileCalendar();
                         }
                     });
                 });
             } else {
                 console.error("Navigation buttons or page content elements not found.");
             }

            // Calendar Navigation Buttons
            function setupCalendarNavigation() {
                // Desktop navigation
                const prevWeekBtn = document.getElementById('prev-week-btn');
                const nextWeekBtn = document.getElementById('next-week-btn');
                const prevMonthBtn = document.getElementById('prev-month-btn');
                const nextMonthBtn = document.getElementById('next-month-btn');
                
                // Mobile navigation
                const mobilePrevWeekBtn = document.getElementById('mobile-prev-week-btn');
                const mobileNextWeekBtn = document.getElementById('mobile-next-week-btn');
                const mobilePrevMonthBtn = document.getElementById('mobile-prev-month-btn');
                const mobileNextMonthBtn = document.getElementById('mobile-next-month-btn');
                
                function navigateWeek(direction) {
                    currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
                    renderWeekView();
                    initMobileCalendar();
                    
                    // Sync month view to the month of the current week
                    const weekMonth = new Date(currentWeekStart.getFullYear(), currentWeekStart.getMonth(), 1);
                    if (weekMonth.getTime() !== currentMonth.getTime()) {
                        currentMonth = weekMonth;
                        // Only update month calendar if month view is active
                        const activeView = document.querySelector('.view-btn.active, .mobile-view-btn.active');
                        const view = activeView ? activeView.dataset.view : 'week';
                        if (view === 'month') {
                            renderDesktopMonthCalendar();
                        }
                        updateWeekHeader();
                    }
                }
                
                function navigateMonth(direction) {
                    currentMonth.setMonth(currentMonth.getMonth() + direction);
                    renderDesktopMonthCalendar();
                    
                    // If on week tab, also update the week view to show the first week of the new month
                    const activeView = document.querySelector('.view-btn.active, .mobile-view-btn.active');
                    const view = activeView ? activeView.dataset.view : 'week';
                    if (view === 'week' || view === 'today') {
                        // Set week start to the first Sunday of the new month (or first day if month doesn't start on Sunday)
                        const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
                        const dayOfWeek = firstDayOfMonth.getDay();
                        
                        // If month doesn't start on Sunday, go to the previous Sunday
                        if (dayOfWeek !== 0) {
                            const daysToSubtract = dayOfWeek;
                            firstDayOfMonth.setDate(firstDayOfMonth.getDate() - daysToSubtract);
                        }
                        
                        currentWeekStart = new Date(firstDayOfMonth);
                        currentWeekStart.setHours(0, 0, 0, 0);
                        renderWeekView();
                        initMobileCalendar();
                    }
                    
                    // Update calendar headers
                    updateWeekHeader();
                }
                
                // Function to update button states based on active view (make it accessible)
                window.updateButtonStates = function() {
                    const activeView = document.querySelector('.view-btn.active, .mobile-view-btn.active');
                    const view = activeView ? activeView.dataset.view : 'week';
                    const isMonthView = view === 'month';
                    const isTodayView = view === 'today';
                    
                    // Week buttons - disabled in month view and today view
                    const weekButtons = [prevWeekBtn, nextWeekBtn, mobilePrevWeekBtn, mobileNextWeekBtn];
                    weekButtons.forEach(btn => {
                        if (btn) {
                            if (isMonthView || isTodayView) {
                                btn.disabled = true;
                                btn.style.opacity = '0.4';
                                btn.style.cursor = 'not-allowed';
                            } else {
                                btn.disabled = false;
                                btn.style.opacity = '1';
                                btn.style.cursor = 'pointer';
                            }
                        }
                    });
                    
                    // Month buttons - disabled in today view
                    const monthButtons = [prevMonthBtn, nextMonthBtn, mobilePrevMonthBtn, mobileNextMonthBtn];
                    monthButtons.forEach(btn => {
                        if (btn) {
                            if (isTodayView) {
                                btn.disabled = true;
                                btn.style.opacity = '0.4';
                                btn.style.cursor = 'not-allowed';
                            } else {
                                btn.disabled = false;
                                btn.style.opacity = '1';
                                btn.style.cursor = 'pointer';
                            }
                        }
                    });
                };
                
                // Week navigation buttons (only work in week/today view)
                if (prevWeekBtn) {
                    prevWeekBtn.addEventListener('click', () => {
                        if (!prevWeekBtn.disabled) {
                            navigateWeek(-1);
                        }
                    });
                }
                
                if (nextWeekBtn) {
                    nextWeekBtn.addEventListener('click', () => {
                        if (!nextWeekBtn.disabled) {
                            navigateWeek(1);
                        }
                    });
                }
                
                // Month navigation buttons (always work)
                if (prevMonthBtn) {
                    prevMonthBtn.addEventListener('click', () => {
                        navigateMonth(-1);
                    });
                }
                
                if (nextMonthBtn) {
                    nextMonthBtn.addEventListener('click', () => {
                        navigateMonth(1);
                    });
                }
                
                // Mobile week navigation
                if (mobilePrevWeekBtn) {
                    mobilePrevWeekBtn.addEventListener('click', () => {
                        if (!mobilePrevWeekBtn.disabled) {
                            navigateWeek(-1);
                        }
                    });
                }
                
                if (mobileNextWeekBtn) {
                    mobileNextWeekBtn.addEventListener('click', () => {
                        if (!mobileNextWeekBtn.disabled) {
                            navigateWeek(1);
                        }
                    });
                }
                
                // Mobile month navigation
                if (mobilePrevMonthBtn) {
                    mobilePrevMonthBtn.addEventListener('click', () => {
                        navigateMonth(-1);
                    });
                }
                
                if (mobileNextMonthBtn) {
                    mobileNextMonthBtn.addEventListener('click', () => {
                        navigateMonth(1);
                    });
                }
                
                // Update button states when view changes
                document.querySelectorAll('.view-toggle').forEach(toggle => {
                    toggle.addEventListener('click', (e) => {
                        setTimeout(updateButtonStates, 100); // Small delay to ensure view is updated
                    });
                });
                
                // Initial state
                updateButtonStates();
            }

            // --- INITIALIZATION ---
            setViewportHeight();
            setupCalendarToggles(); // Should be defined before call now
            setupCalendarNavigation(); // Setup navigation buttons
            updatePersonaUI(currentPersonaId, true);
            updateTodaysAgendaPanel();
            setupAgendaInteractions();
            initDocumentUpload(); // Initialize document upload functionality
            initMobileCalendar();
            renderDesktopMonthCalendar();
            renderWeekView();
            renderTodayView();
            updateWeekHeader();
            
            // Always show multi-agent content
            const multiAgentContent = document.getElementById('multiAgentContent');
            if (multiAgentContent) multiAgentContent.classList.remove('hidden');
            
            renderAgentSelection();
            updateSingleAgentDisplay(currentPersonaId);
            updateModeStatusLabel();
            
            // Mode Toggle
            // Mode status text updates automatically via selection changes
            
            // Agent Selector Button (for single mode)
            const agentSelectorBtn = document.getElementById('agentSelectorBtn');
            if (agentSelectorBtn) {
                agentSelectorBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showAgentSelectorMenu();
                });
            }
            
            // Agent Discussion button
            const agentDiscussBtn = document.getElementById('agentDiscussBtn');
            if (agentDiscussBtn) {
                agentDiscussBtn.addEventListener('click', startAgentDiscussion);
            }
            
            // Mobile agent selector expand/collapse
            const personaDisplay = document.querySelector('.persona-display');
            const multiAgentHeader = document.querySelector('.multi-agent-header');
            if (personaDisplay && multiAgentHeader && window.innerWidth <= 768) {
                multiAgentHeader.addEventListener('click', () => {
                    personaDisplay.classList.toggle('expanded');
                });
            }

            // Initialize section controls (maximize button)
            (function initSectionControls() {
                setTimeout(function () {
                    const centerBtn = document.getElementById('centerSectionToggle');
                    const chatContainer = document.querySelector('.chat-section-container');
                    const personaDisplay = document.querySelector('.persona-display');
                    const chatArea = document.querySelector('.chat-interaction-area');
                    const summarySection = document.querySelector('.summary-section');

                    if (!centerBtn || !chatContainer || !personaDisplay || !chatArea || !summarySection) {
                        return;
                    }

                    chatArea.style.paddingTop = '70px';

                    let currentMax = null;

                    centerBtn.style.pointerEvents = 'auto';
                    centerBtn.style.cursor = 'pointer';
                    centerBtn.style.display = 'flex';

                    centerBtn.addEventListener('mouseenter', function () {
                        this.style.background = 'linear-gradient(135deg, #008a7e, #008a98)';
                        this.style.transform = 'translateY(-2px) scale(1.08)';
                        this.style.boxShadow = '0 6px 20px #008a7e, 0 0 0 1px #008a7e';
                    });

                    centerBtn.addEventListener('mouseleave', function () {
                        this.style.background = 'linear-gradient(135deg, rgba(20, 65, 90, 0.95), rgba(20, 130, 135, 0.95))';
                        this.style.transform = '';
                        this.style.boxShadow = '0 4px 15px #008a7e';
                    });

                    function resetAll() {
                        personaDisplay.style.display = '';
                        chatArea.style.display = '';
                        summarySection.style.display = '';
                        chatContainer.style.display = '';
                        chatContainer.style.opacity = '';
                        chatContainer.style.pointerEvents = '';

                        personaDisplay.style.flex = '';
                        chatArea.style.flex = '';

                        chatArea.style.paddingTop = '70px';

                        summarySection.style.position = '';
                        summarySection.style.width = '';
                        summarySection.style.height = '';
                        summarySection.style.top = '';
                        summarySection.style.left = '';
                        summarySection.style.right = '';
                        summarySection.style.bottom = '';
                        summarySection.style.zIndex = '';
                        summarySection.style.borderRadius = '';
                        summarySection.style.maxWidth = '';
                        summarySection.style.maxHeight = '';
                        summarySection.style.margin = '';
                        summarySection.style.padding = '';
                        summarySection.style.flex = '';
                        summarySection.style.minWidth = '';

                        centerBtn.style.position = 'absolute';
                        centerBtn.style.top = '20px';
                        centerBtn.style.right = '20px';
                        centerBtn.style.zIndex = '200';

                        centerBtn.querySelector('i').className = 'fas fa-expand';
                        centerBtn.title = 'Maximize';

                        currentMax = null;
                    }

                    centerBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        if (currentMax === 'center') {
                            resetAll();
                        } else {
                            resetAll();

                            personaDisplay.style.display = 'none';
                            chatArea.style.flex = '1';
                            chatArea.style.paddingTop = '40px';
                            summarySection.style.display = 'none';
                            centerBtn.querySelector('i').className = 'fas fa-compress';
                            centerBtn.title = 'Minimize';
                            currentMax = 'center';
                        }
                    });

                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape' && currentMax) {
                            resetAll();
                        }
                    });
                }, 100);
            })();

        });
    

/* === BEGIN PATCH: Conversation ownership + improved routing & agent handlers === */

// Conversation ownership lock: which agent currently owns follow-ups (e.g., after agent asked a question)
let conversationLead = null;

/**
 * selectLeadAgent(prompt)
 * Reusable capability-driven lead selector.
 */
function selectLeadAgent(prompt, candidates = ['nouf','omar','layla','hakim']) {
    const activeAgents = (typeof getSelectedAgentsInfo === 'function')
        ? getSelectedAgentsInfo().map(a => a.id)
        : (typeof selectedAgents !== 'undefined' ? selectedAgents.slice() : []);

    // Filter candidates to active ones (order preserved)
    const available = candidates.filter(id => activeAgents.includes(id));

    const p = (prompt || '').toLowerCase();

    const capabilityKeywords = {
        nouf: ['consult', 'prepare', 'preparations', 'advice', 'advise', 'strategy', 'briefing', 'risk', 'analysis', 'prepare'],
        omar: ['schedule', 'meeting', 'coordinate', 'logistic', 'arrange', 'calendar', 'task', 'coordinate'],
        layla: ['data', 'chart', 'charts', 'statistics', 'analysis', 'metrics', 'visualization', 'visual'],
        hakim: ['overview', 'summary', 'strategy', 'executive', 'brief']
    };

    const scores = {};
    for (const id of available) scores[id] = 0;

    for (const id of available) {
        const keywords = capabilityKeywords[id] || [];
        for (const kw of keywords) {
            if (p.includes(kw)) scores[id] += 10;
        }
    }

    if (Object.values(scores).every(s => s === 0)) {
        for (const id of ['nouf','omar','layla','hakim']) {
            if (available.includes(id)) {
                return { leadAgent: id, activeAgents: available };
            }
        }
    }

    let leadAgent = available[0];
    let bestScore = -1;
    for (const id of available) {
        if (scores[id] > bestScore) {
            bestScore = scores[id];
            leadAgent = id;
        }
    }

    return { leadAgent, activeAgents: available };
}

/**
 * Overridden handleSendMessage()
 * Intercepts continuation replies (yes/ok/continue) and routes them to conversationLead.
 * Replaces previous handler behavior by being declared later in the file (overrides earlier definitions).
 */
async function handleSendMessage() {
    if (!chatInput) return;
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;

    // Continuation intercept must run first
    const shortReply = userMessage.toLowerCase();
    const continuationReplies = [
        "yes","yep","sure","ok","okay","please","proceed","go ahead","continue","confirm","please do","please proceed"
    ];

    if (conversationLead && continuationReplies.includes(shortReply)) {
        // Continue with the same agent who previously asked a question
        displayMessage('user', userMessage);
        chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });
        chatInput.value = '';
        // Reset button toggle
        const controls1 = document.querySelector('.chat-input-controls');
        if (controls1) controls1.classList.remove('has-text');

        const leadAgent = conversationLead;
        const activeAgents = (typeof getSelectedAgentsInfo === 'function')
            ? getSelectedAgentsInfo().map(a => a.id)
            : (typeof selectedAgents !== 'undefined' ? selectedAgents.slice() : []);

        showTypingIndicator();

        for (const aid of activeAgents) {
            // ensure ordering; silent flag for non-lead agents
            await sendMessageToAgent(userMessage, aid, { silent: aid !== leadAgent });
        }

        return; // do not run normal routing
    }

    // Normal flow
    displayMessage('user', userMessage);
    chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });
    chatInput.value = '';
    // Reset button toggle
    const controls2 = document.querySelector('.chat-input-controls');
    if (controls2) controls2.classList.remove('has-text');

    // Reset previous lead for a fresh question
    conversationLead = null;

    if (isMultiAgentMode) {
        showTypingIndicator();
        await orchestrateMultiAgentResponse(userMessage);
    } else {
        const selectedAgent = (typeof selectedAgents !== 'undefined' && selectedAgents.length > 0)
            ? selectedAgents[0]
            : currentPersonaId;
        showTypingIndicator();
        await sendMessageToAgent(userMessage, selectedAgent, { silent: false });
    }
}

/**
 * Overridden sendMessageToAgent - modernized and safe
 * Keeps your existing API key + url pattern; adjusts options argument handling.
 */
async function sendMessageToAgent(message, agentId, options = {}) {
    const { silent = false, retries = 3, delay = 1000 } = options || {};

    // Use API key that was in the file; if you want to change it centrally, update here.
    const apiKey = "AIzaSyCRFXs-Ysnoy2swH1yjqZYoRMNC4HTpv_c";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const persona = (typeof personaData !== 'undefined') ? personaData.find(p => p.id === agentId) : null;
    const systemPromptText = persona ? persona.systemPrompt : 'You are a helpful assistant.';

    const payload = {
        contents: chatHistory,
        systemInstruction: {
            parts: [{ text: `${systemPromptText} Your user is a high-level executive ("Your Excellency"). The current date and time is ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Riyadh' })}.` }]
        },
        generationConfig: { maxOutputTokens: 8192 },
        safetySettings: [
            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }
        ]
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        removeTypingIndicator();

        if (!response.ok) {
            if ((response.status === 429 || response.status >= 500) && retries > 0) {
                await new Promise(r => setTimeout(r, delay));
                return sendMessageToAgent(message, agentId, { silent, retries: retries - 1, delay: delay * 2 });
            }
            // On non-retryable errors show a bubble unless silent
            if (!silent) {
                displayMessage('agent', `I'm experiencing connectivity issues (${response.status}).`, agentId);
            } else {
                console.warn(`Silent-mode API error for ${agentId}: ${response.status}`);
            }
            return;
        }

        const result = await response.json();
        const candidate = result.candidates?.[0];
        const agentResponseText = candidate?.content?.parts?.[0]?.text;

        if (agentResponseText) {

            // if agent asked the user a question, lock conversation lead
            if (agentResponseText.trim().endsWith("?")) {
                conversationLead = agentId;
            }

            if (!silent) {
                displayMessage('agent', agentResponseText, agentId);
            } else {
                // silent: do not display, but keep history for context
                console.log(`Agent ${agentId} returned (silent):`, agentResponseText.substring(0,120));
            }

            // push to history
            chatHistory.push({ role: 'model', parts: [{ text: agentResponseText }] });

        } else {
            // handle empty or blocked responses
            if (isMultiAgentMode && silent) {
                console.log(`Agent ${agentId} returned empty response in multi-agent silent mode - skipping`);
                return;
            }

            let errorText = "I apologize, but I couldn't process that request fully. Please try rephrasing.";
            if (candidate && candidate.finishReason && candidate.finishReason !== 'STOP') {
                errorText = `I'm sorry, my response was stopped due to: ${candidate.finishReason.toLowerCase().replace(/_/g, ' ')}.`;
            } else if (result?.promptFeedback && result.promptFeedback.blockReason) {
                errorText = `I'm sorry, your prompt could not be processed due to: ${result.promptFeedback.blockReason.toLowerCase().replace(/_/g, ' ')}.`;
            } else if (!agentResponseText) {
                console.warn("Gemini response missing text content:", result);
            }

            if (!silent) {
                displayMessage('agent', errorText, agentId);
            } else {
                console.warn(`Silent-mode: agent ${agentId} error: ${errorText}`);
            }
        }

    } catch (err) {
        console.error('Error fetching agent:', err);
        removeTypingIndicator();
        if (!silent) {
            displayMessage('agent', "I'm experiencing network difficulties connecting to my services. Please check your connection or try again shortly.", agentId);
        } else {
            console.warn(`Silent-mode network error for ${agentId}:`, err.message);
        }
    }
}

/**
 * Deterministic / capability-aware orchestrator.
 * Uses selectLeadAgent() and ONLY active agents.
 */
async function orchestrateMultiAgentResponse(userMessage) {
    const agentsInfo = (typeof getSelectedAgentsInfo === 'function') ? getSelectedAgentsInfo() : [];
    const activeIds = agentsInfo.map(a => a.id);

    if (activeIds.length === 0) {
        await sendMessageToAgent(userMessage, 'hakim', { silent: false });
        return;
    }

    const { leadAgent, activeAgents } = selectLeadAgent(userMessage, ['nouf','omar','layla','hakim']);
    const effectiveLead = leadAgent || activeAgents[0] || activeIds[0];

    // show routing note (filtered to active agents only)
    if (typeof chatMessages !== 'undefined' && chatMessages) {
        const orchestrationNote = document.createElement('div');
        orchestrationNote.className = 'agent-discussion-indicator';
        orchestrationNote.style.fontSize = '0.85rem';
        orchestrationNote.style.opacity = '0.95';
        const routed = (activeAgents && activeAgents.length) ? activeAgents : activeIds;
        const routedNames = routed.map(id => {
            const p = (typeof personaData !== 'undefined') ? personaData.find(x => x.id === id) : null;
            return p ? p.name.split(' ')[0] : id;
        });
        orchestrationNote.innerHTML = `<i class="fas fa-route"></i> Hakim routing to: ${routedNames.join(', ')}`;
        chatMessages.appendChild(orchestrationNote);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    showTypingIndicator();

    for (const aid of activeAgents) {
        const silent = (aid !== effectiveLead);
        await sendMessageToAgent(userMessage, aid, { silent });
    }

    // lock conversation to the lead for follow-ups
    conversationLead = effectiveLead;
}

/* === END PATCH === */

</script>




<!-- BEGIN: Focus Area Maximize Modal (agent-info style) -->
<div id="focus-area-maximize-modal" class="modal" aria-hidden="true" style="display:none;">
  <div class="modal-backdrop" data-close="true"></div>
  <div class="modal-content agent-info-window large-modal" role="dialog" aria-labelledby="faMaxTitle" style="max-width:1100px;">
    <button class="modal-close" data-close="true" aria-label="Close">&times;</button>
    <div class="modal-body">
      <header class="agent-info-header">
        <h2 id="faMaxTitle">Focus Area</h2>
        <p class="agent-info-subtitle">Detailed strategic view</p>
      </header>
      <div class="agent-info-grid">
        <div class="agent-info-main">
          <section class="fa-section">
            <h3 class="fa-title">Title</h3>
            <p class="fa-description">Description goes here.</p>
          </section>
          <section class="fa-section">
            <h4>Strategic KPIs</h4>
            <ul class="fa-kpis"></ul>
          </section>
          <section class="fa-section">
            <h4>Related Initiatives</h4>
            <ul class="fa-initiatives"></ul>
          </section>
          <section class="fa-section">
            <h4>Challenges</h4>
            <p class="fa-challenges"></p>
          </section>
        </div>
        <aside class="agent-info-side">
          <section class="fa-section">
            <h4>Progress Updates</h4>
            <p class="fa-progress"></p>
          </section>
          <section class="fa-section">
            <h4>Metrics</h4>
            <ul class="fa-metrics"></ul>
          </section>
          <section class="fa-section">
            <h4>Attachments</h4>
            <ul class="fa-attachments"></ul>
          </section>
          <section class="fa-section">
            <h4>Sub-Areas</h4>
            <ul class="fa-subareas"></ul>
          </section>
          <div class="modal-actions" style="margin-top:12px;">
            <button id="fa-ask-agent" class="btn">Ask Agent</button>
            <button id="fa-close" class="btn btn-secondary" data-close="true">Close</button>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>
<!-- END: Focus Area Maximize Modal -->

<script>
(function(){
    function showModal(mod){ if(typeof openModal==='function'){ try{ openModal(mod); return; }catch(e){} } mod.style.display='flex'; mod.setAttribute('aria-hidden','false'); }
    function hideModal(mod){ if(typeof closeModal==='function'){ try{ closeModal(mod); return; }catch(e){} } mod.style.display='none'; mod.setAttribute('aria-hidden','true'); }

    const buildPlaceholder = (title)=> ({
        title: title,
        description: `Summary and context for ${title}. Replace with real content.`,
        kpis: [`${title} â€” KPI 1`, `${title} â€” KPI 2`, `${title} â€” KPI 3`],
        initiatives: [`${title} â€” Initiative A`, `${title} â€” Initiative B`],
        challenges: `Key challenges related to ${title}.`,
        progress: `Current progress: initial scoping completed.`,
        metrics: [`Metric A: baseline`, `Metric B: baseline`],
        attachments: [`${title} - Overview.pdf`],
        subareas: [`Sub-area 1`, `Sub-area 2`]
    });

    function fillList(parent, selector, items){
        const el = parent.querySelector(selector);
        if(!el) return;
        el.innerHTML='';
        if(!items || !items.length) return;
        items.forEach(it=>{ const li=document.createElement('li'); li.textContent=it; el.appendChild(li); });
    }

    function openFocusMax(data){
        const modal = document.getElementById('focus-area-maximize-modal');
        if(!modal) return;
        modal.querySelector('.fa-title').textContent = data.title || '';
        modal.querySelector('.fa-description').textContent = data.description || '';
        fillList(modal, '.fa-kpis', data.kpis);
        fillList(modal, '.fa-initiatives', data.initiatives);
        modal.querySelector('.fa-challenges').textContent = data.challenges || '';
        modal.querySelector('.fa-progress').textContent = data.progress || '';
        fillList(modal, '.fa-metrics', data.metrics);
        fillList(modal, '.fa-attachments', data.attachments);
        fillList(modal, '.fa-subareas', data.subareas);

        const askBtn = modal.querySelector('#fa-ask-agent');
        if(askBtn){
            askBtn.onclick = function(){
                const prompt = `Please provide an executive summary and next steps for the focus area: "${data.title}".`;
                if(typeof switchToAgentAndSendPrompt === 'function') switchToAgentAndSendPrompt(prompt, 'nouf');
            };
        }

        showModal(modal);
    }

    document.addEventListener('click', function(e){
        const modal = document.getElementById('focus-area-maximize-modal');
        if(!modal) return;
        if(e.target.getAttribute && e.target.getAttribute('data-close')==='true') hideModal(modal);
        if(e.target.classList && e.target.classList.contains('modal-close')) hideModal(modal);
    });
    document.addEventListener('keydown', function(e){ if(e.key==='Escape'){ const modal=document.getElementById('focus-area-maximize-modal'); if(modal) hideModal(modal); } });

    // Attach click on .topic-card to open maximize modal (ignore clicks on controls)
    document.querySelectorAll('#focus-areas-page .topic-card').forEach(card=>{
        if(card.getAttribute('data-max-handler')==='1') return;
        card.setAttribute('data-max-handler','1');
        card.addEventListener('click', function(e){
            if(e.target.closest && e.target.closest('.topic-action-btn')) return;
            const titleEl = card.querySelector('.topic-title');
            const title = titleEl ? titleEl.textContent.trim() : 'Focus Area';
            const data = (window.focusAreaData && window.focusAreaData[title]) ? window.focusAreaData[title] : buildPlaceholder(title);
            openFocusMax(data);
        });
    });

})();

// --- Focus Area Expand (Maximize) ---
const focusAreaModal = document.getElementById("focusAreaModal");
const focusAreaTitle = document.getElementById("focusAreaTitle");
const focusAreaDescription = document.getElementById("focusAreaDescription");
const focusAreaKPIs = document.getElementById("focusAreaKPIs");
const focusAreaInitiatives = document.getElementById("focusAreaInitiatives");

function openFocusAreaModal() {
    focusAreaModal.style.display = "flex";
}

function closeFocusAreaModal() {
    focusAreaModal.style.display = "none";
}


const focusAreaDetails = {
    "Strengthening Labor Market": {
        kpis: [
            " - Nationalization Rate (Tawteen) Growth",
            " - Labor Market Participation Rate",
            " - Occupational Safety Compliance Index",
            " - Labor Mobility & Transition Efficiency"
        ],
        initiatives: [
            "Sector-Specific Saudization Acceleration Program",
            "National Workforce Skills Forecasting & Planning System",
            "Integrated Occupational Safety Monitoring Platform",
            "Labor Contract Digitization & Automation Initiative",
            "Private Sector Labor Compliance Incentive Scheme",
            "Labor Market Flexibility Reform Package",
            "Employment Transition Support Program (ETSP)"
        ]
    },

    "Empowering Society & Individuals": {
        kpis: [
            " - Community Empowerment Participation Index",
            " - Self-Reliance Progress Rate",
            " - Access to Social Services Coverage",
            " - Volunteerism Rate Growth",
            " - Quality of Life Impact Score"
        ],
        initiatives: [
            "Regional Community Development Enablement Program",
            "National Volunteer Engagement & Incentive Platform",
            "Self-Reliance Pathways & Support Model",
            "National Household Capability Development Scheme",
            "Youth Empowerment & Leadership Tracks",
            "Digital Inclusion for Vulnerable Groups Program",
            "Integrated Social Services Navigation Portal",
            "Community Wellbeing Baseline Assessment Project",
            "Inclusive Accessibility Enhancement Initiative"
        ]
    },

    "Enabling the Non-Profit Sector": {
        kpis: [
            " - Sector Contribution to GDP",
            " - Non-Profit Professionalization Index",
            " - Volunteer Hour Utilization Efficiency"
        ],
        initiatives: [
            "Non-Profit Governance Excellence Program",
            "Sector Digital Transformation Enablement Project",
            "Impact Measurement & Transparency Framework",
            "National Volunteer Ecosystem Optimization Initiative"
        ]
    },

    "Strategic Partnerships": {
        kpis: [
            " - Number of Active Strategic Partnerships (G2G, G2B, NPO)",
            " - Partnership Impact Realization Rate"
        ],
        initiatives: [
            "Government-to-Government Cooperation Expansion Track",
            "Private Sector Engagement Acceleration Program",
            "Non-Profit Partnership Alignment Initiative",
            "Partnership Governance & Evaluation Framework",
            "International Collaboration & Knowledge Exchange Program",
            "Strategic Partnership Pipeline & Opportunity Mapping System"
        ]
    }
};

// 1. STOP ACTION BUTTONS FROM OPENING MODAL
// -----------------------------------------
document.querySelectorAll(".topic-action-btn").forEach(btn => {
    btn.addEventListener("click", e => {
        e.stopPropagation();
    });
});

document.querySelectorAll(".topic-card").forEach(card => {
    card.addEventListener("click", () => {
        const title = card.querySelector(".topic-title")?.textContent || "";
        // const description = card.querySelector(".topic-description")?.textContent || "";
        
        const descElement = card.querySelector(".topic-description");
        const longDescription = descElement?.dataset.longDescription;
        const description = longDescription || descElement?.textContent || "";

        const kpiItems = [...card.querySelectorAll(".kpi-item")].map(kpi => ({
            value: kpi.querySelector(".kpi-value").textContent,
            label: kpi.querySelector(".kpi-label").textContent
        }));

        const actions = [...card.querySelectorAll(".topic-actions button")].map(btn =>
            btn.textContent.trim()
        );

        // PUT INTO MODAL
        focusAreaTitle.textContent = title;
        //focusAreaDescription.textContent = description;
        focusAreaDescription.innerHTML = description.replace(/\n/g, "<br>");

        const details = focusAreaDetails[title];

        if (!details) {
            console.error("âš ï¸ Missing focusAreaDetails entry for:", title);
            return;
        }
        
        // Strategic KPIs
        focusAreaKPIs.innerHTML = details.kpis.map(k =>
            `<div class="kpi-entry">${k}</div>`
        ).join("");

        // Related Initiatives
        focusAreaInitiatives.innerHTML = details.initiatives.map(i =>
            `<div class="initiative-entry">${i}</div>`
        ).join("");




        openFocusAreaModal();
    });
});

</script>
</body></html>


























